<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>disstans.tools &mdash; DISSTANS 2.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=1413ff29"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=c4a36953"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/copybutton.js?v=c8c824eb"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation &amp; Updates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#minimal-installation">Minimal installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#full-development-installation">Full development installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#updates">Updates</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/tutorial_1.html">Tutorial 1: The first synthetic station</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_1.html#building-a-model-collection">Building a Model collection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_1.html#creating-timeseries-objects">Creating Timeseries objects</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_1.html#fitting-the-models">Fitting the models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_1.html#plotting-the-fit-and-residuals">Plotting the fit and residuals</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/tutorial_2.html">Tutorial 2: Advanced Models and Fitting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_2.html#creating-more-complex-synthetic-data">Creating more complex synthetic data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_2.html#spline-models-for-transients">Spline models for transients</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_2.html#building-a-network">Building a Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_2.html#fitting-an-entire-network">Fitting an entire network</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_2.html#advanced-plotting">Advanced plotting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_2.html#repeat-with-l2-regularization">Repeat with L2 regularization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_2.html#repeat-with-l1-regularization">Repeat with L1 regularization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_2.html#repeat-with-l0-regularization">Repeat with L0 regularization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_2.html#comparing-specific-parameters">Comparing specific parameters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/tutorial_3.html">Tutorial 3: Incorporating Spatial Coherence</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_3.html#preparations">Preparations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_3.html#dreaming-up-a-network">Dreaming up a network</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_3.html#fantasizing-data">Fantasizing data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_3.html#removing-the-common-mode-error">Removing the Common Mode Error</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_3.html#fitting-the-data-using-reweighted-l1-regularization">Fitting the data using reweighted L1 regularization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_3.html#fitting-the-data-using-a-spatially-aware-l1-reweighting">Fitting the data using a spatially-aware L1 reweighting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_3.html#finding-unmodeled-jumps">Finding unmodeled jumps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_3.html#statistics-of-spatial-reweighting">Statistics of spatial reweighting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_3.html#model-parameter-correlations">Model parameter correlations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_3.html#transient-visualization-with-worm-plots">Transient visualization with worm plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_3.html#secular-velocity-comparisons">Secular velocity comparisons</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/tutorial_4.html">Tutorial 4: The use and estimation of covariance</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_4.html#making-a-noisy-network">Making a noisy network</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_4.html#fitting-the-models-with-the-spatial-l0-solver">Fitting the models with the spatial L0 solver</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_4.html#quality-of-the-fits">Quality of the fits</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_4.html#correlation-of-parameters">Correlation of parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_4.html#simple-linear-regression-with-restricted-spline-set">Simple linear regression with restricted spline set</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_4.html#empirical-covariance-estimation">Empirical covariance estimation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/tutorial_5.html">Tutorial 5: Signal Recovery at Low SNR</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_5.html#preparations">Preparations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_5.html#defining-the-variables-and-hyperparameter-space">Defining the variables and hyperparameter space</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_5.html#running-test-cases">Running test cases</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/tutorial_5.html#results">Results</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples/example_1.html">Example 1: Long Valley Caldera Transient Motions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_1.html#preparations">Preparations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../examples/example_1.html#getting-data">Getting data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/example_1.html#building-the-network">Building the network</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_1.html#cleaning-the-timeseries">Cleaning the timeseries</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../examples/example_1.html#outlier-and-cme-removal">Outlier and CME removal</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/example_1.html#first-pass-major-steps-and-noisy-periods">First pass: major steps and noisy periods</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/example_1.html#second-pass-minor-catalog-based-steps">Second pass: minor, catalog-based steps</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_1.html#model-parameter-estimation">Model parameter estimation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_1.html#modeled-horizontal-transient-motion">Modeled horizontal transient motion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_1.html#modeled-vertical-seasonal-motion">Modeled vertical seasonal motion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_1.html#comparison-of-secular-velocities">Comparison of secular velocities</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_1.html#final-considerations">Final considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_1.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/example_2.html">Example 2: Long Valley Caldera Comparisons</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_2.html#preparations">Preparations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_2.html#homogenous-translation-rotation-and-strain">Homogenous translation, rotation, and strain</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_2.html#rotation-about-an-euler-pole">Rotation about an Euler pole</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_2.html#comparison-of-different-methods">Comparison of different methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_2.html#loading-other-different-datasets">Loading other different datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_2.html#north-american-reference-frame">North American reference frame</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_2.html#estimate-euler-poles-for-datasets">Estimate Euler poles for datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_2.html#map-view-comparison-of-datasets">Map view comparison of datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_2.html#quantitative-comparison-of-datasets">Quantitative comparison of datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/example_2.html#references">References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Asked Questions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#how-do-i-know-which-penalties-to-use-in-subst">1. How do I know which penalties to use in <code class="xref py py-func docutils literal notranslate"><span class="pre">lasso_regression()</span></code> and
<code class="xref py py-class docutils literal notranslate"><span class="pre">ReweightingFunction</span></code>?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html#how-can-i-save-my-network-object-to-save-time">2. How can I save my <code class="xref py py-class docutils literal notranslate"><span class="pre">Network</span></code> object to save time?</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../disstans.html">DISSTANS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../disstans/config.html">Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/config.html#disstans.config.defaults"><code class="docutils literal notranslate"><span class="pre">config.defaults</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../disstans/earthquakes.html">Earthquakes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/earthquakes.html#disstans.earthquakes.okada_displacement"><code class="docutils literal notranslate"><span class="pre">okada_displacement()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/earthquakes.html#disstans.earthquakes.okada_prior"><code class="docutils literal notranslate"><span class="pre">okada_prior()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/earthquakes.html#disstans.earthquakes.empirical_prior"><code class="docutils literal notranslate"><span class="pre">empirical_prior()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../disstans/models.html">Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/models.html#model-parent-class">Model (Parent Class)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#disstans.models.Model"><code class="docutils literal notranslate"><span class="pre">Model</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#disstans.models.check_model_dict"><code class="docutils literal notranslate"><span class="pre">check_model_dict()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/models.html#model-collection">Model Collection</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#disstans.models.ModelCollection"><code class="docutils literal notranslate"><span class="pre">ModelCollection</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/models.html#fit-collection">Fit Collection</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#disstans.models.FitCollection"><code class="docutils literal notranslate"><span class="pre">FitCollection</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/models.html#basic-models">Basic Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#arctangent">Arctangent</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#exponential">Exponential</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#hyperbolic-tangent">Hyperbolic Tangent</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#logarithmic">Logarithmic</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#polynomial">Polynomial</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#step">Step</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#sinusoid">Sinusoid</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/models.html#spline-models">Spline Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#bspline">BSpline</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#ispline">ISpline</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#basesplineset">BaseSplineSet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#splineset">SplineSet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#decayingsplineset">DecayingSplineSet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/models.html#ampphmodulatedsinusoid">AmpPhModulatedSinusoid</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../disstans/network.html">Network</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network"><code class="docutils literal notranslate"><span class="pre">Network</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.__contains__"><code class="docutils literal notranslate"><span class="pre">Network.__contains__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.__delitem__"><code class="docutils literal notranslate"><span class="pre">Network.__delitem__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.__getitem__"><code class="docutils literal notranslate"><span class="pre">Network.__getitem__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.__iter__"><code class="docutils literal notranslate"><span class="pre">Network.__iter__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.__len__"><code class="docutils literal notranslate"><span class="pre">Network.__len__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.__setitem__"><code class="docutils literal notranslate"><span class="pre">Network.__setitem__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.__str__"><code class="docutils literal notranslate"><span class="pre">Network.__str__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.add_default_local_models"><code class="docutils literal notranslate"><span class="pre">Network.add_default_local_models()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.add_local_models"><code class="docutils literal notranslate"><span class="pre">Network.add_local_models()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.add_station"><code class="docutils literal notranslate"><span class="pre">Network.add_station()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.add_unused_local_models"><code class="docutils literal notranslate"><span class="pre">Network.add_unused_local_models()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.ampphaseplot"><code class="docutils literal notranslate"><span class="pre">Network.ampphaseplot()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.analyze_residuals"><code class="docutils literal notranslate"><span class="pre">Network.analyze_residuals()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.call_func_no_return"><code class="docutils literal notranslate"><span class="pre">Network.call_func_no_return()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.call_func_ts_return"><code class="docutils literal notranslate"><span class="pre">Network.call_func_ts_return()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.call_netwide_func"><code class="docutils literal notranslate"><span class="pre">Network.call_netwide_func()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.copy_timeseries"><code class="docutils literal notranslate"><span class="pre">Network.copy_timeseries()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.copy_uncertainties"><code class="docutils literal notranslate"><span class="pre">Network.copy_uncertainties()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.create_station"><code class="docutils literal notranslate"><span class="pre">Network.create_station()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.decompose"><code class="docutils literal notranslate"><span class="pre">Network.decompose()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.default_local_models"><code class="docutils literal notranslate"><span class="pre">Network.default_local_models</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.default_location_path"><code class="docutils literal notranslate"><span class="pre">Network.default_location_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.euler_rot_field"><code class="docutils literal notranslate"><span class="pre">Network.euler_rot_field()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.evaluate"><code class="docutils literal notranslate"><span class="pre">Network.evaluate()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.export_network_ts"><code class="docutils literal notranslate"><span class="pre">Network.export_network_ts()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.fit"><code class="docutils literal notranslate"><span class="pre">Network.fit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.fitevalres"><code class="docutils literal notranslate"><span class="pre">Network.fitevalres()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.freeze"><code class="docutils literal notranslate"><span class="pre">Network.freeze()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.from_json"><code class="docutils literal notranslate"><span class="pre">Network.from_json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.get_stations_with"><code class="docutils literal notranslate"><span class="pre">Network.get_stations_with()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.get_trend_change"><code class="docutils literal notranslate"><span class="pre">Network.get_trend_change()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.graphical_cme"><code class="docutils literal notranslate"><span class="pre">Network.graphical_cme()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.gui"><code class="docutils literal notranslate"><span class="pre">Network.gui()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.hom_velocity_field"><code class="docutils literal notranslate"><span class="pre">Network.hom_velocity_field()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.import_network_ts"><code class="docutils literal notranslate"><span class="pre">Network.import_network_ts()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.load_maintenance_dict"><code class="docutils literal notranslate"><span class="pre">Network.load_maintenance_dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.math"><code class="docutils literal notranslate"><span class="pre">Network.math()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.mean_longitude"><code class="docutils literal notranslate"><span class="pre">Network.mean_longitude</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.name"><code class="docutils literal notranslate"><span class="pre">Network.name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.num_stations"><code class="docutils literal notranslate"><span class="pre">Network.num_stations</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.plot_availability"><code class="docutils literal notranslate"><span class="pre">Network.plot_availability()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.remove_models"><code class="docutils literal notranslate"><span class="pre">Network.remove_models()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.remove_station"><code class="docutils literal notranslate"><span class="pre">Network.remove_station()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.remove_timeseries"><code class="docutils literal notranslate"><span class="pre">Network.remove_timeseries()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.spatialfit"><code class="docutils literal notranslate"><span class="pre">Network.spatialfit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.station_locations"><code class="docutils literal notranslate"><span class="pre">Network.station_locations</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.station_names"><code class="docutils literal notranslate"><span class="pre">Network.station_names</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.stations"><code class="docutils literal notranslate"><span class="pre">Network.stations</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.to_json"><code class="docutils literal notranslate"><span class="pre">Network.to_json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.unfreeze"><code class="docutils literal notranslate"><span class="pre">Network.unfreeze()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.update_default_local_models"><code class="docutils literal notranslate"><span class="pre">Network.update_default_local_models()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/network.html#disstans.network.Network.wormplot"><code class="docutils literal notranslate"><span class="pre">Network.wormplot()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../disstans/processing.html">Processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/processing.html#unwrap-dict-and-ts">unwrap_dict_and_ts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/processing.html#disstans.processing.unwrap_dict_and_ts"><code class="docutils literal notranslate"><span class="pre">unwrap_dict_and_ts()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/processing.html#functions">Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/processing.html#clean">clean</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/processing.html#decompose">decompose</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/processing.html#median">median</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/processing.html#midas">midas</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/processing.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/processing.html#stepdetector">StepDetector</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../disstans/solvers.html">Solvers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/solvers.html#solution-object">Solution Object</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/solvers.html#disstans.solvers.Solution"><code class="docutils literal notranslate"><span class="pre">Solution</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/solvers.html#solver-functions">Solver Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/solvers.html#lasso-regression">lasso_regression</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/solvers.html#linear-regression">linear_regression</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/solvers.html#ridge-regression">ridge_regression</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/solvers.html#reweighting-functions">Reweighting Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/solvers.html#reweightingfunction">ReweightingFunction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/solvers.html#inversereweighting">InverseReweighting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/solvers.html#inversesquaredreweighting">InverseSquaredReweighting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/solvers.html#logarithmicreweighting">LogarithmicReweighting</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../disstans/station.html">Station</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station"><code class="docutils literal notranslate"><span class="pre">Station</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.__contains__"><code class="docutils literal notranslate"><span class="pre">Station.__contains__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.__delitem__"><code class="docutils literal notranslate"><span class="pre">Station.__delitem__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.__getitem__"><code class="docutils literal notranslate"><span class="pre">Station.__getitem__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.__iter__"><code class="docutils literal notranslate"><span class="pre">Station.__iter__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.__setitem__"><code class="docutils literal notranslate"><span class="pre">Station.__setitem__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.__str__"><code class="docutils literal notranslate"><span class="pre">Station.__str__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.add_fit"><code class="docutils literal notranslate"><span class="pre">Station.add_fit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.add_local_model"><code class="docutils literal notranslate"><span class="pre">Station.add_local_model()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.add_local_model_dict"><code class="docutils literal notranslate"><span class="pre">Station.add_local_model_dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.add_local_model_kwargs"><code class="docutils literal notranslate"><span class="pre">Station.add_local_model_kwargs()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.add_timeseries"><code class="docutils literal notranslate"><span class="pre">Station.add_timeseries()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.analyze_residuals"><code class="docutils literal notranslate"><span class="pre">Station.analyze_residuals()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.fits"><code class="docutils literal notranslate"><span class="pre">Station.fits</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.get_arch"><code class="docutils literal notranslate"><span class="pre">Station.get_arch()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.get_trend"><code class="docutils literal notranslate"><span class="pre">Station.get_trend()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.get_trend_change"><code class="docutils literal notranslate"><span class="pre">Station.get_trend_change()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.location"><code class="docutils literal notranslate"><span class="pre">Station.location</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.models"><code class="docutils literal notranslate"><span class="pre">Station.models</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.name"><code class="docutils literal notranslate"><span class="pre">Station.name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.remove_fit"><code class="docutils literal notranslate"><span class="pre">Station.remove_fit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.remove_local_models"><code class="docutils literal notranslate"><span class="pre">Station.remove_local_models()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.remove_timeseries"><code class="docutils literal notranslate"><span class="pre">Station.remove_timeseries()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.sum_fits"><code class="docutils literal notranslate"><span class="pre">Station.sum_fits()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.timeseries"><code class="docutils literal notranslate"><span class="pre">Station.timeseries</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.ts"><code class="docutils literal notranslate"><span class="pre">Station.ts</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/station.html#disstans.station.Station.unused_models"><code class="docutils literal notranslate"><span class="pre">Station.unused_models</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../disstans/timeseries.html">Timeseries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/timeseries.html#timeseries-parent-class">Timeseries (Parent Class)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/timeseries.html#disstans.timeseries.Timeseries"><code class="docutils literal notranslate"><span class="pre">Timeseries</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/timeseries.html#specialized-classes">Specialized Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/timeseries.html#gipsytimeseries">GipsyTimeseries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/timeseries.html#gipsyxtimeseries">GipsyXTimeseries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/timeseries.html#unrtimeseries">UNRTimeseries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/timeseries.html#unrhighratetimeseries">UNRHighRateTimeseries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/timeseries.html#f5file">F5File</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/timeseries.html#f5timeseries">F5Timeseries</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../disstans/tools.html">Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/tools.html#functions">Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#best-utmzone">best_utmzone</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#block-permutation">block_permutation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#cov2corr">cov2corr</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#create-powerlaw-noise">create_powerlaw_noise</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#date2decyear">date2decyear</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#download-unr-data">download_unr_data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#estimate-euler-pole">estimate_euler_pole</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#eulerpole2rotvec">eulerpole2rotvec</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#full-cov-mat-to-columns">full_cov_mat_to_columns</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#get-cov-dims">get_cov_dims</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#make-cov-index-map">make_cov_index_map</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#get-cov-indices">get_cov_indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#get-hom-vel-strain-rot">get_hom_vel_strain_rot</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#parallelize">parallelize</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#parse-maintenance-table">parse_maintenance_table</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#parse-unr-steps">parse_unr_steps</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#r-ecef2enu">R_ecef2enu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#r-enu2ecef">R_enu2ecef</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#rotvec2eulerpole">rotvec2eulerpole</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#selectpair">selectpair</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#strain-rotation-invariants">strain_rotation_invariants</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#tvec-to-numpycol">tvec_to_numpycol</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#weighted-median">weighted_median</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../disstans/tools.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#click">Click</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#rinexdataholding">RINEXDataHolding</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../disstans/tools.html#timedelta">Timedelta</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DISSTANS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">disstans.tools</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for disstans.tools</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains helper functions and classes that are not dependent on</span>
<span class="sd">any of DISSTANS&#39;s classes.</span>

<span class="sd">For more specialized processing functions, see :mod:`~disstans.processing`.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sparse</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.collections</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">cartopy.geodesic</span> <span class="k">as</span> <span class="nn">cgeod</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">import</span> <span class="nn">cartopy.feature</span> <span class="k">as</span> <span class="nn">cfeature</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">error</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">FuncFormatter</span>
<span class="kn">from</span> <span class="nn">matplotlib.backend_bases</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">MouseButton</span>
<span class="kn">from</span> <span class="nn">cmcrameri</span> <span class="kn">import</span> <span class="n">cm</span> <span class="k">as</span> <span class="n">scm</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">circmean</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Literal</span>

<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">defaults</span>


<div class="viewcode-block" id="Timedelta">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.Timedelta">[docs]</a>
<span class="k">class</span> <span class="nc">Timedelta</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">):</span>
<div class="viewcode-block" id="Timedelta.__new__">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.Timedelta.__new__">[docs]</a>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DISSTANS Timedelta subclassed from :class:`~pandas.Timedelta` but with support</span>
<span class="sd">        for the ``&#39;Y&#39;`` year time unit, defined as always exactly 365.25 days.</span>
<span class="sd">        Other possible values are:</span>

<span class="sd">        ``W``, ``D``, ``days``, ``day``, ``hours``, ``hour``, ``hr``, ``h``,</span>
<span class="sd">        ``m``, ``minute``, ``min``, ``minutes``, ``T``,</span>
<span class="sd">        ``S``, ``seconds``, ``sec``, ``second``,</span>
<span class="sd">        ``ms``, ``milliseconds``, ``millisecond``, ``milli``, ``millis``, ``L``,</span>
<span class="sd">        ``us``, ``microseconds``, ``microsecond``, ``micro``, ``micros``, ``U``,</span>
<span class="sd">        ``ns``, ``nanoseconds``, ``nano``, ``nanos``, ``nanosecond``, ``N``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">365.25</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Click">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.Click">[docs]</a>
<span class="k">class</span> <span class="nc">Click</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that enables a GUI to distinguish between clicks (mouse press and release)</span>
<span class="sd">    and dragging event (mouse press, move, then release).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax</span>
<span class="sd">        Axis on which to look for clicks.</span>
<span class="sd">    func</span>
<span class="sd">        Function to call, with the Matplotlib clicking :class:`~matplotlib.backend_bases.Event`</span>
<span class="sd">        as its first argument.</span>
<span class="sd">    button</span>
<span class="sd">        Which mouse button to operate on, see :class:`~matplotlib.backend_bases.MouseButton`</span>
<span class="sd">        for accepted values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">ax</span><span class="p">:</span> <span class="n">mpl</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                 <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Event</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
                 <span class="n">button</span><span class="p">:</span> <span class="n">MouseButton</span> <span class="o">=</span> <span class="n">MouseButton</span><span class="o">.</span><span class="n">LEFT</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_button</span> <span class="o">=</span> <span class="n">button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_press</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_move</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;button_press_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onpress</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;button_release_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onrelease</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onmove</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_c1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c3</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_onclick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_button</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_onpress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_press</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_onmove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_press</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_move</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_onrelease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_press</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_onclick</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_press</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_move</span> <span class="o">=</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="tvec_to_numpycol">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.tvec_to_numpycol">[docs]</a>
<span class="k">def</span> <span class="nf">tvec_to_numpycol</span><span class="p">(</span><span class="n">timevector</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">,</span>
                     <span class="n">t_reference</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">time_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;D&quot;</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a Pandas timestamp series into a NumPy array of relative</span>
<span class="sd">    time to a reference time in the given time unit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    timevector</span>
<span class="sd">        :class:`~pandas.Series` of :class:`~pandas.Timestamp` or alternatively a</span>
<span class="sd">        :class:`~pandas.DatetimeIndex` of when to evaluate the model.</span>
<span class="sd">    t_reference</span>
<span class="sd">        Reference :class:`~pandas.Timestamp` or datetime-like string</span>
<span class="sd">        that can be converted to one.</span>
<span class="sd">        ``None`` chooses the first element of ``timevector``.</span>
<span class="sd">    time_unit</span>
<span class="sd">        Time unit for parameters.</span>
<span class="sd">        Refer to :class:`~disstans.tools.Timedelta` for more details.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Array of time differences.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get reference time</span>
    <span class="k">if</span> <span class="n">t_reference</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t_reference</span> <span class="o">=</span> <span class="n">timevector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_reference</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">t_reference</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t_reference</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span> \
        <span class="sa">f</span><span class="s2">&quot;&#39;t_reference&#39; must be a pandas.Timestamp object, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">t_reference</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="c1"># return Numpy array</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">timevector</span> <span class="o">-</span> <span class="n">t_reference</span><span class="p">)</span> <span class="o">/</span> <span class="n">Timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_unit</span><span class="p">))</span><span class="o">.</span><span class="n">values</span></div>



<div class="viewcode-block" id="date2decyear">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.date2decyear">[docs]</a>
<span class="k">def</span> <span class="nf">date2decyear</span><span class="p">(</span><span class="n">dates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span> <span class="o">|</span> <span class="n">datetime</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert dates (just year, month, day, each day assumed to be centered at noon)</span>
<span class="sd">    to decimal years, assuming all years have 365.25 days (JPL convention for</span>
<span class="sd">    GIPSY timeseries, also used by UNR NGL).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dates</span>
<span class="sd">        Input date(s). If a Series, needs to be a series of</span>
<span class="sd">        :class:`~pandas.Timestamp`-convertible data types.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Date(s) as sorted decimal year(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="n">tdelta</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">):</span>
        <span class="n">tdelta</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="n">tdelta</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">dates</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">dates</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">dates</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">-</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">2000</span> <span class="o">+</span> <span class="n">tdelta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">86400</span> <span class="o">/</span> <span class="mf">365.25</span><span class="p">))</span></div>



<div class="viewcode-block" id="get_cov_dims">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.get_cov_dims">[docs]</a>
<span class="k">def</span> <span class="nf">get_cov_dims</span><span class="p">(</span><span class="n">num_components</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a number of components, return the number of covariances that</span>
<span class="sd">    exist between the components.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    num_components</span>
<span class="sd">        Number of components of timeseries or model.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Number of covariances, calculated as</span>
<span class="sd">        :math:`\text{num_components}*(\text{num_components}-1))/2`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    make_cov_index_map : For an example.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_components</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_components</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">num_components</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_components</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span></div>



<div class="viewcode-block" id="make_cov_index_map">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.make_cov_index_map">[docs]</a>
<span class="k">def</span> <span class="nf">make_cov_index_map</span><span class="p">(</span><span class="n">num_components</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a number of components, create a matrix that shows the indexing</span>
<span class="sd">    of where covariance columns present in a timeseries&#39; or model&#39;s 2D dataframe</span>
<span class="sd">    will show in the covariance matrix of a single observation or parameter.</span>
<span class="sd">    Also provides the ordering in a 1D array which can be used together with</span>
<span class="sd">    :func:`~numpy.reshape` to create the varaiance-covariance matrix from the columns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    num_components</span>
<span class="sd">        Number of components of timeseries or model.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    index_map</span>
<span class="sd">        Array of shape :math:`(\text{num_components}, \text{num_components})`</span>
<span class="sd">        that is NaN everywhere except in the upper triangle, where integer numbers</span>
<span class="sd">        denote where the column of a timseries&#39; or model&#39;s 2D dataframe belong.</span>
<span class="sd">    var_cov_map</span>
<span class="sd">        Array of shape :math:`(\text{num_components}^2, )` that can be used to</span>
<span class="sd">        assemble the variance-covariance matrix from the columns given a particular</span>
<span class="sd">        timestep or parameter.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; from disstans.tools import get_cov_dims, make_cov_index_map</span>
<span class="sd">    &gt;&gt;&gt; num_observations, num_components = 5, 2</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;For {num_components} components, there should be:\n&quot;</span>
<span class="sd">    ...       f&quot;- {num_components} data columns,\n&quot;</span>
<span class="sd">    ...       f&quot;- {num_components} variance columns,\n&quot;</span>
<span class="sd">    ...       f&quot;- and {get_cov_dims(num_components)} covariance columns.&quot;)</span>
<span class="sd">    For 2 components, there should be:</span>
<span class="sd">    - 2 data columns,</span>
<span class="sd">    - 2 variance columns,</span>
<span class="sd">    - and 1 covariance columns.</span>
<span class="sd">    &gt;&gt;&gt; index_map, var_cov_map = make_cov_index_map(num_components)</span>
<span class="sd">    &gt;&gt;&gt; test_varcov = np.stack([np.ones(5), np.arange(5)*2, np.ones(5)*0.5], axis=1)</span>
<span class="sd">    &gt;&gt;&gt; test_varcov</span>
<span class="sd">    array([[1. , 0. , 0.5],</span>
<span class="sd">           [1. , 2. , 0.5],</span>
<span class="sd">           [1. , 4. , 0.5],</span>
<span class="sd">           [1. , 6. , 0.5],</span>
<span class="sd">           [1. , 8. , 0.5]])</span>

<span class="sd">    The first two columns are the variances, and the third column is the covariance</span>
<span class="sd">    column (since there is only one possible covariance).</span>
<span class="sd">    ``index_map`` will show where the covariance columns fit into, indexed from ``0``</span>
<span class="sd">    to ``get_cov_dims(num_components) - 1``. Since there is only one, the column</span>
<span class="sd">    index ``0`` will feature in the upper right corner:</span>

<span class="sd">    &gt;&gt;&gt; index_map</span>
<span class="sd">    array([[nan,  0.],</span>
<span class="sd">           [nan, nan]])</span>

<span class="sd">    If we want the full, symmetric variance-covariance matrix for the third</span>
<span class="sd">    observation, we use ``var_cov_map``:</span>

<span class="sd">    &gt;&gt;&gt; var_cov_map</span>
<span class="sd">    array([0, 2, 2, 1])</span>
<span class="sd">    &gt;&gt;&gt; test_varcov[2, var_cov_map].reshape(num_components, num_components)</span>
<span class="sd">    array([[1. , 0.5],</span>
<span class="sd">           [0.5, 4. ]])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_components</span><span class="p">,</span> <span class="n">num_components</span><span class="p">))</span>
    <span class="n">index_map</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">seq_ix</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_components</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">icol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">irow</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_components</span><span class="p">):</span>
            <span class="n">index_map</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_ix</span>
            <span class="n">seq_ix</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">var_cov_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">index_map</span> <span class="o">+</span> <span class="n">num_components</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">index_map</span> <span class="o">+</span> <span class="n">num_components</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">var_cov_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">var_cov_map</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_components</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">index_map</span><span class="p">,</span> <span class="n">var_cov_map</span></div>



<div class="viewcode-block" id="get_cov_indices">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.get_cov_indices">[docs]</a>
<span class="k">def</span> <span class="nf">get_cov_indices</span><span class="p">(</span><span class="n">icomp</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">index_map</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">num_components</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a data or variance component index, retrieve the indices in the covariance columns</span>
<span class="sd">    of a timeseries or model that are associated with that component.</span>
<span class="sd">    Exactly one of ``index_map`` or ``num_components`` must be provided as input.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    icomp</span>
<span class="sd">        Index of the component.</span>
<span class="sd">    index_map</span>
<span class="sd">        Output of :func:`~make_cov_index_map`.</span>
<span class="sd">    num_components</span>
<span class="sd">        Number of components of timeseries or model. (Function will call</span>
<span class="sd">        :func:`~make_cov_index_map` to get ``index_map``.)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        List of integer covariance column indices associated with ``icomp``.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    In a 3D dataset, the second component is associated with two covariances - between</span>
<span class="sd">    the first and the second, and the second and the third. In a timeseries or model</span>
<span class="sd">    covariance dataframe, this corresponds to the following columns:</span>

<span class="sd">    &gt;&gt;&gt; from disstans.tools import get_cov_indices</span>
<span class="sd">    &gt;&gt;&gt; get_cov_indices(1, num_components=3)</span>
<span class="sd">    [0, 2]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">index_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">num_components</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need to specify either &#39;index_map&#39; or &#39;num_components&#39;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">index_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">index_map</span> <span class="o">=</span> <span class="n">make_cov_index_map</span><span class="p">(</span><span class="n">num_components</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">icomp</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">index_map</span><span class="o">.</span><span class="n">shape</span><span class="p">)),</span> <span class="s2">&quot;Invalid &#39;index_map&#39; shape &quot;</span> \
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_map</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> for the index </span><span class="si">{</span><span class="n">icomp</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="n">from_row</span> <span class="o">=</span> <span class="n">index_map</span><span class="p">[</span><span class="n">icomp</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">from_col</span> <span class="o">=</span> <span class="n">index_map</span><span class="p">[:,</span> <span class="n">icomp</span><span class="p">]</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">from_row</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">+</span> \
              <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">from_col</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span></div>



<div class="viewcode-block" id="full_cov_mat_to_columns">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.full_cov_mat_to_columns">[docs]</a>
<span class="k">def</span> <span class="nf">full_cov_mat_to_columns</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                            <span class="n">num_components</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                            <span class="n">include_covariance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">return_single</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a full variance(-covariance) matrix with multiple components into a</span>
<span class="sd">    column-based representation like the one used by :class:`~disstans.models.Model` or</span>
<span class="sd">    :class:`~disstans.timeseries.Timeseries`. The extraction done basically implies</span>
<span class="sd">    the assumption that the cross-parameter/cross-observation covariance is negligible.</span>

<span class="sd">    It is assumed the the individual elements</span>
<span class="sd">    are ordered such that all components of one parameter or observation are in</span>
<span class="sd">    neighboring rows/columns (i.e. the first parameter or observation occupies the</span>
<span class="sd">    first ``num_components`` rows/columns, the second one the second ``num_components``</span>
<span class="sd">    rows/columns, etc.).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cov_mat</span>
<span class="sd">        Square array with dimensions :math:`\text{num_elements} * \text{num_components}`</span>
<span class="sd">        where :math:`\text{num_elements}` is the number of elements (e.g. observations</span>
<span class="sd">        or parameters) in each of the :math:`\text{num_components}` dimensions.</span>
<span class="sd">    num_components</span>
<span class="sd">        Number of components `cov_mat` contains.</span>
<span class="sd">    include_covariance</span>
<span class="sd">        If ``True``, also extract the off-diagonal covariances of each element between</span>
<span class="sd">        its components. Defaults to ``False``, i.e. only the diagonal covariances.</span>
<span class="sd">    return_single</span>
<span class="sd">        If ``False``, return two arrays; if ``True``, concatenate the two.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    variance</span>
<span class="sd">        Array of shape :math:`(\text{num_elements}, \text{num_components})`.</span>
<span class="sd">        If ``include_covariance=True`` and ``return_single=True``, this array</span>
<span class="sd">        is concatenated horizontally with ``covariance``, leading to</span>
<span class="sd">        :math:`(\text{num_elements}, (\text{num_components}*(\text{num_components}-1))/2)`</span>
<span class="sd">        columns instead.</span>
<span class="sd">    covariance</span>
<span class="sd">        If ``include_covariance=True`` and ``return_single=False``, array of shape</span>
<span class="sd">        :math:`\text{num_components}) + (\text{num_components}*(\text{num_components}-1))/2`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">cov_mat</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cov_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cov_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> \
        <span class="sa">f</span><span class="s2">&quot;&#39;cov_mat&#39; must be a 2D square matrix, got array of shape </span><span class="si">{</span><span class="n">cov_mat</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">cov_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">num_components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;cov_mat&#39; can not be divided &quot;</span> \
        <span class="sa">f</span><span class="s2">&quot;into </span><span class="si">{</span><span class="n">num_components</span><span class="si">}</span><span class="s2"> components because of incompatible dimensions.&quot;</span>
    <span class="n">num_elements</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cov_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">num_components</span><span class="p">)</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_elements</span><span class="p">,</span> <span class="n">num_components</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">casting</span><span class="o">=</span><span class="s2">&quot;safe&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">include_covariance</span><span class="p">:</span>
        <span class="n">cov_dims</span> <span class="o">=</span> <span class="n">get_cov_dims</span><span class="p">(</span><span class="n">num_components</span><span class="p">)</span>
        <span class="n">index_map</span> <span class="o">=</span> <span class="n">make_cov_index_map</span><span class="p">(</span><span class="n">num_components</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">raveled_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">index_map</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">raveled_indices</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">cov_dims</span>
        <span class="n">covariance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_elements</span><span class="p">,</span> <span class="n">cov_dims</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">iobs</span><span class="p">,</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_elements</span><span class="p">),</span>
                                <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_components</span> <span class="o">*</span> <span class="n">num_elements</span><span class="p">,</span> <span class="n">num_components</span><span class="p">)):</span>
            <span class="n">sub_mat</span> <span class="o">=</span> <span class="n">cov_mat</span><span class="p">[</span><span class="n">iblock</span><span class="p">:</span><span class="n">iblock</span> <span class="o">+</span> <span class="n">num_components</span><span class="p">,</span>
                              <span class="n">iblock</span><span class="p">:</span><span class="n">iblock</span> <span class="o">+</span> <span class="n">num_components</span><span class="p">]</span>
            <span class="n">covariance</span><span class="p">[</span><span class="n">iobs</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">sub_mat</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">raveled_indices</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">covariance</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">include_covariance</span> <span class="ow">and</span> <span class="n">return_single</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">variance</span><span class="p">,</span> <span class="n">covariance</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">variance</span><span class="p">,</span> <span class="n">covariance</span></div>



<div class="viewcode-block" id="block_permutation">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.block_permutation">[docs]</a>
<span class="k">def</span> <span class="nf">block_permutation</span><span class="p">(</span><span class="n">n_outer</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_inner</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function to calculate a permutation matrix used to rearrange (permute)</span>
<span class="sd">    blockwise-ordered submatrices in a big matrix.  ``n_outer`` outside blocks of</span>
<span class="sd">    individual ``n_inner``-sized blocks will become ``n_inner`` outside blocks of</span>
<span class="sd">    individual ``n_outer``-sized blocks.</span>

<span class="sd">    Transposing the result is equivalent to calling this function with swapped arguments.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_outer</span>
<span class="sd">        Number of sub-matrices.</span>
<span class="sd">    n_inner</span>
<span class="sd">        Size of the individual sub-matrices.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Square permutation matrix with dimensions</span>
<span class="sd">        :math:`n = \text{n_outer} * \text{n_inner}`.</span>
<span class="sd">        To permute a matrix :math:`A`, calculate :math:`~P A P^T`.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; from disstans.tools import block_permutation</span>
<span class="sd">    &gt;&gt;&gt; n_outer, n_inner = 2, 2</span>
<span class="sd">    &gt;&gt;&gt; A = np.block([[np.arange(n_inner**2).reshape(n_inner, n_inner),</span>
<span class="sd">    ...                np.zeros((n_inner, n_inner))], [np.zeros((n_inner, n_inner)),</span>
<span class="sd">    ...                np.ones((n_inner, n_inner))]])</span>
<span class="sd">    &gt;&gt;&gt; A</span>
<span class="sd">    array([[0., 1., 0., 0.],</span>
<span class="sd">           [2., 3., 0., 0.],</span>
<span class="sd">           [0., 0., 1., 1.],</span>
<span class="sd">           [0., 0., 1., 1.]])</span>
<span class="sd">    &gt;&gt;&gt; P = block_permutation(n_outer, n_inner)</span>
<span class="sd">    &gt;&gt;&gt; P @ A @ P.T</span>
<span class="sd">    array([[0., 0., 1., 0.],</span>
<span class="sd">           [0., 1., 0., 1.],</span>
<span class="sd">           [2., 0., 3., 0.],</span>
<span class="sd">           [0., 1., 0., 1.]])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">n_outer</span> <span class="o">*</span> <span class="n">n_inner</span>
    <span class="n">Pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">Prowind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">Pcolind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_outer</span><span class="p">,</span> <span class="n">n_inner</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">Pvals</span><span class="p">,</span> <span class="p">(</span><span class="n">Prowind</span><span class="p">,</span> <span class="n">Pcolind</span><span class="p">)))</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">P</span></div>



<div class="viewcode-block" id="cov2corr">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.cov2corr">[docs]</a>
<span class="k">def</span> <span class="nf">cov2corr</span><span class="p">(</span><span class="n">cov</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that converts a covariance matrix into a (Pearson) correlation</span>
<span class="sd">    matrix, taking into account zero-valued variances and setting the</span>
<span class="sd">    respective correlation entries to NaN.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cov</span>
<span class="sd">        Covariance matrix.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Correlation matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
    <span class="n">var_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="n">cov_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">var_nonzero</span><span class="p">,</span> <span class="n">var_nonzero</span><span class="p">)</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
    <span class="n">corr</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">Dinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="n">var_nonzero</span><span class="p">]))</span>
    <span class="n">corr</span><span class="p">[</span><span class="n">cov_nonzero</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dinv</span> <span class="o">@</span> <span class="n">cov</span><span class="p">[</span><span class="n">cov_nonzero</span><span class="p">]</span> <span class="o">@</span> <span class="n">Dinv</span>
    <span class="k">return</span> <span class="n">corr</span></div>



<div class="viewcode-block" id="parallelize">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.parallelize">[docs]</a>
<span class="k">def</span> <span class="nf">parallelize</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">],</span>
                <span class="n">iterable</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">,</span>
                <span class="n">num_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">chunksize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience wrapper that given a function, an iterable set of inputs</span>
<span class="sd">    and parallelization settings automatically either runs the function</span>
<span class="sd">    in serial or parallel.</span>

<span class="sd">    Warning</span>
<span class="sd">    -------</span>
<span class="sd">    By default on most systems, NumPy will already use multiple cores and threads</span>
<span class="sd">    in its routines (you can check this by running some very large and time-consuming</span>
<span class="sd">    math, and monitoring the usage of your processors). Just using multiple Python</span>
<span class="sd">    threads will give the default number of threads to all new Python threads,</span>
<span class="sd">    completely overloading the system since it&#39;s now out of processors, slowing</span>
<span class="sd">    down the computations by a lot. The Python :mod:`~multiprocessing`</span>
<span class="sd">    module does not change these settings, since it is apparently hard to guess which backend</span>
<span class="sd">    NumPy uses, see `this thread on GitHub &lt;https://github.com/numpy/numpy/issues/11826&gt;`_.</span>
<span class="sd">    So, it is sadly currently up to the user to disable this behavior when using</span>
<span class="sd">    multiple Python threads as achieved with this function. For example,</span>
<span class="sd">    this snipped might be enough to put at the beginning of a script:</span>
<span class="sd">    ``import os; os.environ[&#39;OMP_NUM_THREADS&#39;] = &#39;1&#39;``. Then, the number of DISSTANS cores</span>
<span class="sd">    can be set by e.g. ``import disstans; disstans.defaults[&quot;general&quot;][&quot;num_threads&quot;] = 10``.</span>
<span class="sd">    Another important note is that if you&#39;re experiencing problems when running a script,</span>
<span class="sd">    make sure the settings and the rest of the script are encapsulated in the standard</span>
<span class="sd">    ``if __name__ == &quot;__main__&quot;: ...`` clause.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func</span>
<span class="sd">        Function to wrap, can only have a single input argument.</span>
<span class="sd">    iterable</span>
<span class="sd">        Iterable object (list, generator expression, etc.) that contains all the</span>
<span class="sd">        arguments that ``func`` should be called with.</span>
<span class="sd">    num_threads</span>
<span class="sd">        Number of threads to use. Set to ``0`` if no parallelization is desired.</span>
<span class="sd">        ``None`` defaults to the value in :attr:`~disstans.config.defaults`.</span>
<span class="sd">    chunksize</span>
<span class="sd">        Chunk size used in the parallelization pool, see</span>
<span class="sd">        :meth:`~multiprocessing.pool.Pool.imap`.</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    result</span>
<span class="sd">        Whenever a result is calculated, return it.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    Consider a simple loop to multiply two numbers:</span>

<span class="sd">    &gt;&gt;&gt; from numpy import sum</span>
<span class="sd">    &gt;&gt;&gt; iterable = [(1, 2), (2, 3)]</span>
<span class="sd">    &gt;&gt;&gt; print([sum(i) for i in iterable])</span>
<span class="sd">    [3, 5]</span>

<span class="sd">    In parallel with 2 threads, this could look like this:</span>

<span class="sd">    &gt;&gt;&gt; from multiprocessing import Pool</span>
<span class="sd">    &gt;&gt;&gt; with Pool(2) as p:</span>
<span class="sd">    ...     print([result for result in p.imap(sum, iterable)])</span>
<span class="sd">    ...</span>
<span class="sd">    [3, 5]</span>

<span class="sd">    Using :func:`~parallelize`, both cases simplify to:</span>

<span class="sd">    &gt;&gt;&gt; from disstans.tools import parallelize</span>
<span class="sd">    &gt;&gt;&gt; print([result for result in parallelize(sum, iterable, num_threads=0)])</span>
<span class="sd">    [3, 5]</span>
<span class="sd">    &gt;&gt;&gt; print([result for result in parallelize(sum, iterable, num_threads=2)])</span>
<span class="sd">    [3, 5]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">num_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_threads</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;num_threads&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">num_threads</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">func</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_powerlaw_noise">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.create_powerlaw_noise">[docs]</a>
<span class="k">def</span> <span class="nf">create_powerlaw_noise</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">,</span>
                          <span class="n">exponent</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
                          <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates synthetic noise according to a Power Law model [langbein04]_.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    size</span>
<span class="sd">        Number of (equally-spaced) noise samples of the output noise array or</span>
<span class="sd">        a shape where the first entry defines the number of noise samples for</span>
<span class="sd">        the remaining dimensions.</span>
<span class="sd">    exponent</span>
<span class="sd">        Exponent of the power law noise model.</span>
<span class="sd">        E.g. ``0`` corresponds to white (Gaussian) noise, ``1`` to flicker (pink)</span>
<span class="sd">        noise, and ``2`` to random walk (red, Brownian) noise.</span>
<span class="sd">    seed</span>
<span class="sd">        Pass an initial seed to the random number generator, or pass</span>
<span class="sd">        a :class:`~numpy.random.Generator` instance.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Noise output array.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function uses Timmer and Knig&#39;s [timmerkoenig95]_ approach to</span>
<span class="sd">    generate the noise, and Felix Patzelt&#39;s `colorednoise`_ code to calculate</span>
<span class="sd">    the theoretical standard deviation.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    .. [langbein04] Langbein, J. (2004),</span>
<span class="sd">       *Noise in two-color electronic distance meter measurements revisited*,</span>
<span class="sd">       J. Geophys. Res., 109, B04406,</span>
<span class="sd">       doi:`10.1029/2003JB002819 &lt;https://doi.org/10.1029/2003JB002819&gt;`_.</span>
<span class="sd">    .. [timmerkoenig95] Timmer, J.; Knig, M. (1995),</span>
<span class="sd">       *On generating power law noise*,</span>
<span class="sd">       Astronomy and Astrophysics, v.300, p.707.</span>
<span class="sd">    .. _`colorednoise`: https://github.com/felixpatzelt/colorednoise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># parse desired output shape as list</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">size</span><span class="p">]),</span> \
            <span class="s2">&quot;If passing a non-integer shape, &#39;size&#39; must be a list or tuple &quot;</span> <span class="o">+</span> \
            <span class="sa">f</span><span class="s2">&quot;of integers, got </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">size</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> is not a valid size or shape.&quot;</span><span class="p">)</span>
    <span class="c1"># parse starting seed (if seed is already a generator, will be returned unaltered)</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="c1"># get the number of noise samples and the remaining dimensions</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">halfsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ndims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="c1"># step 1-2</span>
    <span class="c1"># get Fourier frequencies</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="c1"># the scaling later can&#39;t handle zero frequency, so we need to set it</span>
    <span class="c1"># to the minimum frequency possible</span>
    <span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">size</span>
    <span class="c1"># scale the frequencies</span>
    <span class="n">freqs_scaled</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">exponent</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># create an empty array and loop over the dimensions</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">size</span><span class="p">,</span> <span class="n">ndims</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">idim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">):</span>
        <span class="c1"># draw two sets of Gaussian distributed random numbers</span>
        <span class="n">real_part</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">halfsize</span><span class="p">)</span> <span class="o">*</span> <span class="n">freqs_scaled</span>
        <span class="n">imag_part</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">halfsize</span><span class="p">)</span> <span class="o">*</span> <span class="n">freqs_scaled</span>
        <span class="c1"># for real signals, there is no imaginary component at the zero frequency</span>
        <span class="n">imag_part</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># for even length signals, the last component (Nyquist frequency)</span>
        <span class="c1"># also has to be real because of symmetry properties</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">imag_part</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># combine the two parts</span>
        <span class="n">fourier_noise</span> <span class="o">=</span> <span class="n">real_part</span> <span class="o">+</span> <span class="n">imag_part</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span>
        <span class="c1"># step 3</span>
        <span class="c1"># transform from frequency to time domain</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">fourier_noise</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="c1"># additional step: normalize to unit standard deviation</span>
        <span class="c1"># estimate the standard deviation</span>
        <span class="n">freqs_sigma_est</span> <span class="o">=</span> <span class="n">freqs_scaled</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">freqs_sigma_est</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">freqs_sigma_est</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">size</span>
        <span class="c1"># normalize</span>
        <span class="n">noise</span> <span class="o">/=</span> <span class="n">sigma</span>
        <span class="c1"># put into array</span>
        <span class="n">out</span><span class="p">[:,</span> <span class="n">idim</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise</span>
    <span class="c1"># reshape output and return</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="parse_maintenance_table">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.parse_maintenance_table">[docs]</a>
<span class="k">def</span> <span class="nf">parse_maintenance_table</span><span class="p">(</span><span class="n">csvpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">sitecol</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                            <span class="n">datecols</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                            <span class="n">siteformatter</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span>
                            <span class="n">codecol</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">exclude</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">include</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that loads a maintenance table from a .csv file (or similar) and returns</span>
<span class="sd">    a list of step times for each station. It also provides an interface to ignore</span>
<span class="sd">    certain maintenance codes (if present), and modify the site names when loading.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    csvpath</span>
<span class="sd">        Path of the file to load.</span>
<span class="sd">    sitecol</span>
<span class="sd">        Column index of the station names.</span>
<span class="sd">    datecols</span>
<span class="sd">        List of indices that contain the ingredients to convert the input to a valid</span>
<span class="sd">        :class:`~pandas.Timestamp`. It should fail gracefully, i.e. return a string</span>
<span class="sd">        if Pandas cannot interpret the column(s) appropriately.</span>
<span class="sd">    siteformatter</span>
<span class="sd">        Function that will be called element-wise on the loaded station names to</span>
<span class="sd">        produce the output station names.</span>
<span class="sd">    delimiter</span>
<span class="sd">        Delimiter character for the input file.</span>
<span class="sd">    codecol</span>
<span class="sd">        Column index of the maintenance code.</span>
<span class="sd">    exclude</span>
<span class="sd">        Maintenance records that exactly match an element in ``exclude`` will be ignored.</span>
<span class="sd">        ``codecol`` has to be set.</span>
<span class="sd">    include</span>
<span class="sd">        Only maintenance records that include an element of ``include`` will be used.</span>
<span class="sd">        No exact match is required.</span>
<span class="sd">        ``codecol`` has to be set.</span>
<span class="sd">    verbose</span>
<span class="sd">        If ``True``, print loading information.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    maint_table</span>
<span class="sd">        Parsed maintenance table.</span>
<span class="sd">    maint_dict</span>
<span class="sd">        Dictionary of that maps the station names to a list of steptimes.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If running into problems, also consult the Pandas :func:`~pandas.read_csv`</span>
<span class="sd">    function (used to load the ``csvpath`` file) and :class:`~pandas.DataFrame`</span>
<span class="sd">    (object on which the filtering happens).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># load codes and tables</span>
    <span class="k">if</span> <span class="n">codecol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">codecol</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> \
            <span class="sa">f</span><span class="s2">&quot;&#39;codecol&#39; needs to be an integer, got </span><span class="si">{</span><span class="n">codecol</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ecode</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">ecode</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">])),</span> \
                <span class="sa">f</span><span class="s2">&quot;&#39;exclude&#39; needs to be a list of strings, got </span><span class="si">{</span><span class="n">exclude</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">if</span> <span class="n">include</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">icode</span> <span class="ow">in</span> <span class="n">include</span><span class="p">])),</span> \
                <span class="sa">f</span><span class="s2">&quot;&#39;include&#39; needs to be a list of strings, got </span><span class="si">{</span><span class="n">include</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="n">maint_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csvpath</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="n">sitecol</span><span class="p">,</span> <span class="n">codecol</span><span class="p">])</span>
        <span class="c1"># because we don&#39;t know the column names, we need to make sure that the site will</span>
        <span class="c1"># always be in the first column for later</span>
        <span class="k">if</span> <span class="n">codecol</span> <span class="o">&lt;</span> <span class="n">sitecol</span><span class="p">:</span>
            <span class="n">maint_table</span> <span class="o">=</span> <span class="n">maint_table</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
        <span class="c1"># save code column name for later</span>
        <span class="n">codecolname</span> <span class="o">=</span> <span class="n">maint_table</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maint_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csvpath</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="n">sitecol</span><span class="p">])</span>
    <span class="c1"># get site column name</span>
    <span class="n">sitecolname</span> <span class="o">=</span> <span class="n">maint_table</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># load and parse time</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csvpath</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">datecols</span><span class="p">,</span>
                       <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datecols</span><span class="p">)))]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datecols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">True</span>
                       <span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
    <span class="n">timecolname</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">name</span>
    <span class="c1"># connect time and data</span>
    <span class="n">maint_table</span> <span class="o">=</span> <span class="n">maint_table</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">maint_table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> maintenance entries.&quot;</span><span class="p">)</span>
    <span class="c1"># process site name column with siteformatter and make sure we&#39;re not combining stations</span>
    <span class="k">if</span> <span class="n">siteformatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">siteformatter</span><span class="p">),</span> \
            <span class="sa">f</span><span class="s2">&quot;&#39;siteformatter&#39; needs to be a callable, got </span><span class="si">{</span><span class="n">siteformatter</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="n">unique_pre</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">maint_table</span><span class="p">[</span><span class="n">sitecolname</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">maint_table</span><span class="p">[</span><span class="n">sitecolname</span><span class="p">]</span> <span class="o">=</span> <span class="n">maint_table</span><span class="p">[</span><span class="n">sitecolname</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">siteformatter</span><span class="p">)</span>
        <span class="n">unique_post</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">maint_table</span><span class="p">[</span><span class="n">sitecolname</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="k">assert</span> <span class="n">unique_pre</span> <span class="o">==</span> <span class="n">unique_post</span><span class="p">,</span> <span class="s2">&quot;While applying siteformatter, stations were merged.&quot;</span>
    <span class="c1"># now drop all columns where code is exactly one of the elements in exclude</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">codecol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">droprows</span> <span class="o">=</span> <span class="n">maint_table</span><span class="p">[</span><span class="n">codecolname</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dropping </span><span class="si">{</span><span class="n">droprows</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> rows because of exclude=</span><span class="si">{</span><span class="n">exclude</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">maint_table</span> <span class="o">=</span> <span class="n">maint_table</span><span class="p">[</span><span class="o">~</span><span class="n">droprows</span><span class="p">]</span>
    <span class="c1"># now drop all columns where the code does not contain an element of &#39;include&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">codecol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">include</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">keeprows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">maint_table</span><span class="p">[</span><span class="n">codecolname</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                           <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">include</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dropping </span><span class="si">{</span><span class="n">maint_table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">keeprows</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> rows &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;because of include=</span><span class="si">{</span><span class="n">include</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">maint_table</span> <span class="o">=</span> <span class="n">maint_table</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">keeprows</span><span class="p">,</span> <span class="p">:]</span>
    <span class="c1"># now produce a dictionary that maps sites to a list of step dates: {station: [steptimes]}</span>
    <span class="n">maint_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">maint_table</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">sitecolname</span><span class="p">)[</span><span class="n">timecolname</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
    <span class="c1"># rename columns</span>
    <span class="n">maint_table</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">sitecolname</span><span class="p">:</span> <span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="n">codecolname</span><span class="p">:</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span>
                                <span class="n">timecolname</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">maint_table</span><span class="p">,</span> <span class="n">maint_dict</span></div>



<div class="viewcode-block" id="weighted_median">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.weighted_median">[docs]</a>
<span class="k">def</span> <span class="nf">weighted_median</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                    <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                    <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">percentile</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">keepdims</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the weighted median along a given axis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    values</span>
<span class="sd">        Values to calculate the medians for.</span>
<span class="sd">    weights</span>
<span class="sd">        Weights of each value along the given ``axis``.</span>
<span class="sd">    axis</span>
<span class="sd">        Axis along which to calculate the median.</span>
<span class="sd">    percentile</span>
<span class="sd">        Changes the percentile (between 0 and 1) of which median to calculate.</span>
<span class="sd">    keepdims</span>
<span class="sd">        If ``True``, squeezes out the axis along which the median was calculated.</span>
<span class="sd">    visualize</span>
<span class="sd">        If ``True``, show a plot of the weighted median calculation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Weighted median of input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># some checks</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> \
        <span class="s2">&quot;&#39;values&#39; and &#39;weights&#39; must be NumPy arrays, got &quot;</span> <span class="o">+</span> \
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">axis</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">)),</span> \
        <span class="sa">f</span><span class="s2">&quot;Axis </span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s2"> is not a valid index for the shape of &#39;values&#39; (</span><span class="si">{</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">).&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">percentile</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">percentile</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">),</span> \
        <span class="sa">f</span><span class="s2">&quot;&#39;percentile&#39; must be between 0 and 1, got </span><span class="si">{</span><span class="n">percentile</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)),</span> <span class="s2">&quot;&#39;values&#39; must at least &quot;</span> <span class="o">+</span> \
        <span class="sa">f</span><span class="s2">&quot;contain a single non-NaN element along axis </span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s2"> for every other dimension.&quot;</span>
    <span class="c1"># broadcast the weights</span>
    <span class="n">other_axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">axis</span><span class="p">]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">other_axes</span><span class="p">)</span>
    <span class="c1"># sort the values and weights</span>
    <span class="n">sort_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">sort_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">sort_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">sort_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">sort_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">sort_weights</span> <span class="o">*=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sort_values</span><span class="p">)</span>  <span class="c1"># if there are NaNs, zero out their weights</span>
    <span class="c1"># calculate the median cutoff</span>
    <span class="n">cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">sort_weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">cutoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sort_weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="n">percentile</span>
    <span class="c1"># find the values at that cutoff</span>
    <span class="n">index_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cumsum</span> <span class="o">&gt;=</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">medians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">sort_values</span><span class="p">,</span> <span class="n">index_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="c1"># visualize</span>
    <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
        <span class="n">n_vals</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
        <span class="n">temp_values</span> <span class="o">=</span> <span class="n">sort_values</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="o">*</span><span class="n">other_axes</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_vals</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">temp_weights</span> <span class="o">=</span> <span class="n">sort_weights</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="o">*</span><span class="n">other_axes</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_vals</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">temp_cumsum</span> <span class="o">=</span> <span class="n">cumsum</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="o">*</span><span class="n">other_axes</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_vals</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">temp_cutoff</span> <span class="o">=</span> <span class="n">cutoff</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="o">*</span><span class="n">other_axes</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">temp_index</span> <span class="o">=</span> <span class="n">index_array</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="o">*</span><span class="n">other_axes</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">temp_medians</span> <span class="o">=</span> <span class="n">medians</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="o">*</span><span class="n">other_axes</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n_other_axes</span> <span class="o">=</span> <span class="n">temp_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_other_axes</span><span class="p">):</span>
            <span class="n">i_values</span> <span class="o">=</span> <span class="n">temp_values</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">i_weights</span> <span class="o">=</span> <span class="n">temp_weights</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">i_cumsum</span> <span class="o">=</span> <span class="n">temp_cumsum</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">i_cutoff</span> <span class="o">=</span> <span class="n">temp_cutoff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">i_index</span> <span class="o">=</span> <span class="n">temp_index</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">i_medians</span> <span class="o">=</span> <span class="n">temp_medians</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i_cumsum</span><span class="p">,</span> <span class="n">i_values</span><span class="p">,</span> <span class="o">-</span><span class="n">i_weights</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i_cumsum</span><span class="p">,</span> <span class="n">i_cumsum</span><span class="p">,</span> <span class="o">-</span><span class="n">i_weights</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">i_cutoff</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i_cumsum</span><span class="p">[</span><span class="n">i_index</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axis </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">i_medians</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="c1"># squeeze (if desired) and return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keepdims</span><span class="p">:</span>
        <span class="n">medians</span> <span class="o">=</span> <span class="n">medians</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">medians</span></div>



<div class="viewcode-block" id="download_unr_data">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.download_unr_data">[docs]</a>
<span class="k">def</span> <span class="nf">download_unr_data</span><span class="p">(</span><span class="n">station_list_or_bbox</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                      <span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">solution</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;final&quot;</span><span class="p">,</span> <span class="s2">&quot;rapid&quot;</span><span class="p">,</span> <span class="s2">&quot;ultra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;final&quot;</span><span class="p">,</span>
                      <span class="n">rate</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;24h&quot;</span><span class="p">,</span> <span class="s2">&quot;5min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;24h&quot;</span><span class="p">,</span>
                      <span class="n">reference</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;IGS14&quot;</span><span class="p">,</span>
                      <span class="n">min_solutions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                      <span class="n">t_min</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">t_max</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                      <span class="n">no_pbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                      <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Downloads GNSS timeseries data from the University of Nevada at Reno&#39;s</span>
<span class="sd">    `Nevada Geodetic Laboratory`_. When using this data, please cite [blewitt18]_,</span>
<span class="sd">    as well as all the original data providers (the relevant info will be</span>
<span class="sd">    downloaded as well).</span>

<span class="sd">    Files will only be downloaded if there is no matching file already present,</span>
<span class="sd">    or the remote file is newer than the local one.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    station_list_or_bbox</span>
<span class="sd">        Defines which stations to look for data and download.</span>
<span class="sd">        It can be either a list of station names (list of strings), a list of bounding</span>
<span class="sd">        box coordinates (the four floats ``[lon_min, lon_max, lat_min, lat_max]``</span>
<span class="sd">        in degrees), or a three-element list defining a circle (location in degrees</span>
<span class="sd">        and radius in kilometers ``[center_lon, center_lat, radius]``).</span>
<span class="sd">    data_dir</span>
<span class="sd">        Folder for data.</span>
<span class="sd">    solution</span>
<span class="sd">        Which timeseries solution to download. See the Notes for approximate latency times.</span>
<span class="sd">    rate</span>
<span class="sd">        Which sample rate to download. See the Notes for a table of which rates are</span>
<span class="sd">        available for each solution.</span>
<span class="sd">    reference</span>
<span class="sd">        The UNR abbreviation for the reference frame in which to download the data.</span>
<span class="sd">        Applies only for daily sample rates and final or rapid orbit solutions.</span>
<span class="sd">    min_solutions</span>
<span class="sd">        Only consider stations with at least a certain number of all-time solutions</span>
<span class="sd">        according to the station list file.</span>
<span class="sd">    t_min</span>
<span class="sd">        Only consider stations that have data on or after ``t_min``.</span>
<span class="sd">    t_max</span>
<span class="sd">        Only consider stations that have data on or before ``t_max``.</span>
<span class="sd">    verbose</span>
<span class="sd">        If ``True``, individual actions are printed.</span>
<span class="sd">    no_pbar</span>
<span class="sd">        Suppress the progress bar with ``True``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        A DataFrame, built from UNR&#39;s data holding list, subset to the stations</span>
<span class="sd">        actually selected for download.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    The following combinations of solution and sample rates are available.</span>
<span class="sd">    Note that not all stations are equipped to provide all data types.</span>
<span class="sd">    Furthermore, only the daily files will be available in a plate</span>
<span class="sd">    reference frame.</span>

<span class="sd">    +-----------------+----------+-----------+------------------+</span>
<span class="sd">    | orbit solutions | 24 hours | 5 minutes | latency          |</span>
<span class="sd">    +=================+==========+===========+==================+</span>
<span class="sd">    | final           | yes      | yes       | approx. 2 weeks  |</span>
<span class="sd">    +-----------------+----------+-----------+------------------+</span>
<span class="sd">    | rapid           | yes      | yes       | approx. 24 hours |</span>
<span class="sd">    +-----------------+----------+-----------+------------------+</span>
<span class="sd">    | ultra           | no       | yes       | approx. 2 hours  |</span>
<span class="sd">    +-----------------+----------+-----------+------------------+</span>

<span class="sd">    Warning</span>
<span class="sd">    -------</span>

<span class="sd">    It is your responsibility that different reference frames or solution types are</span>
<span class="sd">    not downloaded into the same folders, because this could lead to the overwriting</span>
<span class="sd">    of data or ambiguities as to which files represent which solutions. This is because</span>
<span class="sd">    this script does not rename files or change the folder structure that it finds</span>
<span class="sd">    on UNR&#39;s servers.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    .. _`Nevada Geodetic Laboratory`: http://geodesy.unr.edu/</span>
<span class="sd">    .. [blewitt18] Blewitt, G., Hammond, W., &amp; Kreemer, C. (2018).</span>
<span class="sd">       *Harnessing the GPS Data Explosion for Interdisciplinary Science*. Eos, 99.</span>
<span class="sd">       doi:`10.1029/2018EO104623 &lt;https://doi.org/10.1029/2018EO104623&gt;`_</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    parse_unr_steps : Function to download and parse UNR&#39;s main step file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># do some checks</span>
    <span class="k">assert</span> <span class="n">solution</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;final&quot;</span><span class="p">,</span> <span class="s2">&quot;rapid&quot;</span><span class="p">,</span> <span class="s2">&quot;ultra&quot;</span><span class="p">],</span> \
        <span class="sa">f</span><span class="s2">&quot;Please choose a valid orbit solution (got </span><span class="si">{</span><span class="n">solution</span><span class="si">}</span><span class="s2">).&quot;</span>
    <span class="k">assert</span> <span class="n">rate</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;24h&quot;</span><span class="p">,</span> <span class="s2">&quot;5min&quot;</span><span class="p">],</span> \
        <span class="sa">f</span><span class="s2">&quot;Please choose a valid sample rate (got </span><span class="si">{</span><span class="n">rate</span><span class="si">}</span><span class="s2">).&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">solution</span> <span class="o">==</span> <span class="s2">&quot;ultra&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="s2">&quot;24h&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There are no ultra-rapid daily solutions available.&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">station_list_or_bbox</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> \
        <span class="sa">f</span><span class="s2">&quot;&#39;station_list_or_bbox&#39; needs to be a list, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">station_list_or_bbox</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="c1"># make the necessary folders</span>
    <span class="n">atr_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;attributions&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Making sure &#39;</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">&#39; and &#39;</span><span class="si">{</span><span class="n">atr_dir</span><span class="si">}</span><span class="s2">&#39; exist.&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">atr_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># set master station list URL and define the function that returns the URL</span>
    <span class="c1"># (since we don&#39;t know which stations and times to actually download)</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;http://geodesy.unr.edu/gps_timeseries/&quot;</span>
    <span class="k">if</span> <span class="n">solution</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rate</span> <span class="o">==</span> <span class="s2">&quot;24h&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reference</span> <span class="o">==</span> <span class="s2">&quot;IGS14&quot;</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">get_sta_url</span><span class="p">(</span><span class="n">sta</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">base_url</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;tenv3/IGS14/</span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s2">.tenv3&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">get_sta_url</span><span class="p">(</span><span class="n">sta</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">base_url</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;tenv3/plates/</span><span class="si">{</span><span class="n">reference</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">reference</span><span class="si">}</span><span class="s2">.tenv3&quot;</span>
        <span class="k">elif</span> <span class="n">rate</span> <span class="o">==</span> <span class="s2">&quot;5min&quot;</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">get_sta_url</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">base_url</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;kenv/</span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.kenv.zip&quot;</span>
        <span class="n">station_list_url</span> <span class="o">=</span> <span class="s2">&quot;http://geodesy.unr.edu/NGLStationPages/DataHoldings.txt&quot;</span>
    <span class="k">elif</span> <span class="n">solution</span> <span class="o">==</span> <span class="s2">&quot;rapid&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rate</span> <span class="o">==</span> <span class="s2">&quot;24h&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reference</span> <span class="o">==</span> <span class="s2">&quot;IGS14&quot;</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">get_sta_url</span><span class="p">(</span><span class="n">sta</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">base_url</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;rapids/tenv3/</span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s2">.tenv3&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">get_sta_url</span><span class="p">(</span><span class="n">sta</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">base_url</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;rapids/plates/tenv3/</span><span class="si">{</span><span class="n">reference</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">reference</span><span class="si">}</span><span class="s2">.tenv3&quot;</span>
            <span class="n">station_list_url</span> <span class="o">=</span> <span class="s2">&quot;http://geodesy.unr.edu/NGLStationPages/DataHoldingsRapid24hr.txt&quot;</span>
        <span class="k">elif</span> <span class="n">rate</span> <span class="o">==</span> <span class="s2">&quot;5min&quot;</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">get_sta_url</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">base_url</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;rapids_5min/kenv/</span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.kenv.zip&quot;</span>
            <span class="n">station_list_url</span> <span class="o">=</span> <span class="s2">&quot;http://geodesy.unr.edu/NGLStationPages/DataHoldingsRapid5min.txt&quot;</span>
    <span class="k">elif</span> <span class="n">solution</span> <span class="o">==</span> <span class="s2">&quot;ultra&quot;</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">get_sta_url</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">doy</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">base_url</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;ultracombo/kenv/</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">doy</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">date</span><span class="si">}{</span><span class="n">sta</span><span class="si">}</span><span class="s2">_fix.kenv&quot;</span>
        <span class="n">station_list_url</span> <span class="o">=</span> <span class="s2">&quot;http://geodesy.unr.edu/NGLStationPages/DataHoldingsUltra5min.txt&quot;</span>
    <span class="n">station_list_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">station_list_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># download the station list and parse to a DataFrame</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading station list from </span><span class="si">{</span><span class="n">station_list_url</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">station_list_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">station_list_url</span><span class="p">,</span> <span class="n">station_list_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to download the station list from &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">station_list_url</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="n">stations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">station_list_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">)),</span>
                           <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span>
    <span class="c1"># subset according to station_list_or_bbox</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">station_list_or_bbox</span><span class="p">]):</span>
        <span class="c1"># list contains stations names</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span><span class="p">[</span><span class="n">stations</span><span class="p">[</span><span class="s2">&quot;Sta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">station_list_or_bbox</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">station_list_or_bbox</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">station_list_or_bbox</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># list is a bounding box</span>
            <span class="p">[</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">station_list_or_bbox</span>
            <span class="k">assert</span> <span class="n">lat_min</span> <span class="o">&lt;</span> <span class="n">lat_max</span><span class="p">,</span> <span class="s2">&quot;&#39;lat_min&#39; needs to be smaller than &#39;lat_max&#39;.&quot;</span>
            <span class="n">lon_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_min</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
            <span class="n">lon_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_max</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
            <span class="k">if</span> <span class="n">lon_min</span> <span class="o">&lt;</span> <span class="n">lon_max</span><span class="p">:</span>
                <span class="n">lon_subset</span> <span class="o">=</span> <span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="s2">&quot;Long(deg)&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lon_max</span><span class="p">)</span> <span class="o">&amp;</span> \
                             <span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="s2">&quot;Long(deg)&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lon_min</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">lon_min</span> <span class="o">&gt;</span> <span class="n">lon_max</span><span class="p">:</span>
                <span class="n">lon_subset</span> <span class="o">=</span> <span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="s2">&quot;Long(deg)&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lon_max</span><span class="p">)</span> <span class="o">|</span> \
                             <span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="s2">&quot;Long(deg)&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lon_min</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lon_subset</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">lat_subset</span> <span class="o">=</span> <span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="s2">&quot;Lat(deg)&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lat_max</span><span class="p">)</span> <span class="o">&amp;</span> \
                         <span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="s2">&quot;Lat(deg)&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lat_min</span><span class="p">)</span>
            <span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span><span class="p">[</span><span class="n">lat_subset</span> <span class="o">&amp;</span> <span class="n">lon_subset</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">station_list_or_bbox</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># list is a location and radius</span>
            <span class="p">[</span><span class="n">center_lon</span><span class="p">,</span> <span class="n">center_lat</span><span class="p">,</span> <span class="n">radius</span><span class="p">]</span> <span class="o">=</span> <span class="n">station_list_or_bbox</span>
            <span class="n">center_lonlat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">center_lon</span><span class="p">,</span> <span class="n">center_lat</span><span class="p">]])</span>
            <span class="n">geoid</span> <span class="o">=</span> <span class="n">cgeod</span><span class="o">.</span><span class="n">Geodesic</span><span class="p">()</span>
            <span class="n">station_lonlat</span> <span class="o">=</span> <span class="n">stations</span><span class="p">[[</span><span class="s2">&quot;Long(deg)&quot;</span><span class="p">,</span> <span class="s2">&quot;Lat(deg)&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="n">geoid</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="n">center_lonlat</span><span class="p">,</span> <span class="n">station_lonlat</span><span class="p">)</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">distances</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e3</span>
            <span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span><span class="p">[</span><span class="n">distances</span> <span class="o">&lt;=</span> <span class="n">radius</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not parse &#39;station_list_or_bbox&#39; &quot;</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">station_list_or_bbox</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not parse &#39;station_list_or_bbox&#39; &quot;</span> <span class="o">+</span>
                         <span class="nb">str</span><span class="p">(</span><span class="n">station_list_or_bbox</span><span class="p">))</span>
    <span class="c1"># subset according to data availability</span>
    <span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span><span class="p">[</span><span class="n">stations</span><span class="p">[</span><span class="s2">&quot;NumSol&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_solutions</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">t_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span><span class="p">[</span><span class="n">stations</span><span class="p">[</span><span class="s2">&quot;Dtend&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">t_min</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">t_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span><span class="p">[</span><span class="n">stations</span><span class="p">[</span><span class="s2">&quot;Dtbeg&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">t_max</span><span class="p">)]</span>
    <span class="c1"># this is now the final list of stations we&#39;re trying to download</span>
    <span class="n">stations_list</span> <span class="o">=</span> <span class="n">stations</span><span class="p">[</span><span class="s2">&quot;Sta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;List of stations to download: </span><span class="si">{</span><span class="n">stations_list</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No stations to download after applying all filters.&quot;</span><span class="p">)</span>
    <span class="c1"># prepare list of URLs to download</span>
    <span class="k">if</span> <span class="n">rate</span> <span class="o">==</span> <span class="s2">&quot;24h&quot;</span><span class="p">:</span>
        <span class="n">dict_urls</span> <span class="o">=</span> <span class="p">{</span><span class="n">sta</span><span class="p">:</span> <span class="p">[</span><span class="n">get_sta_url</span><span class="p">(</span><span class="n">sta</span><span class="p">)]</span> <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">stations_list</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No parsing of index pages necessary.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if it&#39;s a 5min sampling rate, there&#39;s multiple files per station,</span>
        <span class="c1"># and we need to parse the index webpage for all possible links</span>
        <span class="n">dict_urls</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">solution</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">solution</span> <span class="o">==</span> <span class="s2">&quot;rapid&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">solution</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span><span class="p">:</span>
                <span class="n">index_url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="s2">&quot;kenv/&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index_url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="s2">&quot;rapids_5min/kenv/&quot;</span>
            <span class="n">iter_stations_list</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">stations_list</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Parsing index pages&quot;</span><span class="p">,</span>
                                      <span class="n">ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="n">no_pbar</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">iter_stations_list</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?&lt;=&lt;a href=&quot;)&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="o">+</span> \
                          <span class="sa">r</span><span class="s1">&#39;\.(\d</span><span class="si">{4}</span><span class="s1">)\.kenv\.zip(?=&quot;&gt;)&#39;</span>
                <span class="n">extractor</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">index_url</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">index_page</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;windows-1252&quot;</span><span class="p">)</span>
                    <span class="n">avail_years</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">index_page</span><span class="p">)</span>
                <span class="n">dict_urls</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_sta_url</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">avail_years</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">solution</span> <span class="o">==</span> <span class="s2">&quot;ultra&quot;</span><span class="p">:</span>
            <span class="n">index_url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="s2">&quot;ultracombo/kenv/&quot;</span>
            <span class="n">pattern_y</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?&lt;=&lt;a href=&quot;)(\d</span><span class="si">{4}</span><span class="s1">)/(?=&quot;&gt;)&#39;</span>
            <span class="n">pattern_d</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?&lt;=&lt;a href=&quot;)(\d</span><span class="si">{3}</span><span class="s1">)/(?=&quot;&gt;)&#39;</span>
            <span class="n">pattern_f</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?&lt;=&lt;a href=&quot;)(\d</span><span class="si">{2}</span><span class="s1">\w</span><span class="si">{3}</span><span class="s1">\d</span><span class="si">{2}</span><span class="s1">)(\w</span><span class="si">{4}</span><span class="s1">)_fix\.kenv(?=&quot;&gt;)&#39;</span>
            <span class="n">extractor_y</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern_y</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            <span class="n">extractor_d</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern_d</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            <span class="n">extractor_f</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern_f</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parsing main index page... &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">index_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">index_page</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;windows-1252&quot;</span><span class="p">)</span>
                <span class="n">avail_years</span> <span class="o">=</span> <span class="n">extractor_y</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">index_page</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
            <span class="n">dict_urls</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">iter_avail_years</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">avail_years</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Parsing daily index pages&quot;</span><span class="p">,</span>
                                    <span class="n">ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="n">no_pbar</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">iter_avail_years</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">index_url</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">index_page</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;windows-1252&quot;</span><span class="p">)</span>
                    <span class="n">avail_doys</span> <span class="o">=</span> <span class="n">extractor_d</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">index_page</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">doy</span> <span class="ow">in</span> <span class="n">avail_doys</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">index_url</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">doy</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">index_page</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;windows-1252&quot;</span><span class="p">)</span>
                        <span class="n">avail_files</span> <span class="o">=</span> <span class="n">extractor_f</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">index_page</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">staurl</span> <span class="ow">in</span> <span class="n">avail_files</span><span class="p">:</span>
                        <span class="n">sta</span><span class="p">,</span> <span class="n">date</span> <span class="o">=</span> <span class="n">staurl</span>
                        <span class="k">if</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">stations_list</span><span class="p">:</span>
                            <span class="n">dict_urls</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_sta_url</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">doy</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span>
    <span class="n">num_urls</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">dict_urls</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="k">if</span> <span class="n">num_urls</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No files to download after looking on the server.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">num_urls</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">no_pbar</span><span class="p">):</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;WARNING: The current selection criteria would lead to &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;downloading </span><span class="si">{</span><span class="n">num_urls</span><span class="si">}</span><span class="s2"> files (from &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stations_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> stations).</span><span class="se">\n</span><span class="s2">Press ENTER to continue, &quot;</span>
                       <span class="s2">&quot;or anything else to abort.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">answer</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">exit</span><span class="p">()</span>
    <span class="c1"># prepare list of attribution files</span>
    <span class="n">atr_base_url</span> <span class="o">=</span> <span class="s2">&quot;http://geodesy.unr.edu/NGLStationPages/attributions/&quot;</span>
    <span class="n">pattern_atr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?&lt;=&lt;a href=&quot;)(\w</span><span class="si">{4}</span><span class="s1">\.atr\d?)(?=&quot;&gt;)&#39;</span>
    <span class="n">extractor_atr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern_atr</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parsing attributions index page... &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">atr_base_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">index_page</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;windows-1252&quot;</span><span class="p">)</span>
        <span class="n">avail_atr_files</span> <span class="o">=</span> <span class="n">extractor_atr</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">index_page</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
    <span class="n">dict_atr_urls</span> <span class="o">=</span> <span class="p">{</span><span class="n">sta</span><span class="p">:</span> <span class="p">[</span><span class="n">atr_base_url</span> <span class="o">+</span> <span class="n">atr_file</span>
                           <span class="k">for</span> <span class="n">atr_file</span> <span class="ow">in</span> <span class="n">avail_atr_files</span> <span class="k">if</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">atr_file</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">stations_list</span><span class="p">}</span>
    <span class="c1"># loop over list of URLs</span>
    <span class="n">iter_stations</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">stations_list</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Downloading station timeseries&quot;</span><span class="p">,</span>
                         <span class="n">ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="n">no_pbar</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">iter_stations</span><span class="p">:</span>
        <span class="n">staurls</span> <span class="o">=</span> <span class="n">dict_urls</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span>
        <span class="n">atrurls</span> <span class="o">=</span> <span class="n">dict_atr_urls</span><span class="p">[</span><span class="n">sta</span><span class="p">]</span>
        <span class="c1"># if we&#39;re downloading a single timeseries file, leave it in main folder</span>
        <span class="k">if</span> <span class="n">rate</span> <span class="o">==</span> <span class="s2">&quot;24h&quot;</span><span class="p">:</span>
            <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">staurls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">_download_update_file</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">staurls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="c1"># if we&#39;re potentially downloading multiple files (for high-rate timeseries), make a folder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="n">sta</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">staurl</span> <span class="ow">in</span> <span class="n">staurls</span><span class="p">:</span>
                <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">staurl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">_download_update_file</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">staurl</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="c1"># download all attribution files into single folder</span>
        <span class="k">for</span> <span class="n">atrurl</span> <span class="ow">in</span> <span class="n">atrurls</span><span class="p">:</span>
            <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">atr_dir</span><span class="p">,</span> <span class="n">atrurl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">_download_update_file</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">atrurl</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="c1"># return the DataFrame with the downloaded stations</span>
    <span class="k">return</span> <span class="n">stations</span></div>



<span class="k">def</span> <span class="nf">_download_update_file</span><span class="p">(</span><span class="n">local_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                          <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># check if local file exists and if so, get its last-modified time</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
        <span class="n">local_time</span> <span class="o">=</span> \
            <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">local_path</span><span class="p">),</span>
                                                <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span>
        <span class="n">local_time_str</span> <span class="o">=</span> <span class="n">local_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">local_time</span><span class="p">,</span> <span class="n">local_time_str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span>
    <span class="c1"># open the remote connection</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">remote</span><span class="p">:</span>
            <span class="c1"># get the remote last-modified time</span>
            <span class="n">remote_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">remote</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Last-Modified&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">local_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">remote_time</span> <span class="o">&gt;</span> <span class="n">local_time</span><span class="p">):</span>
                <span class="c1"># need to download the file, since we either don&#39;t have a local copy</span>
                <span class="c1"># or the remote one is newer than the one we have</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;NEW FILE&quot;</span> <span class="k">if</span> <span class="n">local_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;UPDATE&quot;</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">local</span><span class="p">:</span>
                    <span class="n">local</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">remote</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;SKIPPED&quot;</span>
    <span class="k">except</span> <span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download the remote file from </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="sa">f</span><span class="s2">&quot;HTTP Error </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">] &#39;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="n">remote_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span>
                       <span class="sa">f</span><span class="s2">&quot; -&gt; &#39;</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="n">local_time_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="parse_unr_steps">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.parse_unr_steps">[docs]</a>
<span class="k">def</span> <span class="nf">parse_unr_steps</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">check_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">only_stations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This functions parses the main step file from UNR and produces two step databases,</span>
<span class="sd">    one for maintenance and one for earthquake-related events.</span>
<span class="sd">    If a newer step file is found online, the local copy is updated.</span>

<span class="sd">    See :func:`~download_unr_data` for more information about UNR&#39;s dataset, as well as</span>
<span class="sd">    how to access and cite it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath</span>
<span class="sd">        Path to the step file.</span>
<span class="sd">    check_update</span>
<span class="sd">        If ``True``, check UNR&#39;s server for an updated step file.</span>
<span class="sd">    only_stations</span>
<span class="sd">        If specified, a list of station IDs. Other stations are not included in the output.</span>
<span class="sd">    verbose</span>
<span class="sd">        If ``True``, print actions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    maint_table</span>
<span class="sd">        Parsed maintenance table.</span>
<span class="sd">    maint_dict</span>
<span class="sd">        Dictionary of that maps the station names to a list of maintenance steptimes.</span>
<span class="sd">    eq_table</span>
<span class="sd">        Parsed earthquake table.</span>
<span class="sd">    eq_dict</span>
<span class="sd">        Dictionary of that maps the station names to a list of earthquake-related steptimes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check if local file exists</span>
    <span class="n">local_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="c1"># abort if no local file exists but also no update should be performed</span>
    <span class="k">assert</span> <span class="n">local_exists</span> <span class="ow">or</span> <span class="n">check_update</span><span class="p">,</span> \
        <span class="s2">&quot;The local file does not exist and no update was requested. No parsing possible.&quot;</span>
    <span class="c1"># see if we need to download a newer step file</span>
    <span class="k">if</span> <span class="n">check_update</span><span class="p">:</span>
        <span class="c1"># check local last-modified time</span>
        <span class="k">if</span> <span class="n">local_exists</span><span class="p">:</span>
            <span class="n">local_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span>
                                                             <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span>
            <span class="n">local_time_str</span> <span class="o">=</span> <span class="n">local_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_time</span><span class="p">,</span> <span class="n">local_time_str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">remote_url</span> <span class="o">=</span> <span class="s2">&quot;http://geodesy.unr.edu/NGLStationPages/steps.txt&quot;</span>
        <span class="c1"># open the remote connection</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">remote_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">remote</span><span class="p">:</span>
                <span class="c1"># get the remote last-modified time</span>
                <span class="n">remote_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">remote</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Last-Modified&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">local_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">remote_time</span> <span class="o">&gt;</span> <span class="n">local_time</span><span class="p">):</span>
                    <span class="c1"># need to download the file, since we either don&#39;t have a local copy</span>
                    <span class="c1"># or the remote one is newer than the one we have</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;NEW FILE&quot;</span> <span class="k">if</span> <span class="n">local_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;UPDATE&quot;</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">local</span><span class="p">:</span>
                        <span class="n">local</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">remote</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;SKIPPED&quot;</span>
        <span class="k">except</span> <span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download the remote file from </span><span class="si">{</span><span class="n">remote_url</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;HTTP Error </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
                               <span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">] &#39;</span><span class="si">{</span><span class="n">remote_url</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="n">remote_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span>
                           <span class="sa">f</span><span class="s2">&quot; -&gt; &#39;</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="n">local_time_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="c1"># load the file</span>
    <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;distance&quot;</span><span class="p">,</span> <span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="s2">&quot;usgsid&quot;</span><span class="p">]</span>
    <span class="c1"># (for earthquake events, the &quot;type&quot; column is actually the &quot;threshold&quot; column)</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">col_names</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">)</span>
    <span class="c1"># we now have a locale-dependent time column in the non-standard format yymmmdd</span>
    <span class="c1"># (%y%b%d in strptime language) which we need to convert in a hard-coded way, because we</span>
    <span class="c1"># shouldn&#39;t change the locale temporarily as it affects the entire system</span>
    <span class="n">unrmonthmap</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;JAN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span> <span class="s2">&quot;FEB&quot;</span><span class="p">:</span> <span class="s2">&quot;02&quot;</span><span class="p">,</span> <span class="s2">&quot;MAR&quot;</span><span class="p">:</span> <span class="s2">&quot;03&quot;</span><span class="p">,</span> <span class="s2">&quot;APR&quot;</span><span class="p">:</span> <span class="s2">&quot;04&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;MAY&quot;</span><span class="p">:</span> <span class="s2">&quot;05&quot;</span><span class="p">,</span> <span class="s2">&quot;JUN&quot;</span><span class="p">:</span> <span class="s2">&quot;06&quot;</span><span class="p">,</span> <span class="s2">&quot;JUL&quot;</span><span class="p">:</span> <span class="s2">&quot;07&quot;</span><span class="p">,</span> <span class="s2">&quot;AUG&quot;</span><span class="p">:</span> <span class="s2">&quot;08&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;SEP&quot;</span><span class="p">:</span> <span class="s2">&quot;09&quot;</span><span class="p">,</span> <span class="s2">&quot;OCT&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;NOV&quot;</span><span class="p">:</span> <span class="s2">&quot;11&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC&quot;</span><span class="p">:</span> <span class="s2">&quot;12&quot;</span><span class="p">}</span>
    <span class="n">raw</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
        <span class="n">raw</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">yymmmdd</span><span class="p">:</span>
                          <span class="n">yymmmdd</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">unrmonthmap</span><span class="p">[</span><span class="n">yymmmdd</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]]</span> <span class="o">+</span> <span class="n">yymmmdd</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]),</span>
        <span class="nb">format</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;%y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># subset to specified stations</span>
    <span class="k">if</span> <span class="n">only_stations</span><span class="p">:</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">raw</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">only_stations</span><span class="p">)]</span>
    <span class="c1"># split the DataFrame into two</span>
    <span class="n">maint_table</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">raw</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>
    <span class="n">eq_table</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">raw</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]]</span>
    <span class="n">eq_table</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;threshold&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">raw</span>  <span class="c1"># raw also contains a lot of NaNs because of extra columns we don&#39;t need to keep</span>
    <span class="c1"># print the different maintenance codes and sizes</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">unique_descs</span> <span class="o">=</span> <span class="n">maint_table</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Maintenance descriptions:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unique_descs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of Maintenance Events:&quot;</span><span class="p">,</span> <span class="n">maint_table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of Earthquake-related Events:&quot;</span><span class="p">,</span> <span class="n">eq_table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># make the dictionaries in form {station: [steptimes]}</span>
    <span class="n">maint_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">maint_table</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
    <span class="n">eq_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">eq_table</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
    <span class="c1"># return everything</span>
    <span class="k">return</span> <span class="n">maint_table</span><span class="p">,</span> <span class="n">maint_dict</span><span class="p">,</span> <span class="n">eq_table</span><span class="p">,</span> <span class="n">eq_dict</span></div>



<div class="viewcode-block" id="best_utmzone">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.best_utmzone">[docs]</a>
<span class="k">def</span> <span class="nf">best_utmzone</span><span class="p">(</span><span class="n">longitudes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a list of longitudes, find the UTM zone that is appropriate.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    longitudes</span>
<span class="sd">        Array of longitudes [].</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        UTM zone at the average input longitude.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lon_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">circmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">longitudes</span><span class="p">),</span>
                                   <span class="n">low</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    <span class="n">utmzone</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(((</span><span class="n">lon_mean</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">utmzone</span></div>



<div class="viewcode-block" id="get_hom_vel_strain_rot">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.get_hom_vel_strain_rot">[docs]</a>
<span class="k">def</span> <span class="nf">get_hom_vel_strain_rot</span><span class="p">(</span><span class="n">locations</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                           <span class="n">velocities</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                           <span class="n">covariances</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">utmzone</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">reference</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">=</span> <span class="mi">0</span>
                           <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a set of horizontal velocities on a 2D cartesian grid, estimate the</span>
<span class="sd">    best-fit displacement gradient matrix to calculate a homogenous velocity</span>
<span class="sd">    field characterized by a single translation vector, strain tensor, and</span>
<span class="sd">    rotation tensor. See [tape09]_ for an introduction.</span>

<span class="sd">    This function uses a local approximation to the spherical Earth by</span>
<span class="sd">    converting all station locations into a suitable UTM zone, and only</span>
<span class="sd">    considering the horizontal velocities.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    locations</span>
<span class="sd">        Array of shape :math:`(\text{num_stations}, 2)` containing the</span>
<span class="sd">        longitude and latitude [] of the observations (stations).</span>
<span class="sd">    velocities</span>
<span class="sd">        Array of shape :math:`(\text{num_stations}, 2)` containing the</span>
<span class="sd">        East and North velocities [m/time] of the observations</span>
<span class="sd">    covariances</span>
<span class="sd">        Array of shape :math:`(\text{num_stations}, 2)` containing the</span>
<span class="sd">        variances in the East and North velocities [m^2/time^2]. Alternatively,</span>
<span class="sd">        array of shape :math:`(\text{num_stations}, 3)` additionally</span>
<span class="sd">        containing the East-North covariance [m2/time^2].</span>
<span class="sd">    utmzome</span>
<span class="sd">        If provided, the UTM zone to use for the horizontal approximation.</span>
<span class="sd">        If ``None``, the average longitude will be calculated, and the</span>
<span class="sd">        respective UTM zone will be used.</span>
<span class="sd">    reference</span>
<span class="sd">        Reference station to be used by the calculation. This can be either a</span>
<span class="sd">        longitude-latitude [] list, or the index of the reference station in</span>
<span class="sd">        ``locations``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    v_O</span>
<span class="sd">        Velocity of the origin :math:`\mathbf{v}_O`.</span>
<span class="sd">    epsilon</span>
<span class="sd">        :math:`2 \times 2` strain tensor :math:`\mathbf{\varepsilon}`.</span>
<span class="sd">    omega</span>
<span class="sd">        :math:`2 \times 2` rotation tensor :math:`\mathbf{\omega}`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    strain_rotation_invariants : For calculation of invariants of the tensors.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    .. [tape09] Tape, C., Mus, P., Simons, M., Dong, D., &amp; Webb, F. (2009),</span>
<span class="sd">       *Multiscale estimation of GPS velocity fields*,</span>
<span class="sd">       Geophysical Journal International, 179(2), 945971,</span>
<span class="sd">       doi:`10.1111/j.1365-246X.2009.04337.x &lt;https://doi.org/10.1111/j.1365-246X.2009.04337.x&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># input checks</span>
    <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">locations</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span>
            <span class="n">locations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span> \
        <span class="s2">&quot;&#39;locations&#39; needs to be a NumPy array with two columns.&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">velocities</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">velocities</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span>
            <span class="n">velocities</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span> \
        <span class="s2">&quot;&#39;velocities&#39; needs to be a NumPy array with two columns.&quot;</span>
    <span class="k">assert</span> <span class="n">locations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">velocities</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
        <span class="sa">f</span><span class="s2">&quot;Mismatch between locations shape </span><span class="si">{</span><span class="n">locations</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and velocities &quot;</span> \
        <span class="sa">f</span><span class="s2">&quot;shape </span><span class="si">{</span><span class="n">velocities</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="n">num_stations</span> <span class="o">=</span> <span class="n">locations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">covariances</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">covariances</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">covariances</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span>
                <span class="n">covariances</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">num_stations</span> <span class="ow">and</span>
                <span class="n">covariances</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> \
            <span class="s2">&quot;Invalid covariance input type or shape.&quot;</span>
    <span class="c1"># parse reference</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">reference</span> <span class="o">&lt;</span> <span class="n">num_stations</span><span class="p">,</span> \
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reference</span><span class="si">}</span><span class="s2"> is not an integer index less than </span><span class="si">{</span><span class="n">num_stations</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="n">lon0</span><span class="p">,</span> <span class="n">lat0</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="n">reference</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">lon0</span><span class="p">,</span> <span class="n">lat0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">reference</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">reference</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid input for &#39;reference&#39;: </span><span class="si">{</span><span class="n">reference</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="c1"># make sure we&#39;re not inverting if we don&#39;t have enough data points</span>
    <span class="k">if</span> <span class="n">num_stations</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num_stations</span><span class="si">}</span><span class="s2"> stations are less stations than &quot;</span>
                         <span class="s2">&quot;necessary (6) for a stable computation.&quot;</span><span class="p">)</span>
    <span class="c1"># determine UTM zone if needed</span>
    <span class="k">if</span> <span class="n">utmzone</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">utmzone</span> <span class="o">=</span> <span class="n">best_utmzone</span><span class="p">(</span><span class="n">locations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="c1"># convert to UTM eastings &amp; northings</span>
    <span class="n">crs_lla</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">()</span>
    <span class="n">crs_utm</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">UTM</span><span class="p">(</span><span class="n">zone</span><span class="o">=</span><span class="n">utmzone</span><span class="p">)</span>
    <span class="n">ENU</span> <span class="o">=</span> <span class="n">crs_utm</span><span class="o">.</span><span class="n">transform_points</span><span class="p">(</span><span class="n">crs_lla</span><span class="p">,</span> <span class="n">locations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">locations</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">ENU</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ENU</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="c1"># get all positions relative to reference station</span>
    <span class="n">EO</span><span class="p">,</span> <span class="n">NO</span> <span class="o">=</span> <span class="n">crs_utm</span><span class="o">.</span><span class="n">transform_point</span><span class="p">(</span><span class="n">lon0</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">crs_lla</span><span class="p">)</span>
    <span class="n">dEO</span><span class="p">,</span> <span class="n">dNO</span> <span class="o">=</span> <span class="n">E</span> <span class="o">-</span> <span class="n">EO</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">NO</span>
    <span class="c1"># build individual G</span>
    <span class="n">GE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">dEO</span><span class="p">,</span> <span class="n">dNO</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_stations</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_stations</span><span class="p">),</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dEO</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_stations</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">GN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_stations</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_stations</span><span class="p">),</span> <span class="n">dEO</span><span class="p">,</span> <span class="n">dNO</span><span class="p">,</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_stations</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dNO</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># combine components</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">GE</span><span class="p">,</span> <span class="n">GN</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">velocities</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">velocities</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># build weight matrix</span>
    <span class="k">if</span> <span class="n">covariances</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">covariances</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">covariances</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">covariances</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]))</span>
        <span class="k">elif</span> <span class="n">covariances</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">Wblocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinvh</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">covariances</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_stations</span><span class="p">)]</span>
            <span class="n">main_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">Wblocks</span><span class="p">],</span>
                                        <span class="p">[</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">Wblocks</span><span class="p">]])</span>
            <span class="n">off_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">Wblocks</span><span class="p">])</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="n">diagonals</span><span class="o">=</span><span class="p">[</span><span class="n">main_diag</span><span class="p">,</span> <span class="n">off_diag</span><span class="p">,</span> <span class="n">off_diag</span><span class="p">],</span>
                             <span class="n">offsets</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">num_stations</span><span class="p">,</span> <span class="n">num_stations</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csr&#39;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">W</span> <span class="o">@</span> <span class="n">d</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">W</span> <span class="o">@</span> <span class="n">G</span>
    <span class="c1"># solve</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># extract wanted quantities</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">]]])</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># strain rate</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span> <span class="o">-</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># rotation rate</span>
    <span class="n">v_O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>  <span class="c1"># velocity of origin</span>
    <span class="k">return</span> <span class="n">v_O</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">omega</span></div>



<div class="viewcode-block" id="strain_rotation_invariants">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.strain_rotation_invariants">[docs]</a>
<span class="k">def</span> <span class="nf">strain_rotation_invariants</span><span class="p">(</span><span class="n">epsilon</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">omega</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
                               <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a strain (rate) and/or rotation (rate) tensor, calculate scalar</span>
<span class="sd">    invariant quantities of interest. See [tape09]_ for an introduction.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    epsilon</span>
<span class="sd">        Strain (rate) tensor :math:`\mathbf{\varepsilon}`.</span>
<span class="sd">    omega</span>
<span class="sd">        Rotation (rate) tensor :math:`\mathbf{\omega}`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dilatation</span>
<span class="sd">        Only if ``epsilon`` is provided. Scalar dilatation (rate) as defined</span>
<span class="sd">        by the first invariant of the strain (rate) tensor</span>
<span class="sd">        :math:`\Theta = \text{Tr} \left( \mathbf{\varepsilon} \right)`.</span>
<span class="sd">    strain</span>
<span class="sd">        Only if ``epsilon`` is provided. Scalar strain (rate) as defined</span>
<span class="sd">        by the Frobenius norm of the strain (rate) tensor</span>
<span class="sd">        :math:`\Sigma = \lVert \mathbf{\varepsilon} \rVert_F`</span>
<span class="sd">    shear</span>
<span class="sd">        Only if ``epsilon`` is provided. Scalar shearing (rate) as defined</span>
<span class="sd">        by the square root of the second invariant of the deviatoric strain (rate) tensor</span>
<span class="sd">        :math:`\text{T} = \sqrt{\frac{1}{2} \text{Tr}(\mathbf{\varepsilon}^2)</span>
<span class="sd">        - \frac{1}{6} \text{Tr}(\mathbf{\varepsilon})^2}`.</span>
<span class="sd">    rotation</span>
<span class="sd">        Only if ``omega`` is provided. Scalar rotation (rate) as defined</span>
<span class="sd">        by :math:`\Omega = \frac{1}{\sqrt{2}} \lVert \mathbf{\omega} \rVert_F`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">epsilon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">epsilon</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span> \
            <span class="sa">f</span><span class="s2">&quot;&#39;epsilon&#39; needs to be a 2D NumPy array, got </span><span class="si">{</span><span class="n">epsilon</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="c1"># scalar dilatation (rate)</span>
        <span class="n">dilatation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="c1"># scalar strain (rate)</span>
        <span class="n">strain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">epsilon</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="s2">&quot;fro&quot;</span><span class="p">)</span>
        <span class="c1"># scalar shearing (rate)</span>
        <span class="n">shear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">epsilon</span> <span class="o">@</span> <span class="n">epsilon</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">omega</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">omega</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span> \
            <span class="sa">f</span><span class="s2">&quot;&#39;omega&#39; needs to be a 2D NumPy array, got </span><span class="si">{</span><span class="n">omega</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="c1"># scalar rotation (rate)</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="s2">&quot;fro&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># return quantities</span>
    <span class="k">if</span> <span class="n">epsilon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">omega</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dilatation</span><span class="p">,</span> <span class="n">strain</span><span class="p">,</span> <span class="n">shear</span><span class="p">,</span> <span class="n">rotation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dilatation</span><span class="p">,</span> <span class="n">strain</span><span class="p">,</span> <span class="n">shear</span>
    <span class="k">elif</span> <span class="n">omega</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rotation</span></div>



<div class="viewcode-block" id="estimate_euler_pole">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.estimate_euler_pole">[docs]</a>
<span class="k">def</span> <span class="nf">estimate_euler_pole</span><span class="p">(</span><span class="n">locations</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                        <span class="n">velocities</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                        <span class="n">covariances</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">enu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate a best-fit Euler pole assuming all velocities lie on the same</span>
<span class="sd">    rigid plate on a sphere. The calculations are based on [goudarzi14]_.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    locations</span>
<span class="sd">        Array of shape :math:`(\text{num_stations}, \text{num_components})`</span>
<span class="sd">        containing the locations of each station (observation), where</span>
<span class="sd">        :math:`\text{num_components}=2` if the locations are given by longitudes and</span>
<span class="sd">        latitudes [] (``enu=True``) or :math:`\text{num_components}=3`</span>
<span class="sd">        if the locations are given in the cartesian Earth-Centered, Earth-Fixed</span>
<span class="sd">        (ECEF) reference frame [m] (``enu=False``).</span>
<span class="sd">    velocities</span>
<span class="sd">        Array of shape :math:`(\text{num_stations}, \text{num_components})`</span>
<span class="sd">        containing the velocities [m/time] at different stations (observations), where</span>
<span class="sd">        :math:`\text{num_components}=2` if the velocities are given in the</span>
<span class="sd">        East-North local geodetic reference frame (``enu=True``) or</span>
<span class="sd">        :math:`\text{num_components}=3` if the velocities are given in the cartesian</span>
<span class="sd">        Earth-Centered, Earth-Fixed (ECEF) reference frame (``enu=False``).</span>
<span class="sd">    covariances</span>
<span class="sd">        Array containing the (co)variances of the velocities [m^2/time^2], allowing for</span>
<span class="sd">        different input shapes depending on what uncertainties are available.</span>
<span class="sd">        If ``None``, all observations are weighted equally.</span>
<span class="sd">        If ``enu=True``, the array should have shape :math:`(\text{num_stations}, 2)`</span>
<span class="sd">        if only variances are present, :math:`(\text{num_stations}, 3)` if also</span>
<span class="sd">        the covariances are present but are given as a column, or</span>
<span class="sd">        :math:`(\text{num_stations}, 2, 2)` if the :math:`2 \times 2`covariance</span>
<span class="sd">        matrix is given for each observation.</span>
<span class="sd">        If ``enu=False``, the arrays should be of shapes</span>
<span class="sd">        :math:`(\text{num_stations}, 3)`, :math:`(\text{num_stations}, 6)`,</span>
<span class="sd">        or :math:`(\text{num_stations}, 3, 3)`, respectively.</span>
<span class="sd">    enu</span>
<span class="sd">        See ``locations`` and ``velocities``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rotation_vector</span>
<span class="sd">        Rotation vector [rad/time] containing the diagonals of the :math:`3 \times 3`</span>
<span class="sd">        rotation matrix specifying the Euler pole in cartesian, ECEF coordinates.</span>
<span class="sd">    rotation_covariance</span>
<span class="sd">        Formal :math:`3 \times 3` covariance matrix [rad^2/time^2] of the rotation vector.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    The ENU solution assumes a spherical Earth with radius 6378137 meters.</span>

<span class="sd">    If the covariances are given in columns, the formatting of</span>
<span class="sd">    :class:`~disstans.timeseries.Timeseries` is being used.</span>

<span class="sd">    Contrary to [goudarzi14]_, the estimated covariance matrix is not scaled by the a</span>
<span class="sd">    posteriori sigma, to match the covariance definition throughout the rest of DISSTANS.</span>
<span class="sd">    The time unit is also not assumed to be in years, and then scaled to millions</span>
<span class="sd">    of years.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    rotvec2eulerpole : Convert the rotation vector into an Euler pole and magnitude.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    .. [goudarzi14] Goudarzi, M. A., Cocard, M., &amp; Santerre, R. (2014),</span>
<span class="sd">       *EPC: Matlab software to estimate Euler pole parameters*,</span>
<span class="sd">       GPS Solutions, 18(1), 153162,</span>
<span class="sd">       doi:`10.1007/s10291-013-0354-4 &lt;https://doi.org/10.1007/s10291-013-0354-4&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># input checks</span>
    <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">locations</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span>
            <span class="n">locations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">enu</span> <span class="k">else</span> <span class="mi">3</span><span class="p">),</span> \
        <span class="s2">&quot;&#39;locations&#39; needs to be a NumPy Array with either 2 or 3 columns.&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">velocities</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">velocities</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span>
            <span class="n">velocities</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">enu</span> <span class="k">else</span> <span class="mi">3</span><span class="p">),</span> \
        <span class="s2">&quot;&#39;velocities&#39; needs to be a NumPy Array with either 2 or 3 columns.&quot;</span>
    <span class="k">assert</span> <span class="n">locations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">velocities</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Shape mismatch between &quot;</span> \
        <span class="sa">f</span><span class="s2">&quot;locations </span><span class="si">{</span><span class="n">locations</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and velocities </span><span class="si">{</span><span class="n">velocities</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="n">num_stations</span><span class="p">,</span> <span class="n">num_components</span> <span class="o">=</span> <span class="n">velocities</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">covariances</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">covariances</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> \
            <span class="s2">&quot;If specified, &#39;covariances&#39; needs to be a NumPy array.&quot;</span>
        <span class="k">if</span> <span class="n">enu</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">covariances</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">num_stations</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">use_covs</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">covariances</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">num_stations</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">covariances</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">num_stations</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
                <span class="n">use_covs</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;covariances&#39; is not a compatible shape &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;for ENU: </span><span class="si">{</span><span class="n">covariances</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">covariances</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">num_stations</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">use_covs</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">covariances</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">num_stations</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">covariances</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">num_stations</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
                <span class="n">use_covs</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;covariances&#39; is not a compatible shape &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;for ECEF: </span><span class="si">{</span><span class="n">covariances</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="c1"># stack velocities</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">velocities</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># build mapping matrix</span>
    <span class="k">if</span> <span class="n">enu</span><span class="p">:</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">locations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">locations</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="c1"># stacking of eq. 11 (note difference row ordering to match input format)</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_stations</span><span class="p">)],</span>
                     <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_stations</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6378137</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">locations</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">locations</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="c1"># stacking of eq. 2</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_stations</span><span class="p">),</span> <span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="n">y</span><span class="p">,</span>
                      <span class="o">-</span><span class="n">z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_stations</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span>
                      <span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_stations</span><span class="p">)],</span>
                     <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">num_stations</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># add uncertainties</span>
    <span class="k">if</span> <span class="n">covariances</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_covs</span><span class="p">:</span>
            <span class="c1"># only diagonals</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">covariances</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">covariances</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># off-diagonals included, in column notation</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">var_cov_map</span> <span class="o">=</span> <span class="n">make_cov_index_map</span><span class="p">(</span><span class="n">num_components</span><span class="p">)</span>
                <span class="n">Wblocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinvh</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">covariances</span><span class="p">[</span><span class="n">iobs</span><span class="p">,</span> <span class="n">var_cov_map</span><span class="p">],</span>
                                                      <span class="p">(</span><span class="n">num_components</span><span class="p">,</span> <span class="n">num_components</span><span class="p">)))</span>
                           <span class="k">for</span> <span class="n">iobs</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_stations</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">covariances</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># off-diagonals included, in third dimension</span>
                <span class="n">Wblocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinvh</span><span class="p">(</span><span class="n">covariances</span><span class="p">[</span><span class="n">iobs</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                           <span class="k">for</span> <span class="n">iobs</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_stations</span><span class="p">)]</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">block_diag</span><span class="p">(</span><span class="n">Wblocks</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csr&#39;</span><span class="p">)</span>
            <span class="n">W</span><span class="o">.</span><span class="n">eliminate_zeros</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">W</span> <span class="o">@</span> <span class="n">d</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">W</span> <span class="o">@</span> <span class="n">G</span>
    <span class="c1"># solve</span>
    <span class="n">rotation_vector</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="c1"># calculate formal covariance</span>
    <span class="n">rotation_covariance</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinvh</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">G</span> <span class="k">if</span> <span class="n">covariances</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">G</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rotation_vector</span><span class="p">,</span> <span class="n">rotation_covariance</span></div>



<div class="viewcode-block" id="rotvec2eulerpole">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.rotvec2eulerpole">[docs]</a>
<span class="k">def</span> <span class="nf">rotvec2eulerpole</span><span class="p">(</span><span class="n">rotation_vector</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">rotation_covariance</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a rotation vector containing the diagonals of a :math:`3 \times 3`</span>
<span class="sd">    rotation matrix (and optionally, its formal covariance) into an Euler</span>
<span class="sd">    Pole and associated magnitude. Based on [goudarzi14]_.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rotation_vector</span>
<span class="sd">        Rotation vector [rad/time] containing the diagonals of the :math:`3 \times 3`</span>
<span class="sd">        rotation matrix specifying the Euler pole in cartesian, ECEF coordinates.</span>
<span class="sd">    rotation_covariance</span>
<span class="sd">        Formal :math:`3 \times 3` covariance matrix [rad^2/time^2] of the rotation vector.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    euler_pole</span>
<span class="sd">        NumPy Array containing the longitude [rad], latitude [rad], and rotation</span>
<span class="sd">        rate [rad/time] of the Euler pole.</span>
<span class="sd">    euler_pole_covariance</span>
<span class="sd">        If ``rotation_covariance`` was given, a NumPy Array of the propagated uncertainty</span>
<span class="sd">        for the Euler Pole for all three components.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    eulerpole2rotvec : Inverse function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># readability</span>
    <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_z</span> <span class="o">=</span> <span class="n">rotation_vector</span>
    <span class="n">_xy_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rotation_vector</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rotation_vector</span><span class="p">)</span>
    <span class="c1"># Euler pole, eq. 15</span>
    <span class="n">euler_pole</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">_y</span> <span class="o">/</span> <span class="n">_x</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">_z</span> <span class="o">/</span> <span class="n">_xy_mag</span><span class="p">),</span>
                           <span class="n">_mag</span><span class="p">])</span>
    <span class="c1"># uncertainty, eq. 18</span>
    <span class="k">if</span> <span class="n">rotation_covariance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="n">_y</span> <span class="o">/</span> <span class="n">_xy_mag</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">_x</span> <span class="o">/</span> <span class="n">_xy_mag</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="n">_x</span> <span class="o">*</span> <span class="n">_z</span> <span class="o">/</span> <span class="p">(</span><span class="n">_xy_mag</span> <span class="o">*</span> <span class="n">_mag</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                         <span class="o">-</span><span class="n">_y</span> <span class="o">*</span> <span class="n">_z</span> <span class="o">/</span> <span class="p">(</span><span class="n">_xy_mag</span> <span class="o">*</span> <span class="n">_mag</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                         <span class="o">-</span><span class="n">_xy_mag</span> <span class="o">/</span> <span class="n">_mag</span><span class="o">**</span><span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="n">_x</span> <span class="o">/</span> <span class="n">_mag</span><span class="p">,</span> <span class="n">_y</span> <span class="o">/</span> <span class="n">_mag</span><span class="p">,</span> <span class="n">_z</span> <span class="o">/</span> <span class="n">_mag</span><span class="p">]])</span>
        <span class="n">euler_pole_covariance</span> <span class="o">=</span> <span class="n">jac</span> <span class="o">@</span> <span class="n">rotation_covariance</span> <span class="o">@</span> <span class="n">jac</span><span class="o">.</span><span class="n">T</span>
    <span class="c1"># return</span>
    <span class="k">if</span> <span class="n">rotation_covariance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">euler_pole</span><span class="p">,</span> <span class="n">euler_pole_covariance</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">euler_pole</span></div>



<div class="viewcode-block" id="eulerpole2rotvec">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.eulerpole2rotvec">[docs]</a>
<span class="k">def</span> <span class="nf">eulerpole2rotvec</span><span class="p">(</span><span class="n">euler_pole</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">euler_pole_covariance</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an Euler pole (and optionally, its formal covariance) into a rotation</span>
<span class="sd">    vector and associated covariance matrix. Based on [goudarzi14]_.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    euler_pole</span>
<span class="sd">        NumPy Array containing the longitude [rad], latitude [rad], and rotation</span>
<span class="sd">        rate [rad/time] of the Euler pole.</span>
<span class="sd">    euler_pole_covariance</span>
<span class="sd">        If ``rotation_covariance`` was given, the propagated uncertainty for the Euler</span>
<span class="sd">        Pole for all three components.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rotation_vector</span>
<span class="sd">        Rotation vector [rad/time] containing the diagonals of the :math:`3 \times 3`</span>
<span class="sd">        rotation matrix specifying the Euler pole in cartesian, ECEF coordinates.</span>
<span class="sd">    rotation_covariance</span>
<span class="sd">        If ``euler_pole_covariance`` was given, formal :math:`3 \times 3` covariance</span>
<span class="sd">        matrix [rad^2/time^2] of the rotation vector.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    rotvec2eulerpole : Inverse function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># readability</span>
    <span class="n"></span> <span class="o">=</span> <span class="n">euler_pole</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">sinlat</span><span class="p">,</span> <span class="n">coslat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">euler_pole</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">euler_pole</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">sinlon</span><span class="p">,</span> <span class="n">coslon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">euler_pole</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">euler_pole</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># rotation vector, eq. 5 (no scaling)</span>
    <span class="n">_x</span> <span class="o">=</span> <span class="n"></span> <span class="o">*</span> <span class="n">coslat</span> <span class="o">*</span> <span class="n">coslon</span>
    <span class="n">_y</span> <span class="o">=</span> <span class="n"></span> <span class="o">*</span> <span class="n">coslat</span> <span class="o">*</span> <span class="n">sinlon</span>
    <span class="n">_z</span> <span class="o">=</span> <span class="n"></span> <span class="o">*</span> <span class="n">sinlat</span>
    <span class="n">rotation_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_z</span><span class="p">])</span>
    <span class="c1"># uncertainty, eq. 6 (no scaling)</span>
    <span class="k">if</span> <span class="n">euler_pole_covariance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="n"></span> <span class="o">*</span> <span class="n">coslat</span> <span class="o">*</span> <span class="n">sinlon</span><span class="p">,</span> <span class="o">-</span><span class="n"></span> <span class="o">*</span> <span class="n">sinlat</span> <span class="o">*</span> <span class="n">coslon</span><span class="p">,</span> <span class="n">coslat</span> <span class="o">*</span> <span class="n">coslon</span><span class="p">],</span>
                        <span class="p">[</span><span class="n"></span> <span class="o">*</span> <span class="n">coslat</span> <span class="o">*</span> <span class="n">coslon</span><span class="p">,</span> <span class="o">-</span><span class="n"></span> <span class="o">*</span> <span class="n">sinlat</span> <span class="o">*</span> <span class="n">sinlon</span><span class="p">,</span> <span class="n">coslat</span> <span class="o">*</span> <span class="n">sinlon</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n"></span> <span class="o">*</span> <span class="n">coslat</span><span class="p">,</span> <span class="n">sinlat</span><span class="p">]])</span>
        <span class="n">rotation_covariance</span> <span class="o">=</span> <span class="n">jac</span> <span class="o">@</span> <span class="n">euler_pole_covariance</span> <span class="o">@</span> <span class="n">jac</span><span class="o">.</span><span class="n">T</span>
    <span class="c1"># return</span>
    <span class="k">if</span> <span class="n">euler_pole_covariance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rotation_vector</span><span class="p">,</span> <span class="n">rotation_covariance</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rotation_vector</span></div>



<div class="viewcode-block" id="R_ecef2enu">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.R_ecef2enu">[docs]</a>
<span class="k">def</span> <span class="nf">R_ecef2enu</span><span class="p">(</span><span class="n">lon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lat</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the rotation matrix used to express a vector written in ECEF (XYZ)</span>
<span class="sd">    coordinates as a vector written in local east, north, up (ENU) coordinates</span>
<span class="sd">    at the position defined by geodetic latitude and longitude. See Chapter 4</span>
<span class="sd">    and Appendix 4.A in [misraenge2010]_ for details.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lon</span>
<span class="sd">        Longitude [] of vector position.</span>
<span class="sd">    lat</span>
<span class="sd">        Latitude [] of vector position.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The 3-by-3 rotation matrix.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    R_enu2ecef : The inverse matrix.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    .. [misraenge2010] Misra, P., &amp; Enge, P. (2010),</span>
<span class="sd">       *Global Positioning System: Signals, Measurements, and Performance*,</span>
<span class="sd">       Lincoln, Mass: Ganga-Jamuna Press.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lon</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input longitude &amp; latitude are not convertible to scalars &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;(got </span><span class="si">{</span><span class="n">lon</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">lat</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)],</span>
                     <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)]])</span></div>



<div class="viewcode-block" id="R_enu2ecef">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.R_enu2ecef">[docs]</a>
<span class="k">def</span> <span class="nf">R_enu2ecef</span><span class="p">(</span><span class="n">lon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lat</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the rotation matrix used to express a vector written in local ENU</span>
<span class="sd">    coordinates as a vector written ECEF (XYZ) coordinates at the position defined</span>
<span class="sd">    by geodetic latitude and longitude. This is the transpose of the rotation matrix</span>
<span class="sd">    computed by :func:`~disstans.tools.R_ecef2enu`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lon</span>
<span class="sd">        Longitude [] of vector position.</span>
<span class="sd">    lat</span>
<span class="sd">        Latitude [] of vector position.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The 3-by-3 rotation matrix.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    R_ecef2enu : The inverse matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">R_ecef2enu</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></div>



<span class="c1"># This function is taken from midas.f, downloaded from</span>
<span class="c1"># http://geodesy.unr.edu/MIDAS_release.tar on 2021-09-13,</span>
<span class="c1"># converted to Python, slightly modified, and without maxn or returned n.</span>
<span class="c1">#</span>
<span class="c1"># License of the original file:</span>
<span class="c1">#</span>
<span class="c1"># Author: Geoff Blewitt.  Copyright (C) 2015.</span>
<span class="c1">#</span>
<span class="c1"># Original function description:</span>
<span class="c1">#</span>
<span class="c1"># Given a time tag array t(m), select pairs ip(2,n)</span>
<span class="c1"># Moves forward in time: for each time tag, pair it with only</span>
<span class="c1"># one future time tag.</span>
<span class="c1"># First attempt to form a pair within tolerance tol of 1 year.</span>
<span class="c1"># If this fails, then find next unused partner.</span>
<span class="c1"># If this fails, cycle through all possible future partners again.</span>
<span class="c1"># MIDAS calls this twice -- firstly forward in time, and</span>
<span class="c1"># secondly backward in time with negative tags and data.</span>
<span class="c1"># This ensures a time symmetric solution.</span>
<span class="c1"># 2010-10-12: now allow for apriori list of step epochs</span>
<span class="c1"># - do not select pairs that span or include the step epoch</span>
<div class="viewcode-block" id="selectpair">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.selectpair">[docs]</a>
<span class="k">def</span> <span class="nf">selectpair</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tstep</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Key function to calculate the MIDAS velocity estimates,</span>
<span class="sd">    described in detail in [blewitt16]_. It selects pairs of timestamps for a</span>
<span class="sd">    one-year period (within a specified tolerance, and not crossing the specified</span>
<span class="sd">    step times), but relaxes that assumption if no match can be found.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    t</span>
<span class="sd">        Array of timestamps [decimal years].</span>
<span class="sd">    tstep</span>
<span class="sd">        Array of step epochs [decimal years] (with an additional, but required</span>
<span class="sd">        unused element necessarily added at the end).</span>
<span class="sd">    tol</span>
<span class="sd">        Tolerance [days] specifying how exactly the one-year period should be matched</span>
<span class="sd">        when searching for pairs.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Array of shape :math:`(2, n)`, where the columns contain the</span>
<span class="sd">        1-indexed indices [-] of the pairs to use in the MIDAS calculation.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :func:`~disstans.processing.midas` : The entire MIDAS routine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># determine input shapes</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span>
    <span class="n">nstep</span> <span class="o">=</span> <span class="n">tstep</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="c1"># initialize loop</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ip0</span><span class="p">,</span> <span class="n">ip1</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">istep</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tol</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="c1"># scroll through steps until next step time is later than epoch 1</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">istep</span> <span class="o">&lt;=</span> <span class="n">nstep</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tstep</span><span class="p">[</span><span class="n">istep</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tol</span><span class="p">):</span>
            <span class="n">istep</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">istep</span> <span class="o">&lt;=</span> <span class="n">nstep</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tstep</span><span class="p">[</span><span class="n">istep</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tol</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">j</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">istep</span> <span class="o">&lt;=</span> <span class="n">nstep</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tstep</span><span class="p">[</span><span class="n">istep</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tol</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="c1"># time difference from 1 year</span>
            <span class="n">fdt</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">-</span> <span class="mf">1.0</span>
            <span class="c1"># keep searching IF pair less than one year</span>
            <span class="k">if</span> <span class="n">fdt</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">tol</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># try to find a matching pair within tolerance of 1 year</span>
            <span class="k">if</span> <span class="n">fdt</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="n">i2</span> <span class="o">=</span> <span class="n">j</span>
            <span class="c1"># otherwise, if greater than 1 year, cycle through remaining data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i2</span> <span class="o">=</span> <span class="n">k</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">i2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">istep</span> <span class="o">&lt;=</span> <span class="n">nstep</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tstep</span><span class="p">[</span><span class="n">istep</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tol</span><span class="p">):</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># data pair has been found</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">ip0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">ip1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i2</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="c1"># stack and return</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ip0</span><span class="p">,</span> <span class="n">ip1</span><span class="p">])</span></div>



<div class="viewcode-block" id="RINEXDataHolding">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding">[docs]</a>
<span class="k">class</span> <span class="nc">RINEXDataHolding</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container class for a database of RINEX files.</span>

<span class="sd">    A new object can be created by one of the two classmethods:</span>

<span class="sd">    * From one or multiple folder(s) using :meth:`~from_folders`</span>
<span class="sd">    * From a previously-saved file using :meth:`~from_file`</span>

<span class="sd">    An object can be saved by using Pandas&#39; :meth:`~pandas.DataFrame.to_pickle`</span>
<span class="sd">    on the instance&#39;s :attr:`~df` attribute (it is recommended to add the ``.gz``</span>
<span class="sd">    extension to enable compression).</span>

<span class="sd">    The location information and availability metrics can be saved in the</span>
<span class="sd">    same way. To load a previously-saved file, you can use the convenience functions</span>
<span class="sd">    :meth:`~load_locations_from_file` and :meth:`~load_metrics_from_file`, specify</span>
<span class="sd">    the respective paths in the call to :meth:`~from_file`, or alternatively, load</span>
<span class="sd">    the data directly with Pandas and assign it to the respective instance attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">GLOBPATTERN</span> <span class="o">=</span> <span class="s2">&quot;[0-9][0-9][0-9][0-9]/[0-9][0-9][0-9]/*&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; The ``YYYY/DDD`` folder pattern in a glob-readable format. &quot;&quot;&quot;</span>

    <span class="n">RINEXPATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;site&gt;\w</span><span class="si">{4}</span><span class="s2">)(?P&lt;day&gt;\d</span><span class="si">{3}</span><span class="s2">)(?P&lt;sequence&gt;\w</span><span class="si">{1}</span><span class="s2">)\.&quot;</span> <span class="o">+</span> \
                   <span class="sa">r</span><span class="s2">&quot;(?P&lt;yy&gt;\d</span><span class="si">{2}</span><span class="s2">)(?P&lt;type&gt;\w</span><span class="si">{1}</span><span class="s2">)\.(?P&lt;compression&gt;\w+)&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; The regex-style filename pattern for RINEX files. &quot;&quot;&quot;</span>

    <span class="n">COMPRFILEEXTS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;.Z&quot;</span><span class="p">,</span> <span class="s2">&quot;.gz&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; The valid (compressed) RINEX file extensions to search for. &quot;&quot;&quot;</span>

    <span class="n">COLUMNS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;station_raw&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;sequence&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span>
               <span class="s2">&quot;compression&quot;</span><span class="p">,</span> <span class="s2">&quot;filesize&quot;</span><span class="p">,</span> <span class="s2">&quot;filetimeutc&quot;</span><span class="p">,</span> <span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="s2">&quot;basefolder&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; The necessary information about each RINEX file. &quot;&quot;&quot;</span>

    <span class="n">METRICCOLS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;recency&quot;</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;reliability&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; The metrics that can be calculated. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_locations_xyz</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_locations_lla</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Number of files in the database. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">list_stations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; List of stations in the database. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_stations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Number of stations in the database. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_stations</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Pandas DataFrame object containing the RINEX files database. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;RINEX files database has not been loaded yet.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>

    <span class="nd">@df</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">col</span> <span class="ow">in</span> <span class="n">new_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLUMNS</span><span class="p">]),</span> \
                <span class="s2">&quot;Input DataFrame does not contain the necessary columns, try using the &quot;</span> <span class="o">+</span> \
                <span class="s2">&quot;class constructor methods.&quot;</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot interpret input as a Pandas DataFrame for the RINEX &quot;</span>
                            <span class="s2">&quot;file database.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">new_df</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">locations_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dataframe of approximate positions of stations in WGS-84 (x, y, z) [m] coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locations_xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Locations have not been loaded yet.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locations_xyz</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_stations</span><span class="p">]):</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Locations have likely not been updated since the database changed, &quot;</span>
                 <span class="s2">&quot;there are stations missing.&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locations_xyz</span>

    <span class="nd">@locations_xyz</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">locations_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_xyz</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">new_xyz</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">all</span><span class="p">([</span><span class="n">col</span> <span class="ow">in</span> <span class="n">new_xyz</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]])):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized input format. &#39;new_xyz&#39; needs to be a &quot;</span>
                             <span class="s2">&quot;Pandas DataFrame with the columns [&#39;station&#39;, &#39;x&#39;, &#39;y&#39;, &#39;z&#39;].&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">station</span> <span class="ow">in</span> <span class="n">new_xyz</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_stations</span><span class="p">]):</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The new location DataFrame does not contain all stations &quot;</span>
                 <span class="s2">&quot;that are currently in the database.&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">all_xyz</span> <span class="o">=</span> <span class="n">new_xyz</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">all_lla</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">()</span><span class="o">.</span><span class="n">transform_points</span><span class="p">(</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geocentric</span><span class="p">(),</span> <span class="n">all_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                                                   <span class="n">all_xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">all_xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">new_lla</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new_xyz</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span>
                               <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_lla</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;alt&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_locations_xyz</span> <span class="o">=</span> <span class="n">new_xyz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_locations_lla</span> <span class="o">=</span> <span class="n">new_lla</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">locations_lla</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Approximate positions of stations in WGS-84 (longitude [], latitude [],</span>
<span class="sd">        altitude [m]) coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locations_lla</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Locations have not been loaded yet.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locations_lla</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_stations</span><span class="p">]):</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Locations have likely not been updated since the database changed, &quot;</span>
                 <span class="s2">&quot;there are stations missing.&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locations_lla</span>

    <span class="nd">@locations_lla</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">locations_lla</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_lla</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">new_lla</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">all</span><span class="p">([</span><span class="n">col</span> <span class="ow">in</span> <span class="n">new_lla</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;alt&quot;</span><span class="p">]])):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized input format. &#39;new_lla&#39; needs to be a &quot;</span>
                             <span class="s2">&quot;Pandas DataFrame with the columns &quot;</span>
                             <span class="s2">&quot;[&#39;station&#39;, &#39;lon&#39;, &#39;lat&#39;, &#39;alt&#39;].&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">station</span> <span class="ow">in</span> <span class="n">new_lla</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_stations</span><span class="p">]):</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The new location DataFrame does not contain all stations &quot;</span>
                 <span class="s2">&quot;that are currently in the database.&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">all_lla</span> <span class="o">=</span> <span class="n">new_lla</span><span class="p">[[</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;alt&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">all_xyz</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Geocentric</span><span class="p">()</span><span class="o">.</span><span class="n">transform_points</span><span class="p">(</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span> <span class="n">all_lla</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                                                     <span class="n">all_lla</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">all_lla</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">new_xyz</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new_lla</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span>
                               <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_xyz</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_locations_xyz</span> <span class="o">=</span> <span class="n">new_xyz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_locations_lla</span> <span class="o">=</span> <span class="n">new_lla</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Contains the station metric calculated by :meth:`calculate_availability_metrics`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Metrics have not been calculated yet.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_stations</span><span class="p">]):</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Metrics have likely not been updated since the database changed, &quot;</span>
                 <span class="s2">&quot;there are stations missing.&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span>

    <span class="nd">@metrics</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">col</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">METRICCOLS</span><span class="p">]),</span> \
            <span class="s2">&quot;Not all metrics are in the new DataFrame.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span> <span class="o">=</span> <span class="n">metrics</span>

<div class="viewcode-block" id="RINEXDataHolding.from_folders">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding.from_folders">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_folders</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                     <span class="n">folders</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span>
                     <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="n">no_pbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RINEXDataHolding</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience class method that creates a new RINEXDataHolding object and directly</span>
<span class="sd">        calls :meth:`~load_db_from_folders`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        folders</span>
<span class="sd">            Folder(s) in which the different year-folders are found, formatted as a</span>
<span class="sd">            single tuple or a list of tuples with name and respective folder</span>
<span class="sd">            (``[(&#39;network1&#39;, &#39;/folder/one/&#39;), ...]``).</span>
<span class="sd">        verbose</span>
<span class="sd">            If ``True``, print final database size and a sample entry.</span>
<span class="sd">        no_pbar</span>
<span class="sd">            Suppress the progress bar with ``True``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            The newly created RINEXDataHolding object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">load_db_from_folders</span><span class="p">(</span><span class="n">folders</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">no_pbar</span><span class="o">=</span><span class="n">no_pbar</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span></div>


<div class="viewcode-block" id="RINEXDataHolding.load_db_from_folders">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding.load_db_from_folders">[docs]</a>
    <span class="k">def</span> <span class="nf">load_db_from_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">folders</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span>
                             <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="n">no_pbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                             <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads a RINEX database from folders in the file system.</span>
<span class="sd">        The data should be located in one or multiple folder structure(s) organized by</span>
<span class="sd">        ``YYYY/DDD``, where ``YYYY`` is a four-digit year and ``DDD`` is the three-digit</span>
<span class="sd">        day of the year.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        folders</span>
<span class="sd">            Folder(s) in which the different year-folders are found, formatted as a</span>
<span class="sd">            single tuple or a list of tuples with name and respective folder</span>
<span class="sd">            (``[(&#39;network1&#39;, &#39;/folder/one/&#39;), ...]``).</span>
<span class="sd">        verbose</span>
<span class="sd">            If ``True``, print final database size and a sample entry.</span>
<span class="sd">        no_pbar</span>
<span class="sd">            Suppress the progress bar with ``True``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># input checks</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">folders</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">folders</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">folders</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">tup</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">])</span> <span class="ow">and</span>
                <span class="nb">all</span><span class="p">([</span><span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">tup</span><span class="p">])</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">])):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;folder&#39; argument, pass a list of tuples &quot;</span>
                             <span class="s2">&quot;composed of a name and folder string each, &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">folders</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="c1"># empty starting values</span>
        <span class="n">dfdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLUMNS</span><span class="p">}</span>
        <span class="c1"># determine iterator based on verbosity</span>
        <span class="n">iterfolders</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">folders</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Loading folders&quot;</span><span class="p">,</span> <span class="n">ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;folder&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="n">no_pbar</span><span class="p">)</span>
        <span class="c1"># loop over folder(s)</span>
        <span class="k">for</span> <span class="n">network</span><span class="p">,</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">iterfolders</span><span class="p">:</span>
            <span class="c1"># initialize pattern extraction</span>
            <span class="n">rinex_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RINEXPATTERN</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            <span class="n">cur_year</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># loop over files</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading from folder </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2"> the year(s):&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pathobj</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GLOBPATTERN</span><span class="p">):</span>
                <span class="n">year</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">pathobj</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
                <span class="c1"># get clean year and day in case the globpattern changed</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">GLOBPATTERN</span> <span class="o">!=</span> <span class="n">RINEXDataHolding</span><span class="o">.</span><span class="n">GLOBPATTERN</span><span class="p">:</span>
                    <span class="n">year</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">year</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">year</span> <span class="o">=</span> <span class="s2">&quot;20&quot;</span> <span class="o">+</span> <span class="n">year</span>
                            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsing </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">pathobj</span><span class="p">)</span><span class="si">}</span><span class="s2"> assumes a two-digit year is &quot;</span>
                                 <span class="s2">&quot;post-2000.&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">pathobj</span><span class="p">)</span><span class="si">}</span><span class="s2"> doesn&#39;t have a recognizable year, &quot;</span>
                                 <span class="s2">&quot;skipping file.&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">continue</span>
                    <span class="n">day</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">day</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">day</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">367</span><span class="p">):</span>
                        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">pathobj</span><span class="p">)</span><span class="si">}</span><span class="s2"> doesn&#39;t have a valid day, &quot;</span>
                             <span class="s2">&quot;skipping file.&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="c1"># only continue if this is a valid file extension</span>
                <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COMPRFILEEXTS</span><span class="p">):</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">rinex_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">pathobj</span><span class="p">)</span><span class="si">}</span><span class="s2"> can&#39;t match RINEX filename pattern, &quot;</span>
                             <span class="s2">&quot;skipping file.&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;yy&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">year</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="ow">or</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">day</span><span class="p">):</span>
                        <span class="n">skipmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">pathobj</span><span class="p">)</span><span class="si">}</span><span class="s2"> has conflicting year/day information, &quot;</span> \
                                  <span class="s2">&quot;skipping file &quot;</span>
                        <span class="n">trystem</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}{</span><span class="n">day</span><span class="si">}{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="si">}{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">tryfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">pathobj</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trystem</span> <span class="o">+</span> <span class="n">pathobj</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tryfile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                            <span class="n">skipmsg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;(but </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">tryfile</span><span class="p">)</span><span class="si">}</span><span class="s2"> exists).&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">skipmsg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;(and </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">tryfile</span><span class="p">)</span><span class="si">}</span><span class="s2"> also doesn&#39;t exist).&quot;</span>
                        <span class="n">warn</span><span class="p">(</span><span class="n">skipmsg</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cur_year</span> <span class="o">!=</span> <span class="n">year</span><span class="p">):</span>
                        <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">cur_year</span> <span class="o">=</span> <span class="n">year</span>
                    <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">day</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y %j&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                    <span class="n">filestat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">pathobj</span><span class="p">)</span>
                    <span class="n">filesize</span> <span class="o">=</span> <span class="n">filestat</span><span class="o">.</span><span class="n">st_size</span>
                    <span class="n">filetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">filestat</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                    <span class="n">dfdict</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                    <span class="n">dfdict</span><span class="p">[</span><span class="s2">&quot;station_raw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">])</span>
                    <span class="n">dfdict</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
                    <span class="n">dfdict</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>
                    <span class="n">dfdict</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
                    <span class="n">dfdict</span><span class="p">[</span><span class="s2">&quot;sequence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;sequence&quot;</span><span class="p">])</span>
                    <span class="n">dfdict</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
                    <span class="n">dfdict</span><span class="p">[</span><span class="s2">&quot;compression&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;compression&quot;</span><span class="p">])</span>
                    <span class="n">dfdict</span><span class="p">[</span><span class="s2">&quot;filesize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filesize</span><span class="p">)</span>
                    <span class="n">dfdict</span><span class="p">[</span><span class="s2">&quot;filetimeutc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filetime</span><span class="p">)</span>
                    <span class="n">dfdict</span><span class="p">[</span><span class="s2">&quot;network&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
                    <span class="n">dfdict</span><span class="p">[</span><span class="s2">&quot;basefolder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="c1"># build DataFrame and save some space</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dfdict</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;network&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">CategoricalDtype</span><span class="p">(),</span> <span class="s2">&quot;basefolder&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">CategoricalDtype</span><span class="p">()})</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> files.</span><span class="se">\n</span><span class="s2">Sample:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="c1"># save to attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span></div>


<div class="viewcode-block" id="RINEXDataHolding.from_file">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding.from_file">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                  <span class="n">db_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">locations_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">metrics_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RINEXDataHolding</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience class method that creates a new RINEXDataHolding object from a file</span>
<span class="sd">        using :meth:`~load_db_from_file` and then optionally loads the locations and metrics</span>
<span class="sd">        from their respective files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db_file</span>
<span class="sd">            Path of the main file.</span>
<span class="sd">        locations_file</span>
<span class="sd">            Path of the locations file.</span>
<span class="sd">        metrics_file</span>
<span class="sd">            Path of the metrics file.</span>
<span class="sd">        verbose</span>
<span class="sd">            If ``True``, print database size and a sample entry.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            The newly created RINEXDataHolding object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># load instance from file</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">load_db_from_file</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="c1"># optionally load locations and metrics</span>
        <span class="k">if</span> <span class="n">locations_file</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">load_locations_from_file</span><span class="p">(</span><span class="n">locations_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metrics_file</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">load_metrics_from_file</span><span class="p">(</span><span class="n">metrics_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span></div>


<div class="viewcode-block" id="RINEXDataHolding.load_db_from_file">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding.load_db_from_file">[docs]</a>
    <span class="k">def</span> <span class="nf">load_db_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads a RINEXDataHolding object from a pickled Pandas DataFrame file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db_file</span>
<span class="sd">            Path of the main file.</span>
<span class="sd">        verbose</span>
<span class="sd">            If ``True``, print database size and a sample entry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># load main database</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> files.</span><span class="se">\n</span><span class="s2">Sample:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="c1"># save to attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span></div>


<div class="viewcode-block" id="RINEXDataHolding.load_locations_from_rinex">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding.load_locations_from_rinex">[docs]</a>
    <span class="k">def</span> <span class="nf">load_locations_from_rinex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                  <span class="n">keep</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span>
                                  <span class="n">replace_not_found</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                  <span class="n">no_pbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
                                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scan the RINEX files&#39; headers for approximate locations for</span>
<span class="sd">        plotting purposes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        keep</span>
<span class="sd">            Determine which location to use. Possible values are ``&#39;last&#39;``</span>
<span class="sd">            (only scan the most recent file), ``&#39;first&#39;`` (only scan the oldest</span>
<span class="sd">            file) or ``&#39;mean&#39;`` (load all files and calculate average).</span>
<span class="sd">            Note that ``&#39;mean&#39;`` could take a substantial amount of time, since</span>
<span class="sd">            all files have to opened, decompressed and searched.</span>
<span class="sd">        replace_not_found</span>
<span class="sd">            If a location is not found and ``replace_not_found=True``,</span>
<span class="sd">            the location of Null Island (0 Longitude, 0 Latitude) is used</span>
<span class="sd">            and a warning is issued.</span>
<span class="sd">            If ``False``, an error is raised instead.</span>
<span class="sd">        no_pbar</span>
<span class="sd">            Suppress the progress bar with ``True``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># prepare</span>
        <span class="k">assert</span> <span class="n">keep</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">],</span> \
            <span class="sa">f</span><span class="s2">&quot;Unrecognized &#39;keep&#39; option </span><span class="si">{</span><span class="n">keep</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="n">XYZ</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_stations</span><span class="p">})</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_stations</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="n">XYZ</span><span class="p">))</span>
        <span class="c1"># get xyz for each station</span>
        <span class="n">iterfiles</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">,</span>
                         <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Reading RINEX headers&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="n">no_pbar</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">iterfiles</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_files_by</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">station</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keep</span> <span class="o">==</span> <span class="s2">&quot;last&quot;</span><span class="p">:</span>
                <span class="n">filenames</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
            <span class="n">approx_xyz</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">found_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rinex_header</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="s2">&quot;APPROX POSITION XYZ&quot;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">approx_xyz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">found_pos</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">keep</span> <span class="o">!=</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">approx_xyz</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">replace_not_found</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find an approximate location in the RINEX &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;headers for </span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">station</span><span class="si">}</span><span class="s2">. Using Null Island.&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">approx_xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6378137</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find an approximate location in &quot;</span>
                                       <span class="sa">f</span><span class="s2">&quot;the RINEX headers for </span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">station</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">approx_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">approx_xyz</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keep</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                <span class="n">approx_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">approx_xyz</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="n">XYZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">approx_xyz</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="c1"># set the instance properties</span>
        <span class="c1"># the xyz-to-lla conversion is done there</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locations_xyz</span> <span class="o">=</span> <span class="n">df</span></div>


<div class="viewcode-block" id="RINEXDataHolding.load_locations_from_file">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding.load_locations_from_file">[docs]</a>
    <span class="k">def</span> <span class="nf">load_locations_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a previously-saved DataFrame containing the locations of each station.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath</span>
<span class="sd">            Path to the pickled DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s2">&quot;station&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;No &#39;station&#39; column in </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locations_xyz</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;alt&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locations_lla</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized DataFrame columns in </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span></div>


<div class="viewcode-block" id="RINEXDataHolding.get_files_by">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding.get_files_by">[docs]</a>
    <span class="k">def</span> <span class="nf">get_files_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">station</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">network</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">year</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">between</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a subset of the database by criteria.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        station</span>
<span class="sd">            Return only files of this/these station(s).</span>
<span class="sd">        network</span>
<span class="sd">            Return only files of this/these network(s).</span>
<span class="sd">        year</span>
<span class="sd">            Return only files of this/these year(s).</span>
<span class="sd">        between</span>
<span class="sd">            Return only files between the start and end date (inclusive)</span>
<span class="sd">            given by the length-two tuple.</span>
<span class="sd">        verbose</span>
<span class="sd">            If ``True``, print the number of selected entries.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            The DataFrame subset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_files</span><span class="p">))</span>
        <span class="c1"># subset by station</span>
        <span class="k">if</span> <span class="n">station</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">station</span> <span class="o">=</span> <span class="p">[</span><span class="n">station</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">assert</span> <span class="p">(</span><span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">station</span><span class="p">])),</span> \
                    <span class="s2">&quot;Found non-string station entries in &#39;station&#39;.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid input form for &#39;station&#39;, must be a string or &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;list of strings, got </span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">subset</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
        <span class="c1"># subset by network</span>
        <span class="k">if</span> <span class="n">network</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">network</span> <span class="o">=</span> <span class="p">[</span><span class="n">network</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">assert</span> <span class="p">(</span><span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">network</span><span class="p">])),</span> \
                    <span class="s2">&quot;Found non-string network entries in &#39;network&#39;.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid input form for &#39;network&#39;, must be a string or &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;list of strings, got </span><span class="si">{</span><span class="n">network</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">subset</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;network&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
        <span class="c1"># subset by year</span>
        <span class="k">if</span> <span class="n">year</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">year</span> <span class="o">=</span> <span class="p">[</span><span class="n">year</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">assert</span> <span class="p">((</span><span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">year</span><span class="p">])</span> <span class="ow">or</span>
                         <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">year</span><span class="p">]))),</span> \
                    <span class="s2">&quot;Found non-string/integer year entries in &#39;year&#39;.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid input form for &#39;year&#39;, must be an integer, string or &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;list of integers or strings, got </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">year</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">year</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid input form for &#39;year&#39;, must be an integer, string or &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;list of integers or strings, got </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.&quot;</span>
                                <span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="n">subset</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
        <span class="c1"># subset by time span</span>
        <span class="k">if</span> <span class="n">between</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">between</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">between</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">between</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid input form for &#39;between&#39;, needs to be a length-two &quot;</span>
                                <span class="s2">&quot;tuple of entries that can be converted to Pandas Timestamps, &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">between</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="n">subset</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">between</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">between</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># return</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected </span><span class="si">{</span><span class="n">subset</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> files.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span></div>


<div class="viewcode-block" id="RINEXDataHolding.get_location">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding.get_location">[docs]</a>
    <span class="k">def</span> <span class="nf">get_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">station</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lla</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the approximate location of a station.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        station</span>
<span class="sd">            Name of the station</span>
<span class="sd">        lla</span>
<span class="sd">            If ``True``, returns the coordinates in Longitude [], Latitude [] &amp;</span>
<span class="sd">            Altitude [m], otherwise in XYZ [m] coordinates.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            The location of the station in the specified coordinate system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loc_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations_lla</span> <span class="k">if</span> <span class="n">lla</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations_xyz</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">loc_df</span><span class="p">[</span><span class="n">loc_df</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">station</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
                   <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Station </span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s2"> not present.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="RINEXDataHolding.load_metrics_from_file">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding.load_metrics_from_file">[docs]</a>
    <span class="k">def</span> <span class="nf">load_metrics_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a previously-saved DataFrame containing the calculated availability metrics.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath</span>
<span class="sd">            Path to the pickled DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>


<div class="viewcode-block" id="RINEXDataHolding.make_filenames">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding.make_filenames">[docs]</a>
    <span class="k">def</span> <span class="nf">make_filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recreate the full paths to the individual rinex files from the database or</span>
<span class="sd">        a subset thereof.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db</span>
<span class="sd">            :attr:`~df` or a subset thereof.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            List of paths.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            If :attr:`~GLOBPATTERN` or :attr:`~RINEXPATTERN` for this instance are not the</span>
<span class="sd">            same as the default values. In this case, redefine this function with the</span>
<span class="sd">            appropriate folder and file patterns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GLOBPATTERN</span> <span class="o">!=</span> <span class="n">RINEXDataHolding</span><span class="o">.</span><span class="n">GLOBPATTERN</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RINEXPATTERN</span> <span class="o">!=</span> <span class="n">RINEXDataHolding</span><span class="o">.</span><span class="n">RINEXPATTERN</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;GLOBPATTERN or RINEXPATTERN of this instance have been &quot;</span>
                                      <span class="s2">&quot;modified, therefore the default way of creating full &quot;</span>
                                      <span class="s2">&quot;filenames is no longer valid.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">basefolder</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                             <span class="n">row</span><span class="o">.</span><span class="n">station_raw</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">day</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">sequence</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span>
                             <span class="n">row</span><span class="o">.</span><span class="n">year</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">compression</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()]</span></div>


<div class="viewcode-block" id="RINEXDataHolding.get_rinex_header">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding.get_rinex_header">[docs]</a>
    <span class="k">def</span> <span class="nf">get_rinex_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a RINEX file, read the header, and format it as a dictionary.</span>
<span class="sd">        No data type conversion or stripping of whitespaces is performed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath</span>
<span class="sd">            Path to RINEX file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            Dictionary of header lines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if it&#39;s a compressed file, hope that gzip is installed and we can use</span>
        <span class="c1"># it to decompress on-the-fly</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COMPRFILEEXTS</span><span class="p">):</span>
                <span class="n">rinexfile</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;gzip&quot;</span><span class="p">,</span> <span class="s2">&quot;-dc&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">],</span>
                                                    <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">rinexfile</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t read compressed RINEX file </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">. &quot;</span>
                               <span class="s2">&quot;Check if &#39;gzip&#39; is available on your machine, or &quot;</span>
                               <span class="s2">&quot;decompress the RINEX file before using this &quot;</span>
                               <span class="s2">&quot;function.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">except</span> <span class="ne">UnicodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t read file </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">.&quot;</span>
                               <span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="c1"># extract headers</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">rinexfile</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">content</span><span class="p">,</span> <span class="n">descriptor</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="mi">60</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">60</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">descriptor</span> <span class="o">==</span> <span class="s2">&quot;END OF HEADER&quot;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="n">descriptor</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="n">descriptor</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
        <span class="k">return</span> <span class="n">headers</span></div>


<div class="viewcode-block" id="RINEXDataHolding.calculate_availability_metrics">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding.calculate_availability_metrics">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_availability_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                       <span class="n">sampling</span><span class="p">:</span> <span class="n">Timedelta</span> <span class="o">=</span> <span class="n">Timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>
                                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the following metrics and stores them in the :attr:`~metrics`</span>
<span class="sd">        DataFrame:</span>

<span class="sd">        * ``&#39;number&#39;``: Number of available observations.</span>
<span class="sd">        * ``&#39;age&#39;``: Time of first observation.</span>
<span class="sd">        * ``&#39;recency&#39;``: Time of last observation.</span>
<span class="sd">        * ``&#39;length&#39;``: Time between first and last observation.</span>
<span class="sd">        * ``&#39;reliability&#39;``: Reliability defined as number of observations divided</span>
<span class="sd">          by the maximum amount of possible observations between the first and last</span>
<span class="sd">          acquisition given the assumed sampling interval of the data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sampling</span>
<span class="sd">            Assumed sampling frequency of the data files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialize empty DataFrame</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_stations</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">])</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_stations</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span>
                                            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">METRICCOLS</span><span class="p">))</span>
        <span class="c1"># calculate metrics station by station</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_files_by</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">station</span><span class="p">)</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;recency&quot;</span><span class="p">]]</span> <span class="o">=</span> \
                <span class="p">[</span><span class="n">subset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="s2">&quot;recency&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sampling</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="s2">&quot;reliability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">subset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sampling</span><span class="p">)</span> <span class="o">/</span> \
                <span class="n">metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">]</span>
        <span class="c1"># set attribute</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span></div>


    <span class="k">def</span> <span class="nf">_create_map_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">gui_settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                           <span class="n">annotate_stations</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                           <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span>
                           <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">mpl</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">CRS</span><span class="p">,</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">CRS</span><span class="p">,</span>
                                      <span class="n">matplotlib</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">PathCollection</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="c1"># get location data and projections</span>
        <span class="n">stat_lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations_lla</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">stat_lons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations_lla</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">stat_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations_lla</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">proj_gui</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ccrs</span><span class="p">,</span> <span class="n">gui_settings</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">])()</span>
        <span class="n">proj_lla</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
        <span class="c1"># create figure and plot stations</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">proj_gui</span><span class="p">)</span>
        <span class="n">stat_points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">stat_lons</span><span class="p">,</span> <span class="n">stat_lats</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span>
                                 <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">proj_lla</span><span class="p">,</span>
                                 <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">annotate_stations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sname</span><span class="p">,</span> <span class="n">slon</span><span class="p">,</span> <span class="n">slat</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stat_names</span><span class="p">,</span> <span class="n">stat_lons</span><span class="p">,</span> <span class="n">stat_lats</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">sname</span><span class="p">,</span> <span class="p">(</span><span class="n">slon</span><span class="p">,</span> <span class="n">slat</span><span class="p">),</span>
                            <span class="n">xycoords</span><span class="o">=</span><span class="n">proj_lla</span><span class="o">.</span><span class="n">_as_mpl_transform</span><span class="p">(</span><span class="n">ax</span><span class="p">),</span>
                            <span class="n">annotation_clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset pixels&quot;</span><span class="p">,</span>
                            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
        <span class="c1"># create underlay</span>
        <span class="n">map_underlay</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">gui_settings</span><span class="p">[</span><span class="s2">&quot;wmts_show&quot;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_wmts</span><span class="p">(</span><span class="n">gui_settings</span><span class="p">[</span><span class="s2">&quot;wmts_server&quot;</span><span class="p">],</span>
                            <span class="n">layer_name</span><span class="o">=</span><span class="n">gui_settings</span><span class="p">[</span><span class="s2">&quot;wmts_layer&quot;</span><span class="p">],</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="n">gui_settings</span><span class="p">[</span><span class="s2">&quot;wmts_alpha&quot;</span><span class="p">])</span>
                <span class="n">map_underlay</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gui_settings</span><span class="p">[</span><span class="s2">&quot;coastlines_show&quot;</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="o">.</span><span class="n">with_scale</span><span class="p">(</span><span class="n">gui_settings</span><span class="p">[</span><span class="s2">&quot;coastlines_res&quot;</span><span class="p">]),</span>
                           <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span> <span class="k">if</span> <span class="n">map_underlay</span> <span class="k">else</span> <span class="s2">&quot;black&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="o">.</span><span class="n">with_scale</span><span class="p">(</span><span class="n">gui_settings</span><span class="p">[</span><span class="s2">&quot;coastlines_res&quot;</span><span class="p">]),</span>
                           <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span> <span class="k">if</span> <span class="n">map_underlay</span> <span class="k">else</span> <span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">proj_gui</span><span class="p">,</span> <span class="n">proj_lla</span><span class="p">,</span> <span class="n">stat_points</span><span class="p">,</span> <span class="n">stat_names</span>

<div class="viewcode-block" id="RINEXDataHolding.plot_map">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding.plot_map">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="s2">&quot;vertical&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
                 <span class="n">annotate_stations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">saveas</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">dpi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">gui_kw_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a map of all the stations present in the RINEX database.</span>
<span class="sd">        The markers can be colored by the different availability metrics calculated</span>
<span class="sd">        by :meth:`~calculate_availability_metrics`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        metric</span>
<span class="sd">            Calculate the marker color (and respective colormap) given a certain</span>
<span class="sd">            metric. If ``None``, no color is applied.</span>
<span class="sd">        orientation</span>
<span class="sd">            Colorbar orientation, see :func:`~matplotlib.pyplot.colorbar`.</span>
<span class="sd">        annotate_stations</span>
<span class="sd">            If ``True``, add the station names to the map.</span>
<span class="sd">        figsize</span>
<span class="sd">            Set the figure size (width, height) in inches.</span>
<span class="sd">        saveas</span>
<span class="sd">            If provided, the figure will be saved at this location.</span>
<span class="sd">        dpi</span>
<span class="sd">            Use this DPI for saved figures.</span>
<span class="sd">        gui_kw_args</span>
<span class="sd">            Override default GUI settings of :attr:`~disstans.config.defaults`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># prepare</span>
        <span class="n">gui_settings</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;gui&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">gui_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gui_kw_args</span><span class="p">)</span>
        <span class="c1"># get basemap</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">proj_gui</span><span class="p">,</span> <span class="n">proj_lla</span><span class="p">,</span> <span class="n">stat_points</span><span class="p">,</span> <span class="n">stat_names</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_map_figure</span><span class="p">(</span><span class="n">gui_settings</span><span class="p">,</span> <span class="n">annotate_stations</span><span class="p">,</span> <span class="n">figsize</span><span class="p">)</span>  <span class="c1"># noqa: F841</span>
        <span class="c1"># add colors</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">METRICCOLS</span><span class="p">:</span>
            <span class="c1"># get metric in the same order as the stations in the figure</span>
            <span class="n">met</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[[</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="n">metric</span><span class="p">]]</span>
            <span class="n">met_fmt</span> <span class="o">=</span> <span class="p">[</span><span class="n">met</span><span class="p">[</span><span class="n">met</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">station</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                       <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stat_names</span><span class="p">]</span>
            <span class="c1"># metric is a normal numeric value</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;reliability&quot;</span><span class="p">]:</span>
                <span class="n">met_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">met_fmt</span><span class="p">)</span>
                <span class="n">tickformat</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># metric is a timestamp, need to convert</span>
            <span class="k">elif</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;recency&quot;</span><span class="p">]:</span>
                <span class="n">met_ref</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">met_fmt</span><span class="p">)</span>
                <span class="n">met_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">m</span> <span class="o">-</span> <span class="n">met_ref</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">met_fmt</span><span class="p">])</span>

                <span class="c1"># make a helper function for the tick formatting</span>
                <span class="nd">@FuncFormatter</span>  <span class="c1"># noqa: E306</span>
                <span class="k">def</span> <span class="nf">tickformat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">met_ref</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># metric is a timedelta, need to convert</span>
            <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;length&quot;</span><span class="p">:</span>
                <span class="n">met_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">met_fmt</span><span class="p">])</span>

                <span class="c1"># make a helper function for the tick formatting</span>
                <span class="nd">@FuncFormatter</span>  <span class="c1"># noqa: E306</span>
                <span class="k">def</span> <span class="nf">tickformat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
            <span class="c1"># get data range and make colormap</span>
            <span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span> <span class="o">=</span> <span class="n">met_raw</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">met_raw</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">scm</span><span class="o">.</span><span class="n">batlow</span><span class="p">,</span>
                                         <span class="n">norm</span><span class="o">=</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">cmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">cmax</span><span class="p">))</span>
            <span class="c1"># set marker facecolors</span>
            <span class="n">stat_points</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">met_raw</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
            <span class="c1"># add the colorbar</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
                                <span class="n">fraction</span><span class="o">=</span><span class="mf">0.05</span> <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;horizontal&quot;</span> <span class="k">else</span> <span class="mf">0.2</span><span class="p">,</span>
                                <span class="n">pad</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">tickformat</span><span class="p">)</span>
            <span class="n">cticks</span> <span class="o">=</span> <span class="n">cbar</span><span class="o">.</span><span class="n">get_ticks</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cticks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cmin</span><span class="p">:</span>
                <span class="n">cticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmin</span><span class="p">,</span> <span class="o">*</span><span class="n">cticks</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cmax</span><span class="p">:</span>
                <span class="n">cticks</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">cticks</span><span class="p">,</span> <span class="n">cmax</span><span class="p">]</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">cticks</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not interpret &#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&#39; as a metric to use for plotting.&quot;</span><span class="p">,</span>
                 <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># save</span>
        <span class="k">if</span> <span class="n">saveas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveas</span><span class="p">)</span>
        <span class="c1"># show</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="RINEXDataHolding.plot_availability">
<a class="viewcode-back" href="../../disstans/tools.html#disstans.tools.RINEXDataHolding.plot_availability">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">sampling</span><span class="p">:</span> <span class="n">Timedelta</span> <span class="o">=</span> <span class="n">Timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">),</span>
                          <span class="n">sort_by_latitude</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                          <span class="n">saveas</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
                          <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an availability figure for the dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sampling</span>
<span class="sd">            Assume that breaks strictly larger than ``sampling`` constitute a data gap.</span>
<span class="sd">        sort_by_latitude</span>
<span class="sd">            If ``True``, sort the stations by latitude, else alphabetical.</span>
<span class="sd">            (Always falls back to alphabetical if location information is missing.)</span>
<span class="sd">        saveas</span>
<span class="sd">            If provided, the figure will be saved at this location.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># find a sorting by latitude to match a map view,</span>
        <span class="c1"># otherwise go by alphabet</span>
        <span class="n">sort_stations</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">sort_by_latitude</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sort_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locations_lla</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">sort_stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations_lla</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sort_indices</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">sort_stations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sort_stations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_stations</span><span class="p">])))</span>
        <span class="n">n_stations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sort_stations</span><span class="p">)</span>
        <span class="c1"># make an empty figure and start a color loop</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">n_stations</span><span class="p">))</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
        <span class="n">icolor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># loop over stations in the sorted order</span>
        <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">station</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sort_stations</span><span class="p">):</span>
            <span class="c1"># get the station in question</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_files_by</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">)</span>
            <span class="c1"># get the file dates and split them by contiguous chunks</span>
            <span class="n">all_dates</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
            <span class="n">n_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_dates</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">all_dates</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">split_at</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">all_dates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sampling</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">split_at</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">all_dates</span><span class="p">,</span> <span class="n">split_at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">intervals</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_dates</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">intervals</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_dates</span><span class="p">]</span>
            <span class="c1"># plot a line for each chunk</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">([</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chunk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                                <span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mf">0.7</span><span class="p">],</span> <span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mf">1.3</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mf">1.3</span><span class="p">],</span>
                                <span class="n">fc</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">icolor</span><span class="p">])</span>
            <span class="n">icolor</span> <span class="o">=</span> <span class="p">(</span><span class="n">icolor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span>
        <span class="c1"># add station labels</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_stations</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">sort_stations</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># do some pretty formatting</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network(s): </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;Files: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">n_files</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labeltop</span><span class="o">=</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_axisbelow</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">n_stations</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="c1"># add number of files per station</span>
        <span class="n">ax_right</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">ax_right</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">n_stations</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax_right</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_stations</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax_right</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">n_files</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;x-small&quot;</span><span class="p">)</span>
        <span class="n">ax_right</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># save</span>
        <span class="k">if</span> <span class="n">saveas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveas</span><span class="p">)</span>
        <span class="c1"># show</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Tobias Khne.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>