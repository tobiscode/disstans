<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial 3: Incorporating Spatial Coherence &mdash; DISSTANS 2.1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=1413ff29"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=841abef3"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/copybutton.js?v=c8c824eb"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tutorial 4: The use and estimation of covariance" href="tutorial_4.html" />
    <link rel="prev" title="Tutorial 2: Advanced Models and Fitting" href="tutorial_2.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.1.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation &amp; Updates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#minimal-installation">Minimal installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#full-development-installation">Full development installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#updates">Updates</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="tutorial_1.html">Tutorial 1: The first synthetic station</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial_1.html#building-a-model-collection">Building a Model collection</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_1.html#creating-timeseries-objects">Creating Timeseries objects</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_1.html#fitting-the-models">Fitting the models</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_1.html#plotting-the-fit-and-residuals">Plotting the fit and residuals</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_2.html">Tutorial 2: Advanced Models and Fitting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial_2.html#creating-more-complex-synthetic-data">Creating more complex synthetic data</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_2.html#spline-models-for-transients">Spline models for transients</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_2.html#building-a-network">Building a Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_2.html#fitting-an-entire-network">Fitting an entire network</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_2.html#advanced-plotting">Advanced plotting</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_2.html#repeat-with-l2-regularization">Repeat with L2 regularization</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_2.html#repeat-with-l1-regularization">Repeat with L1 regularization</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_2.html#repeat-with-l0-regularization">Repeat with L0 regularization</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_2.html#comparing-specific-parameters">Comparing specific parameters</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Tutorial 3: Incorporating Spatial Coherence</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#preparations">Preparations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dreaming-up-a-network">Dreaming up a network</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fantasizing-data">Fantasizing data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#removing-the-common-mode-error">Removing the Common Mode Error</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fitting-the-data-using-reweighted-l1-regularization">Fitting the data using reweighted L1 regularization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fitting-the-data-using-a-spatially-aware-l1-reweighting">Fitting the data using a spatially-aware L1 reweighting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#finding-unmodeled-jumps">Finding unmodeled jumps</a></li>
<li class="toctree-l3"><a class="reference internal" href="#statistics-of-spatial-reweighting">Statistics of spatial reweighting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-parameter-correlations">Model parameter correlations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transient-visualization-with-worm-plots">Transient visualization with worm plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="#secular-velocity-comparisons">Secular velocity comparisons</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_4.html">Tutorial 4: The use and estimation of covariance</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial_4.html#making-a-noisy-network">Making a noisy network</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_4.html#fitting-the-models-with-the-spatial-l0-solver">Fitting the models with the spatial L0 solver</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_4.html#quality-of-the-fits">Quality of the fits</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_4.html#correlation-of-parameters">Correlation of parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_4.html#simple-linear-regression-with-restricted-spline-set">Simple linear regression with restricted spline set</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_4.html#empirical-covariance-estimation">Empirical covariance estimation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_5.html">Tutorial 5: Signal Recovery at Low SNR</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial_5.html#preparations">Preparations</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_5.html#defining-the-variables-and-hyperparameter-space">Defining the variables and hyperparameter space</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_5.html#running-test-cases">Running test cases</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_5.html#results">Results</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples/example_1.html">Example 1: Long Valley Caldera Transient Motions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_1.html#preparations">Preparations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../examples/example_1.html#getting-data">Getting data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../examples/example_1.html#building-the-network">Building the network</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_1.html#cleaning-the-timeseries">Cleaning the timeseries</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../examples/example_1.html#outlier-and-cme-removal">Outlier and CME removal</a></li>
<li class="toctree-l4"><a class="reference internal" href="../examples/example_1.html#first-pass-major-steps-and-noisy-periods">First pass: major steps and noisy periods</a></li>
<li class="toctree-l4"><a class="reference internal" href="../examples/example_1.html#second-pass-minor-catalog-based-steps">Second pass: minor, catalog-based steps</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_1.html#model-parameter-estimation">Model parameter estimation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_1.html#modeled-horizontal-transient-motion">Modeled horizontal transient motion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_1.html#modeled-vertical-seasonal-motion">Modeled vertical seasonal motion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_1.html#comparison-of-secular-velocities">Comparison of secular velocities</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_1.html#final-considerations">Final considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_1.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples/example_2.html">Example 2: Long Valley Caldera Comparisons</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_2.html#preparations">Preparations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_2.html#homogenous-translation-rotation-and-strain">Homogenous translation, rotation, and strain</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_2.html#rotation-about-an-euler-pole">Rotation about an Euler pole</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_2.html#comparison-of-different-methods">Comparison of different methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_2.html#loading-other-different-datasets">Loading other different datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_2.html#north-american-reference-frame">North American reference frame</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_2.html#estimate-euler-poles-for-datasets">Estimate Euler poles for datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_2.html#map-view-comparison-of-datasets">Map view comparison of datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_2.html#quantitative-comparison-of-datasets">Quantitative comparison of datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/example_2.html#references">References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq.html#how-do-i-know-which-penalties-to-use-in-subst">1. How do I know which penalties to use in <code class="xref py py-func docutils literal notranslate"><span class="pre">lasso_regression()</span></code> and
<code class="xref py py-class docutils literal notranslate"><span class="pre">ReweightingFunction</span></code>?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq.html#how-can-i-save-my-network-object-to-save-time">2. How can I save my <code class="xref py py-class docutils literal notranslate"><span class="pre">Network</span></code> object to save time?</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../disstans.html">DISSTANS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../disstans/config.html">Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../disstans/config.html#disstans.config.defaults"><code class="docutils literal notranslate"><span class="pre">config.defaults</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../disstans/earthquakes.html">Earthquakes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../disstans/earthquakes.html#disstans.earthquakes.okada_displacement"><code class="docutils literal notranslate"><span class="pre">okada_displacement()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../disstans/earthquakes.html#disstans.earthquakes.okada_prior"><code class="docutils literal notranslate"><span class="pre">okada_prior()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../disstans/earthquakes.html#disstans.earthquakes.empirical_prior"><code class="docutils literal notranslate"><span class="pre">empirical_prior()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../disstans/models.html">Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../disstans/models.html#model-parent-class">Model (Parent Class)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#disstans.models.Model"><code class="docutils literal notranslate"><span class="pre">Model</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#disstans.models.check_model_dict"><code class="docutils literal notranslate"><span class="pre">check_model_dict()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../disstans/models.html#model-collection">Model Collection</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#disstans.models.ModelCollection"><code class="docutils literal notranslate"><span class="pre">ModelCollection</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../disstans/models.html#fit-collection">Fit Collection</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#disstans.models.FitCollection"><code class="docutils literal notranslate"><span class="pre">FitCollection</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../disstans/models.html#basic-models">Basic Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#arctangent">Arctangent</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#exponential">Exponential</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#hyperbolic-tangent">Hyperbolic Tangent</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#logarithmic">Logarithmic</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#polynomial">Polynomial</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#step">Step</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#sinusoid">Sinusoid</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../disstans/models.html#spline-models">Spline Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#bspline">BSpline</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#ispline">ISpline</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#basesplineset">BaseSplineSet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#splineset">SplineSet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#decayingsplineset">DecayingSplineSet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/models.html#ampphmodulatedsinusoid">AmpPhModulatedSinusoid</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../disstans/network.html">Network</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../disstans/network.html#disstans.network.Network"><code class="docutils literal notranslate"><span class="pre">Network</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.__contains__"><code class="docutils literal notranslate"><span class="pre">Network.__contains__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.__delitem__"><code class="docutils literal notranslate"><span class="pre">Network.__delitem__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.__getitem__"><code class="docutils literal notranslate"><span class="pre">Network.__getitem__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.__iter__"><code class="docutils literal notranslate"><span class="pre">Network.__iter__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.__len__"><code class="docutils literal notranslate"><span class="pre">Network.__len__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.__setitem__"><code class="docutils literal notranslate"><span class="pre">Network.__setitem__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.__str__"><code class="docutils literal notranslate"><span class="pre">Network.__str__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.add_default_local_models"><code class="docutils literal notranslate"><span class="pre">Network.add_default_local_models()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.add_local_models"><code class="docutils literal notranslate"><span class="pre">Network.add_local_models()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.add_station"><code class="docutils literal notranslate"><span class="pre">Network.add_station()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.add_unused_local_models"><code class="docutils literal notranslate"><span class="pre">Network.add_unused_local_models()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.ampphaseplot"><code class="docutils literal notranslate"><span class="pre">Network.ampphaseplot()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.analyze_residuals"><code class="docutils literal notranslate"><span class="pre">Network.analyze_residuals()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.call_func_no_return"><code class="docutils literal notranslate"><span class="pre">Network.call_func_no_return()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.call_func_ts_return"><code class="docutils literal notranslate"><span class="pre">Network.call_func_ts_return()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.call_netwide_func"><code class="docutils literal notranslate"><span class="pre">Network.call_netwide_func()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.copy_timeseries"><code class="docutils literal notranslate"><span class="pre">Network.copy_timeseries()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.copy_uncertainties"><code class="docutils literal notranslate"><span class="pre">Network.copy_uncertainties()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.create_station"><code class="docutils literal notranslate"><span class="pre">Network.create_station()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.decompose"><code class="docutils literal notranslate"><span class="pre">Network.decompose()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.default_local_models"><code class="docutils literal notranslate"><span class="pre">Network.default_local_models</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.default_location_path"><code class="docutils literal notranslate"><span class="pre">Network.default_location_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.euler_rot_field"><code class="docutils literal notranslate"><span class="pre">Network.euler_rot_field()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.evaluate"><code class="docutils literal notranslate"><span class="pre">Network.evaluate()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.export_network_ts"><code class="docutils literal notranslate"><span class="pre">Network.export_network_ts()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.fit"><code class="docutils literal notranslate"><span class="pre">Network.fit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.fitevalres"><code class="docutils literal notranslate"><span class="pre">Network.fitevalres()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.freeze"><code class="docutils literal notranslate"><span class="pre">Network.freeze()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.from_json"><code class="docutils literal notranslate"><span class="pre">Network.from_json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.get_stations_with"><code class="docutils literal notranslate"><span class="pre">Network.get_stations_with()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.get_trend_change"><code class="docutils literal notranslate"><span class="pre">Network.get_trend_change()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.graphical_cme"><code class="docutils literal notranslate"><span class="pre">Network.graphical_cme()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.gui"><code class="docutils literal notranslate"><span class="pre">Network.gui()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.hom_velocity_field"><code class="docutils literal notranslate"><span class="pre">Network.hom_velocity_field()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.import_network_ts"><code class="docutils literal notranslate"><span class="pre">Network.import_network_ts()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.load_maintenance_dict"><code class="docutils literal notranslate"><span class="pre">Network.load_maintenance_dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.math"><code class="docutils literal notranslate"><span class="pre">Network.math()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.mean_longitude"><code class="docutils literal notranslate"><span class="pre">Network.mean_longitude</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.name"><code class="docutils literal notranslate"><span class="pre">Network.name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.num_stations"><code class="docutils literal notranslate"><span class="pre">Network.num_stations</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.plot_availability"><code class="docutils literal notranslate"><span class="pre">Network.plot_availability()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.remove_models"><code class="docutils literal notranslate"><span class="pre">Network.remove_models()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.remove_station"><code class="docutils literal notranslate"><span class="pre">Network.remove_station()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.remove_timeseries"><code class="docutils literal notranslate"><span class="pre">Network.remove_timeseries()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.spatialfit"><code class="docutils literal notranslate"><span class="pre">Network.spatialfit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.station_locations"><code class="docutils literal notranslate"><span class="pre">Network.station_locations</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.station_names"><code class="docutils literal notranslate"><span class="pre">Network.station_names</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.stations"><code class="docutils literal notranslate"><span class="pre">Network.stations</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.to_json"><code class="docutils literal notranslate"><span class="pre">Network.to_json()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.unfreeze"><code class="docutils literal notranslate"><span class="pre">Network.unfreeze()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.update_default_local_models"><code class="docutils literal notranslate"><span class="pre">Network.update_default_local_models()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/network.html#disstans.network.Network.wormplot"><code class="docutils literal notranslate"><span class="pre">Network.wormplot()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../disstans/processing.html">Processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../disstans/processing.html#unwrap-dict-and-ts">unwrap_dict_and_ts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/processing.html#disstans.processing.unwrap_dict_and_ts"><code class="docutils literal notranslate"><span class="pre">unwrap_dict_and_ts()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../disstans/processing.html#functions">Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/processing.html#clean">clean</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/processing.html#decompose">decompose</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/processing.html#median">median</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/processing.html#midas">midas</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../disstans/processing.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/processing.html#stepdetector">StepDetector</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../disstans/solvers.html">Solvers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../disstans/solvers.html#solution-object">Solution Object</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/solvers.html#disstans.solvers.Solution"><code class="docutils literal notranslate"><span class="pre">Solution</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../disstans/solvers.html#solver-functions">Solver Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/solvers.html#lasso-regression">lasso_regression</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/solvers.html#linear-regression">linear_regression</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/solvers.html#ridge-regression">ridge_regression</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../disstans/solvers.html#reweighting-functions">Reweighting Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/solvers.html#reweightingfunction">ReweightingFunction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/solvers.html#inversereweighting">InverseReweighting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/solvers.html#inversesquaredreweighting">InverseSquaredReweighting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/solvers.html#logarithmicreweighting">LogarithmicReweighting</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../disstans/station.html">Station</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../disstans/station.html#disstans.station.Station"><code class="docutils literal notranslate"><span class="pre">Station</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.__contains__"><code class="docutils literal notranslate"><span class="pre">Station.__contains__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.__delitem__"><code class="docutils literal notranslate"><span class="pre">Station.__delitem__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.__getitem__"><code class="docutils literal notranslate"><span class="pre">Station.__getitem__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.__iter__"><code class="docutils literal notranslate"><span class="pre">Station.__iter__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.__setitem__"><code class="docutils literal notranslate"><span class="pre">Station.__setitem__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.__str__"><code class="docutils literal notranslate"><span class="pre">Station.__str__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.add_fit"><code class="docutils literal notranslate"><span class="pre">Station.add_fit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.add_local_model"><code class="docutils literal notranslate"><span class="pre">Station.add_local_model()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.add_local_model_dict"><code class="docutils literal notranslate"><span class="pre">Station.add_local_model_dict()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.add_local_model_kwargs"><code class="docutils literal notranslate"><span class="pre">Station.add_local_model_kwargs()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.add_timeseries"><code class="docutils literal notranslate"><span class="pre">Station.add_timeseries()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.analyze_residuals"><code class="docutils literal notranslate"><span class="pre">Station.analyze_residuals()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.fits"><code class="docutils literal notranslate"><span class="pre">Station.fits</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.get_arch"><code class="docutils literal notranslate"><span class="pre">Station.get_arch()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.get_trend"><code class="docutils literal notranslate"><span class="pre">Station.get_trend()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.get_trend_change"><code class="docutils literal notranslate"><span class="pre">Station.get_trend_change()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.location"><code class="docutils literal notranslate"><span class="pre">Station.location</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.models"><code class="docutils literal notranslate"><span class="pre">Station.models</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.name"><code class="docutils literal notranslate"><span class="pre">Station.name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.remove_fit"><code class="docutils literal notranslate"><span class="pre">Station.remove_fit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.remove_local_models"><code class="docutils literal notranslate"><span class="pre">Station.remove_local_models()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.remove_timeseries"><code class="docutils literal notranslate"><span class="pre">Station.remove_timeseries()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.sum_fits"><code class="docutils literal notranslate"><span class="pre">Station.sum_fits()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.timeseries"><code class="docutils literal notranslate"><span class="pre">Station.timeseries</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.ts"><code class="docutils literal notranslate"><span class="pre">Station.ts</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/station.html#disstans.station.Station.unused_models"><code class="docutils literal notranslate"><span class="pre">Station.unused_models</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../disstans/timeseries.html">Timeseries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../disstans/timeseries.html#timeseries-parent-class">Timeseries (Parent Class)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/timeseries.html#disstans.timeseries.Timeseries"><code class="docutils literal notranslate"><span class="pre">Timeseries</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../disstans/timeseries.html#specialized-classes">Specialized Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/timeseries.html#gipsytimeseries">GipsyTimeseries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/timeseries.html#gipsyxtimeseries">GipsyXTimeseries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/timeseries.html#unrtimeseries">UNRTimeseries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/timeseries.html#unrhighratetimeseries">UNRHighRateTimeseries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/timeseries.html#f5file">F5File</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/timeseries.html#f5timeseries">F5Timeseries</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../disstans/tools.html">Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../disstans/tools.html#functions">Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#best-utmzone">best_utmzone</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#block-permutation">block_permutation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#cov2corr">cov2corr</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#create-powerlaw-noise">create_powerlaw_noise</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#date2decyear">date2decyear</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#download-unr-data">download_unr_data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#estimate-euler-pole">estimate_euler_pole</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#eulerpole2rotvec">eulerpole2rotvec</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#full-cov-mat-to-columns">full_cov_mat_to_columns</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#get-cov-dims">get_cov_dims</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#make-cov-index-map">make_cov_index_map</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#get-cov-indices">get_cov_indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#get-hom-vel-strain-rot">get_hom_vel_strain_rot</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#parallelize">parallelize</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#parse-maintenance-table">parse_maintenance_table</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#parse-unr-steps">parse_unr_steps</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#r-ecef2enu">R_ecef2enu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#r-enu2ecef">R_enu2ecef</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#rotvec2eulerpole">rotvec2eulerpole</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#selectpair">selectpair</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#strain-rotation-invariants">strain_rotation_invariants</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#tvec-to-numpycol">tvec_to_numpycol</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#weighted-median">weighted_median</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../disstans/tools.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#click">Click</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#rinexdataholding">RINEXDataHolding</a></li>
<li class="toctree-l4"><a class="reference internal" href="../disstans/tools.html#timedelta">Timedelta</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DISSTANS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Tutorial 3: Incorporating Spatial Coherence</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/tutorial_3.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tutorial-3-incorporating-spatial-coherence">
<h1>Tutorial 3: Incorporating Spatial Coherence<a class="headerlink" href="#tutorial-3-incorporating-spatial-coherence" title="Link to this heading">ÔÉÅ</a></h1>
<aside class="sidebar">
<p class="sidebar-title">Download full script</p>
<p><a class="reference download internal" download="" href="../_downloads/84a7eb6a58150010066b7acdbed85558/tutorial_3_spatial_sparsity.py"><code class="xref download docutils literal notranslate"><span class="pre">tutorial_3_spatial_sparsity.py</span></code></a></p>
</aside>
<p>One of the main goals of DISSTANS that should make it stand out from other timeseries analysis
software/routines is its ability to use spatial coherence as an additional source of
information and constrain. In general, signals like earthquakes, slip events, or seasonal
signals are spatially correlated, as the process have the same sources but affect multiple
stations. By using this knowledge in combination with the enforcement of sparsity, we can
make sure that the models that affect each station have the same character.</p>
<p>On the flipside, signals that only affect a single station are usually noise (like antenna
maintenance), which we would like to isolate. By making it harder for a station to fit a model
when no station around it sees the same signal, its residuals will become very large around
the time in question, and it is easier to therefore detect processes that need to be looked at
(or fitted specifically for that station).</p>
<p>In this tutorial, we will therefore create a synthetic network of 16 stations, seeing two
data components (East and North) each, that are affected by both regional processes (slow slip
events, an earthquake, and seasonal variations) as well as local ones (a maintenance step
and some local flicker noise). Common mode noise is added and estimated as well.
We will assess the incorporation of spatial coherence on a station-by-station basis (misfit
at the station with the singular maintenance step) as well as over the entire network
(by looking at the parameter correlation matrix between stations). The fitting and
evaluating will be done in parallel to achieve a significant speed-up.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By default, DISSTANS does not use parallelization because of the intricacies
between Python, NumPy/SciPy, and the low-level math libraries like BLAS/LAPACK
(which can differ from machine to machine). For more information, including how
to properly set up parallelization, see <a class="reference internal" href="../disstans/tools.html#disstans.tools.parallelize" title="disstans.tools.parallelize"><code class="xref py py-func docutils literal notranslate"><span class="pre">parallelize()</span></code></a>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The figures and numbers presented in this example no longer exactly match what is
presented in <a class="reference internal" href="../disstans/models.html#koehne23" id="id1"><span>[koehne23]</span></a>. This is because significant code improvements to DISSTANS
were introduced with version 2, and the effect of the hyperparameters changed.
Care has been taken to recreate this example to match what is in the published study,
although small quantitative changes remain. The qualitative interpretations are
unchanged.</p>
</div>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#preparations" id="id4">Preparations</a></p></li>
<li><p><a class="reference internal" href="#dreaming-up-a-network" id="id5">Dreaming up a network</a></p></li>
<li><p><a class="reference internal" href="#fantasizing-data" id="id6">Fantasizing data</a></p></li>
<li><p><a class="reference internal" href="#removing-the-common-mode-error" id="id7">Removing the Common Mode Error</a></p></li>
<li><p><a class="reference internal" href="#fitting-the-data-using-reweighted-l1-regularization" id="id8">Fitting the data using reweighted L1 regularization</a></p></li>
<li><p><a class="reference internal" href="#fitting-the-data-using-a-spatially-aware-l1-reweighting" id="id9">Fitting the data using a spatially-aware L1 reweighting</a></p></li>
<li><p><a class="reference internal" href="#finding-unmodeled-jumps" id="id10">Finding unmodeled jumps</a></p></li>
<li><p><a class="reference internal" href="#statistics-of-spatial-reweighting" id="id11">Statistics of spatial reweighting</a></p></li>
<li><p><a class="reference internal" href="#model-parameter-correlations" id="id12">Model parameter correlations</a></p></li>
<li><p><a class="reference internal" href="#transient-visualization-with-worm-plots" id="id13">Transient visualization with worm plots</a></p></li>
<li><p><a class="reference internal" href="#secular-velocity-comparisons" id="id14">Secular velocity comparisons</a></p></li>
</ul>
</nav>
<section id="preparations">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Preparations</a><a class="headerlink" href="#preparations" title="Link to this heading">ÔÉÅ</a></h2>
<p>We need to prepare two things: parallelization (which can differ from the machine used to
test this tutorial to yours, see the note above) and a random number seed to make the data
and figures reproducible.
In this case here, setting the environment variable <code class="docutils literal notranslate"><span class="pre">'OMP_NUM_THREADS'</span></code>
in the script does the trick, and we can set the number of threads manually:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">os</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">disstans</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">disstans</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;num_threads&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span>
</pre></div>
</div>
<p>And we can create a random number generator just like in the previous example:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="dreaming-up-a-network">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Dreaming up a network</a><a class="headerlink" href="#dreaming-up-a-network" title="Link to this heading">ÔÉÅ</a></h2>
<p>The network we‚Äôre dreaming of is a collection of 16 stations situated on the beautiful
<a class="reference external" href="https://en.wikipedia.org/wiki/Null_Island">Null Island</a>. There is no reason the
stations shouldn‚Äôt be named after fake kitten names created by a neural network of
<a class="reference external" href="https://aiweirdness.com/post/162396324452/neural-networks-kittens">AI Weirdness</a>.
So, let‚Äôs create the locations on a line-like grid with some random variations,
instantiate a <a class="reference internal" href="../disstans/network.html#disstans.network.Network" title="disstans.network.Network"><code class="xref py py-class docutils literal notranslate"><span class="pre">Network</span></code></a> object, and add the corresponding
<a class="reference internal" href="../disstans/station.html#disstans.station.Station" title="disstans.station.Station"><code class="xref py py-class docutils literal notranslate"><span class="pre">Station</span></code></a> objects:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">disstans</span> <span class="kn">import</span> <span class="n">Network</span><span class="p">,</span> <span class="n">Station</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net_name</span> <span class="o">=</span> <span class="s2">&quot;NullIsland&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">station_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Jeckle&quot;</span><span class="p">,</span> <span class="s2">&quot;Cylon&quot;</span><span class="p">,</span> <span class="s2">&quot;Marper&quot;</span><span class="p">,</span> <span class="s2">&quot;Timble&quot;</span><span class="p">,</span>
<span class="gp">... </span>                 <span class="s2">&quot;Macnaw&quot;</span><span class="p">,</span> <span class="s2">&quot;Colzyy&quot;</span><span class="p">,</span> <span class="s2">&quot;Mrror&quot;</span><span class="p">,</span> <span class="s2">&quot;Mankith&quot;</span><span class="p">,</span>
<span class="gp">... </span>                 <span class="s2">&quot;Lingo&quot;</span><span class="p">,</span> <span class="s2">&quot;Marvish&quot;</span><span class="p">,</span> <span class="s2">&quot;Corko&quot;</span><span class="p">,</span> <span class="s2">&quot;Kogon&quot;</span><span class="p">,</span>
<span class="gp">... </span>                 <span class="s2">&quot;Malool&quot;</span><span class="p">,</span> <span class="s2">&quot;Aarla&quot;</span><span class="p">,</span> <span class="s2">&quot;Tygrar&quot;</span><span class="p">,</span> <span class="s2">&quot;Jozga&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">nlon</span><span class="p">,</span> <span class="n">nlat</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">num_stations</span> <span class="o">=</span> <span class="n">nlon</span> <span class="o">*</span> <span class="n">nlat</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">nlon</span><span class="p">),</span>
<span class="gp">... </span>                         <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">nlat</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span> <span class="o">=</span> <span class="n">Network</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">net_name</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="p">(</span><span class="n">istat</span><span class="p">,</span> <span class="n">stat_name</span><span class="p">),</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">station_names</span><span class="p">),</span>
<span class="gp">... </span>                                        <span class="n">lons</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">lats</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
<span class="gp">... </span>    <span class="n">temp_loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">lat</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">()</span><span class="o">*</span><span class="mf">0.02</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">istat</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">lon</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">()</span><span class="o">*</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
<span class="gp">... </span>    <span class="n">net</span><span class="p">[</span><span class="n">stat_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Station</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">stat_name</span><span class="p">,</span>
<span class="gp">... </span>                             <span class="n">location</span><span class="o">=</span><span class="n">temp_loc</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="fantasizing-data">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Fantasizing data</a><a class="headerlink" href="#fantasizing-data" title="Link to this heading">ÔÉÅ</a></h2>
<p>Just as above, we first need a vector of time stamps:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t_start_str</span> <span class="o">=</span> <span class="s2">&quot;2000-01-01&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t_end_str</span> <span class="o">=</span> <span class="s2">&quot;2010-01-01&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timevector</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">t_start_str</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">t_end_str</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Remember that we wanted signals that are coherent in space. To do this, it is easiest
if we define a function that takes the location of a station as input, and returns
model parameters (for both the East and North components). That way, every station gets
the same signals, but we can vary the amplitudes to simulate decreasing distance to
the signal source by making the amplitude drop off with increasing longitude.
The model parameters are then used in the next step when the model objects are created.</p>
<p>The function will also need the common mode noise that should be added to each station,
and the variances and other distrbution parameters when generating the noise. Let‚Äôs
define those first:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># create CME</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cme_noise</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">timevector</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># define noise covariance matrix</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">invgamma</span><span class="p">,</span> <span class="n">laplace</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">var_e</span><span class="p">,</span> <span class="n">var_n</span><span class="p">,</span> <span class="n">cov_en</span> <span class="o">=</span> <span class="mf">0.354</span><span class="p">,</span> <span class="mf">0.538</span><span class="p">,</span> <span class="mf">0.015</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">invgamma_e_alpha</span><span class="p">,</span> <span class="n">invgamma_e_scale</span> <span class="o">=</span> <span class="mf">2.569</span><span class="p">,</span> <span class="mf">0.274</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">invgamma_n_alpha</span><span class="p">,</span> <span class="n">invgamma_n_scale</span> <span class="o">=</span> <span class="mf">3.054</span><span class="p">,</span> <span class="mf">0.536</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">laplace_en_scale</span> <span class="o">=</span> <span class="mf">0.031</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">noise_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">var_e</span><span class="p">,</span> <span class="n">cov_en</span><span class="p">],</span> <span class="p">[</span><span class="n">cov_en</span><span class="p">,</span> <span class="n">var_n</span><span class="p">]])</span>
</pre></div>
</div>
<p>Here, we have defined (1) a covariance matrix from which to generate normally-distributed
noise for the observations, (2) <span class="math notranslate nohighlight">\(\alpha\)</span> and scale parameters for an
inverse-gamma-distributed sampling of observation variances, and (3) a laplacian-distributed
sampling of observation covariances. (These particular values were derived from simple histogram
fitting of real data from the Long Valley Caldera region.) With these variables, and the common
mode error, we can create the actual function introduced above:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">generate_parameters_noise</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">rng</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">lon</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="gp">... </span>    <span class="n">p_sec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
<span class="gp">... </span>    <span class="n">p_seas</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">p_sse1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">]])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">lon</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># from the west</span>
<span class="gp">... </span>    <span class="n">p_sse2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">]])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">lon</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># from the west</span>
<span class="gp">... </span>    <span class="n">p_sse3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">]])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">lon</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># from the west</span>
<span class="gp">... </span>    <span class="n">p_eq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span>
<span class="gp">... </span>    <span class="n">meas_noise</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">cov</span><span class="o">=</span><span class="n">noise_cov</span><span class="p">,</span>
<span class="gp">... </span>                                         <span class="n">size</span><span class="o">=</span><span class="n">timevector</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">noisevec</span> <span class="o">=</span> <span class="n">meas_noise</span> <span class="o">+</span> <span class="n">cme_noise</span>
<span class="gp">... </span>    <span class="n">estim_var_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">invgamma</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">invgamma_e_alpha</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">var_e</span><span class="p">,</span>
<span class="gp">... </span>                                           <span class="n">scale</span><span class="o">=</span><span class="n">invgamma_e_scale</span><span class="p">,</span>
<span class="gp">... </span>                                           <span class="n">size</span><span class="o">=</span><span class="n">timevector</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">rng</span><span class="p">),</span>
<span class="gp">... </span>                              <span class="n">invgamma</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">invgamma_n_alpha</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">var_n</span><span class="p">,</span>
<span class="gp">... </span>                                           <span class="n">scale</span><span class="o">=</span><span class="n">invgamma_n_scale</span><span class="p">,</span>
<span class="gp">... </span>                                           <span class="n">size</span><span class="o">=</span><span class="n">timevector</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">rng</span><span class="p">),</span>
<span class="gp">... </span>                              <span class="n">laplace</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">cov_en</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">laplace_en_scale</span><span class="p">,</span>
<span class="gp">... </span>                                          <span class="n">size</span><span class="o">=</span><span class="n">timevector</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">rng</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">p_sec</span><span class="p">,</span> <span class="n">p_seas</span><span class="p">,</span> <span class="n">p_eq</span><span class="p">,</span> <span class="n">p_sse1</span><span class="p">,</span> <span class="n">p_sse2</span><span class="p">,</span> <span class="n">p_sse3</span><span class="p">,</span> <span class="n">noisevec</span><span class="p">,</span> <span class="n">estim_var_cov</span>
</pre></div>
</div>
<p>Now, we have to do the (slightly grueling) work of creating synthetic data, creating
model and timeseries objects, assigning the parameters to them, and then add them
to the station objects of the network - basically what we did in the previous tutorial,
but for <em>every station</em>. The following code is a bit much, but should still be
understandable when comparing side-by-side with the previous, single-station
example. The one important difference is that we do not yet add the model dictionary
to the station, since we will not be estimating models on the <code class="docutils literal notranslate"><span class="pre">'Raw'</span></code> timeseries,
but rather a cleaner timeseries after we remove the CME.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">disstans</span> <span class="kn">import</span> <span class="n">Timeseries</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">disstans.models</span> <span class="kn">import</span> <span class="n">HyperbolicTangent</span><span class="p">,</span> <span class="n">Polynomial</span><span class="p">,</span> <span class="n">Sinusoid</span><span class="p">,</span> <span class="n">Step</span><span class="p">,</span> \
<span class="gp">... </span>    <span class="n">SplineSet</span><span class="p">,</span> <span class="n">Logarithmic</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">disstans.tools</span> <span class="kn">import</span> <span class="n">create_powerlaw_noise</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mdl_coll</span><span class="p">,</span> <span class="n">mdl_coll_synth</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>  <span class="c1"># containers for the model objects</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">synth_coll</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dictionary of synthetic data &amp; noise for each stations</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">net</span><span class="p">:</span>
<span class="gp">... </span>    <span class="c1"># think of some model parameters</span>
<span class="gp">... </span>    <span class="n">p_sec</span><span class="p">,</span> <span class="n">p_seas</span><span class="p">,</span> <span class="n">p_eq</span><span class="p">,</span> <span class="n">p_sse1</span><span class="p">,</span> <span class="n">p_sse2</span><span class="p">,</span> <span class="n">p_sse3</span><span class="p">,</span> <span class="n">noisevec</span><span class="p">,</span> <span class="n">estim_var_cov</span> <span class="o">=</span> \
<span class="gp">... </span>        <span class="n">generate_parameters_noise</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
<span class="gp">... </span>    <span class="c1"># create model objects</span>
<span class="gp">... </span>    <span class="n">mdl_sec</span> <span class="o">=</span> <span class="n">Polynomial</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">t_reference</span><span class="o">=</span><span class="n">t_start_str</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">mdl_seas</span> <span class="o">=</span> <span class="n">Sinusoid</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">t_reference</span><span class="o">=</span><span class="n">t_start_str</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">mdl_eq</span> <span class="o">=</span> <span class="n">Step</span><span class="p">([</span><span class="s2">&quot;2002-07-01&quot;</span><span class="p">])</span>
<span class="gp">... </span>    <span class="n">mdl_post</span> <span class="o">=</span> <span class="n">Logarithmic</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">t_reference</span><span class="o">=</span><span class="s2">&quot;2002-07-01&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="c1"># HyperbolicTangent (no long tails!) is for the truth, SplineSet are for how</span>
<span class="gp">... </span>    <span class="c1"># we will estimate them.</span>
<span class="gp">... </span>    <span class="c1"># We could align the HyperbolicTangents with the spline center times but that would</span>
<span class="gp">... </span>    <span class="c1"># never happen in real life so it would just unrealistically embellish our results</span>
<span class="gp">... </span>    <span class="n">mdl_sse1</span> <span class="o">=</span> <span class="n">HyperbolicTangent</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">t_reference</span><span class="o">=</span><span class="s2">&quot;2001-07-01&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">mdl_sse2</span> <span class="o">=</span> <span class="n">HyperbolicTangent</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">t_reference</span><span class="o">=</span><span class="s2">&quot;2003-07-01&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">mdl_sse3</span> <span class="o">=</span> <span class="n">HyperbolicTangent</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">t_reference</span><span class="o">=</span><span class="s2">&quot;2007-01-01&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">mdl_trans</span> <span class="o">=</span> <span class="n">SplineSet</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="gp">... </span>                          <span class="n">t_center_start</span><span class="o">=</span><span class="n">t_start_str</span><span class="p">,</span>
<span class="gp">... </span>                          <span class="n">t_center_end</span><span class="o">=</span><span class="n">t_end_str</span><span class="p">,</span>
<span class="gp">... </span>                          <span class="n">list_num_knots</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">)])</span>
<span class="gp">... </span>    <span class="c1"># collect the models in the dictionary</span>
<span class="gp">... </span>    <span class="n">mdl_coll_synth</span><span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Secular&quot;</span><span class="p">:</span> <span class="n">mdl_sec</span><span class="p">,</span>
<span class="gp">... </span>                                    <span class="s2">&quot;Seasonal&quot;</span><span class="p">:</span> <span class="n">mdl_seas</span><span class="p">,</span>
<span class="gp">... </span>                                    <span class="s2">&quot;Earthquake&quot;</span><span class="p">:</span> <span class="n">mdl_eq</span><span class="p">,</span>
<span class="gp">... </span>                                    <span class="s2">&quot;Postseismic&quot;</span><span class="p">:</span> <span class="n">mdl_post</span><span class="p">}</span>
<span class="gp">... </span>    <span class="n">mdl_coll</span><span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mdl_coll_synth</span><span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
<span class="gp">... </span>    <span class="n">mdl_coll_synth</span><span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;SSE1&quot;</span><span class="p">:</span> <span class="n">mdl_sse1</span><span class="p">,</span>
<span class="gp">... </span>                                         <span class="s2">&quot;SSE2&quot;</span><span class="p">:</span> <span class="n">mdl_sse2</span><span class="p">,</span>
<span class="gp">... </span>                                         <span class="s2">&quot;SSE3&quot;</span><span class="p">:</span> <span class="n">mdl_sse3</span><span class="p">})</span>
<span class="gp">... </span>    <span class="n">mdl_coll</span><span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;Transient&quot;</span><span class="p">:</span> <span class="n">mdl_trans</span><span class="p">})</span>
<span class="gp">... </span>    <span class="c1"># only the model objects that will not be associated with the station</span>
<span class="gp">... </span>    <span class="c1"># get their model parameters read in</span>
<span class="gp">... </span>    <span class="n">mdl_sec</span><span class="o">.</span><span class="n">read_parameters</span><span class="p">(</span><span class="n">p_sec</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">mdl_seas</span><span class="o">.</span><span class="n">read_parameters</span><span class="p">(</span><span class="n">p_seas</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">mdl_eq</span><span class="o">.</span><span class="n">read_parameters</span><span class="p">(</span><span class="n">p_eq</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">mdl_post</span><span class="o">.</span><span class="n">read_parameters</span><span class="p">(</span><span class="n">p_eq</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">mdl_sse1</span><span class="o">.</span><span class="n">read_parameters</span><span class="p">(</span><span class="n">p_sse1</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">mdl_sse2</span><span class="o">.</span><span class="n">read_parameters</span><span class="p">(</span><span class="n">p_sse2</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">mdl_sse3</span><span class="o">.</span><span class="n">read_parameters</span><span class="p">(</span><span class="n">p_sse3</span><span class="p">)</span>
<span class="gp">... </span>    <span class="c1"># now, evaluate the models</span>
<span class="gp">... </span>    <span class="c1"># noise will be white + colored</span>
<span class="gp">... </span>    <span class="n">gen_data</span> <span class="o">=</span> \
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;sec&quot;</span><span class="p">:</span> <span class="n">mdl_sec</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">timevector</span><span class="p">)[</span><span class="s2">&quot;fit&quot;</span><span class="p">],</span>
<span class="gp">... </span>         <span class="s2">&quot;trans&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">mdl_sse1</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">timevector</span><span class="p">)[</span><span class="s2">&quot;fit&quot;</span><span class="p">]</span> <span class="o">+</span>
<span class="gp">... </span>                   <span class="n">mdl_sse2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">timevector</span><span class="p">)[</span><span class="s2">&quot;fit&quot;</span><span class="p">]</span> <span class="o">+</span>
<span class="gp">... </span>                   <span class="n">mdl_sse3</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">timevector</span><span class="p">)[</span><span class="s2">&quot;fit&quot;</span><span class="p">]),</span>
<span class="gp">... </span>         <span class="s2">&quot;noise&quot;</span><span class="p">:</span> <span class="n">noisevec</span><span class="p">}</span>
<span class="gp">... </span>    <span class="n">gen_data</span><span class="p">[</span><span class="s2">&quot;seas+sec+eq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gen_data</span><span class="p">[</span><span class="s2">&quot;sec&quot;</span><span class="p">]</span> <span class="o">+</span>
<span class="gp">... </span>                               <span class="n">mdl_seas</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">timevector</span><span class="p">)[</span><span class="s2">&quot;fit&quot;</span><span class="p">]</span> <span class="o">+</span>
<span class="gp">... </span>                               <span class="n">mdl_eq</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">timevector</span><span class="p">)[</span><span class="s2">&quot;fit&quot;</span><span class="p">]</span> <span class="o">+</span>
<span class="gp">... </span>                               <span class="n">mdl_post</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">timevector</span><span class="p">)[</span><span class="s2">&quot;fit&quot;</span><span class="p">])</span>
<span class="gp">... </span>    <span class="c1"># for one station, we&#39;ll add a colored noise process such that the resulting</span>
<span class="gp">... </span>    <span class="c1"># noise variance is the same as before</span>
<span class="gp">... </span>    <span class="c1"># but: only in the second half, where there are no strong, short-term signals</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">station</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Cylon&quot;</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">gen_data</span><span class="p">[</span><span class="s2">&quot;noise&quot;</span><span class="p">][</span><span class="n">timevector</span><span class="o">.</span><span class="n">size</span><span class="o">//</span><span class="mi">2</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> \
<span class="gp">... </span>            <span class="p">(</span><span class="n">gen_data</span><span class="p">[</span><span class="s2">&quot;noise&quot;</span><span class="p">][</span><span class="n">timevector</span><span class="o">.</span><span class="n">size</span><span class="o">//</span><span class="mi">2</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span>
<span class="gp">... </span>             <span class="n">create_powerlaw_noise</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">timevector</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="gp">... </span>                                   <span class="n">exponent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">rng</span>
<span class="gp">... </span>                                   <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">var_e</span><span class="p">,</span> <span class="n">var_n</span><span class="p">]]))</span>
<span class="gp">... </span>             <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">... </span>    <span class="c1"># for one special station, we add the maintenance step</span>
<span class="gp">... </span>    <span class="c1"># repeating all steps above</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">station</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Corko&quot;</span><span class="p">:</span>
<span class="gp">... </span>        <span class="c1"># time and amplitude</span>
<span class="gp">... </span>        <span class="n">p_maint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<span class="gp">... </span>        <span class="n">mdl_maint</span> <span class="o">=</span> <span class="n">Step</span><span class="p">([</span><span class="s2">&quot;2005-01-01&quot;</span><span class="p">])</span>
<span class="gp">... </span>        <span class="n">mdl_maint</span><span class="o">.</span><span class="n">read_parameters</span><span class="p">(</span><span class="n">p_maint</span><span class="p">)</span>
<span class="gp">... </span>        <span class="c1"># add to station and synthetic data</span>
<span class="gp">... </span>        <span class="n">mdl_coll_synth</span><span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;Maintenance&quot;</span><span class="p">:</span> <span class="n">mdl_maint</span><span class="p">})</span>
<span class="gp">... </span>        <span class="n">gen_data</span><span class="p">[</span><span class="s2">&quot;seas+sec+eq&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mdl_maint</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">timevector</span><span class="p">)[</span><span class="s2">&quot;fit&quot;</span><span class="p">]</span>
<span class="gp">... </span>    <span class="c1"># now we sum the components up...</span>
<span class="gp">... </span>    <span class="n">gen_data</span><span class="p">[</span><span class="s2">&quot;truth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_data</span><span class="p">[</span><span class="s2">&quot;seas+sec+eq&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">gen_data</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">]</span>
<span class="gp">... </span>    <span class="n">gen_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_data</span><span class="p">[</span><span class="s2">&quot;truth&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">gen_data</span><span class="p">[</span><span class="s2">&quot;noise&quot;</span><span class="p">]</span>
<span class="gp">... </span>    <span class="n">synth_coll</span><span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_data</span>
<span class="gp">... </span>    <span class="c1"># ... and assign them to the station as timeseries objects</span>
<span class="gp">... </span>    <span class="n">station</span><span class="p">[</span><span class="s2">&quot;Truth&quot;</span><span class="p">]</span> <span class="o">=</span> \
<span class="gp">... </span>        <span class="n">Timeseries</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">timevector</span><span class="o">=</span><span class="n">timevector</span><span class="p">,</span>
<span class="gp">... </span>                              <span class="n">data</span><span class="o">=</span><span class="n">gen_data</span><span class="p">[</span><span class="s2">&quot;truth&quot;</span><span class="p">],</span>
<span class="gp">... </span>                              <span class="n">src</span><span class="o">=</span><span class="s2">&quot;synthetic&quot;</span><span class="p">,</span>
<span class="gp">... </span>                              <span class="n">data_unit</span><span class="o">=</span><span class="s2">&quot;mm&quot;</span><span class="p">,</span>
<span class="gp">... </span>                              <span class="n">data_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">])</span>
<span class="gp">... </span>    <span class="n">station</span><span class="p">[</span><span class="s2">&quot;Raw&quot;</span><span class="p">]</span> <span class="o">=</span> \
<span class="gp">... </span>        <span class="n">Timeseries</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">timevector</span><span class="o">=</span><span class="n">timevector</span><span class="p">,</span>
<span class="gp">... </span>                              <span class="n">data</span><span class="o">=</span><span class="n">gen_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span>
<span class="gp">... </span>                              <span class="n">var</span><span class="o">=</span><span class="n">estim_var_cov</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span>
<span class="gp">... </span>                              <span class="n">cov</span><span class="o">=</span><span class="n">estim_var_cov</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
<span class="gp">... </span>                              <span class="n">src</span><span class="o">=</span><span class="s2">&quot;synthetic&quot;</span><span class="p">,</span>
<span class="gp">... </span>                              <span class="n">data_unit</span><span class="o">=</span><span class="s2">&quot;mm&quot;</span><span class="p">,</span>
<span class="gp">... </span>                              <span class="n">data_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>Of course, this code could be much shorter if we didn‚Äôt want to keep all the
intermediate results and temporary objects.
Let‚Äôs have a look at the summary of the first station to see what we added:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">net</span><span class="p">[</span><span class="s2">&quot;Jeckle&quot;</span><span class="p">])</span>
<span class="go">Station Jeckle at [0.0025146044218678637, -0.0013210486329130189, 0.0] with timeseries</span>
<span class="go">Truth</span>
<span class="go"> - Source: synthetic</span>
<span class="go"> - Units: mm</span>
<span class="go"> - Shape: (3654, 2)</span>
<span class="go"> - Offset Removed: False</span>
<span class="go"> - Data: [&#39;E&#39;, &#39;N&#39;]</span>
<span class="go">Raw</span>
<span class="go"> - Source: synthetic</span>
<span class="go"> - Units: mm</span>
<span class="go"> - Shape: (3654, 2)</span>
<span class="go"> - Offset Removed: False</span>
<span class="go"> - Data: [&#39;E&#39;, &#39;N&#39;]</span>
<span class="go"> - Variances: [&#39;E_var&#39;, &#39;N_var&#39;]</span>
<span class="go"> - Covariances: [&#39;E_N_cov&#39;]</span>
</pre></div>
</div>
<p>One can also have a look at an interactive map and inspect the data and models
of the stations using <a class="reference internal" href="../disstans/network.html#disstans.network.Network.gui" title="disstans.network.Network.gui"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gui()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">gui</span><span class="p">()</span>
</pre></div>
</div>
<p>Which will present the following map:</p>
<img alt="../_images/tutorial_3a_map.png" src="../_images/tutorial_3a_map.png" />
<p>Then, selecting the first station called ‚ÄúJeckle‚Äù will produce the following plot
of all timeseries associated with that station, <code class="docutils literal notranslate"><span class="pre">'Truth'</span></code> and the noisy
<code class="docutils literal notranslate"><span class="pre">'Raw'</span></code>, in both East and North components:</p>
<img alt="../_images/tutorial_3a_ts_Jeckle.png" src="../_images/tutorial_3a_ts_Jeckle.png" />
<p>For this station, the signal is obviously much larger than the noise, but if you
select stations further east, you‚Äôll see how the noise becomes the more dominant
part. How well we can recover the original signal can therefore be tested by looking
at all stations from west to east.</p>
<p>The figures above can either be saved from the interactive window, or by running
<a class="reference internal" href="../disstans/network.html#disstans.network.Network.gui" title="disstans.network.Network.gui"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gui()</span></code></a> in a non-interactive mode:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">gui</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="s2">&quot;Jeckle&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_map</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="removing-the-common-mode-error">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Removing the Common Mode Error</a><a class="headerlink" href="#removing-the-common-mode-error" title="Link to this heading">ÔÉÅ</a></h2>
<p>To remove the common mode error that we added, we first need a high-pass filtered
version of our <code class="docutils literal notranslate"><span class="pre">'Raw'</span></code> timeseries. We can do this effectively and step-insensitive
by calculating the running median of the timeseries, and then removing this
smoothed timeseries from the original one.</p>
<p>Then, we find the common mode, usually done using Principal or Independent Component
Analysis. Lastly, we remove it from the original timeseries, which then yields the cleaner
timeseries we want to use going forward.
In code, the first three steps will look like this:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># running median will be saved in &quot;Filtered&quot; timeseries</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">call_func_ts_return</span><span class="p">(</span><span class="s2">&quot;median&quot;</span><span class="p">,</span> <span class="n">ts_in</span><span class="o">=</span><span class="s2">&quot;Raw&quot;</span><span class="p">,</span> <span class="n">ts_out</span><span class="o">=</span><span class="s2">&quot;Filtered&quot;</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># high-pass filtered timeseries will be in &quot;Residual&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">math</span><span class="p">(</span><span class="s2">&quot;Residual&quot;</span><span class="p">,</span> <span class="s2">&quot;Raw&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;Filtered&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># estimate the common mode</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">call_netwide_func</span><span class="p">(</span><span class="s2">&quot;decompose&quot;</span><span class="p">,</span> <span class="n">ts_in</span><span class="o">=</span><span class="s2">&quot;Residual&quot;</span><span class="p">,</span> <span class="n">ts_out</span><span class="o">=</span><span class="s2">&quot;CME&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ica&quot;</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
</pre></div>
</div>
<p>To have a closer look at the estimated common mode, one can also use the
<a class="reference internal" href="../disstans/network.html#disstans.network.Network.graphical_cme" title="disstans.network.Network.graphical_cme"><code class="xref py py-meth docutils literal notranslate"><span class="pre">graphical_cme()</span></code></a> method, which will show plots of the temporal
and spatial components of the estimated CME. If everything goes well, the temporal component
should look like normally-distributed noise, and the spatial component should look like
a homogenous motion of the stations across the network, like this:</p>
<p><a class="reference internal" href="../_images/tutorial_3b_cme_temporal.png"><img alt="3b_cme_temporal" src="../_images/tutorial_3b_cme_temporal.png" style="width: 49%;" /></a> <a class="reference internal" href="../_images/tutorial_3b_cme_spatial.png"><img alt="3b_cme_spatial" src="../_images/tutorial_3b_cme_spatial.png" style="width: 49%;" /></a></p>
<p>Everything that‚Äôs now left to do is to subtract the newly-created <code class="docutils literal notranslate"><span class="pre">'CME'</span></code> timeseries
from the <code class="docutils literal notranslate"><span class="pre">'Raw'</span></code> timeseries, call it the <code class="docutils literal notranslate"><span class="pre">'Displacement'</span></code> timeseries, copy over
the uncertainties from the original timeseries (assuming they are independent of the CME
estimation process). In the same loop, we can also now add the model dictionaries we
defined above. Lastly, we can remove the now-obsolete intermediate timeseries.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">net</span><span class="p">:</span>
<span class="gp">... </span>    <span class="c1"># calculate the clean timeseries</span>
<span class="gp">... </span>    <span class="n">station</span><span class="o">.</span><span class="n">add_timeseries</span><span class="p">(</span><span class="s2">&quot;Displacement&quot;</span><span class="p">,</span> <span class="n">station</span><span class="p">[</span><span class="s2">&quot;Raw&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">station</span><span class="p">[</span><span class="s2">&quot;CME&quot;</span><span class="p">],</span>
<span class="gp">... </span>                           <span class="n">override_data_cols</span><span class="o">=</span><span class="n">station</span><span class="p">[</span><span class="s2">&quot;Raw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_cols</span><span class="p">)</span>
<span class="gp">... </span>    <span class="c1"># copy over the uncertainties</span>
<span class="gp">... </span>    <span class="n">station</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_uncertainties</span><span class="p">(</span><span class="n">timeseries</span><span class="o">=</span><span class="n">station</span><span class="p">[</span><span class="s2">&quot;Raw&quot;</span><span class="p">])</span>
<span class="gp">... </span>    <span class="c1"># give the station the models to fit</span>
<span class="gp">... </span>    <span class="n">station</span><span class="o">.</span><span class="n">add_local_model_dict</span><span class="p">(</span><span class="n">ts_description</span><span class="o">=</span><span class="s2">&quot;Displacement&quot;</span><span class="p">,</span>
<span class="gp">... </span>                                 <span class="n">model_dict</span><span class="o">=</span><span class="n">mdl_coll</span><span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># remove unnecessary intermediate results</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">remove_timeseries</span><span class="p">(</span><span class="s2">&quot;Filtered&quot;</span><span class="p">,</span> <span class="s2">&quot;CME&quot;</span><span class="p">,</span> <span class="s2">&quot;Residual&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To inspect the result, we can again have a look at the network with
<a class="reference internal" href="../disstans/network.html#disstans.network.Network.gui" title="disstans.network.Network.gui"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gui()</span></code></a>, or print the summary of a station:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">net</span><span class="p">[</span><span class="s2">&quot;Jeckle&quot;</span><span class="p">])</span>
<span class="go">Station Jeckle at [0.0025146044218678637, -0.0013210486329130189, 0.0] with timeseries</span>
<span class="go">Truth</span>
<span class="go"> - Source: synthetic</span>
<span class="go"> - Units: mm</span>
<span class="go"> - Shape: (3654, 2)</span>
<span class="go"> - Offset Removed: False</span>
<span class="go"> - Data: [&#39;E&#39;, &#39;N&#39;]</span>
<span class="go">Raw</span>
<span class="go"> - Source: synthetic</span>
<span class="go"> - Units: mm</span>
<span class="go"> - Shape: (3654, 2)</span>
<span class="go"> - Offset Removed: False</span>
<span class="go"> - Data: [&#39;E&#39;, &#39;N&#39;]</span>
<span class="go"> - Variances: [&#39;E_var&#39;, &#39;N_var&#39;]</span>
<span class="go"> - Covariances: [&#39;E_N_cov&#39;]</span>
<span class="go">Displacement</span>
<span class="go"> - Source: synthetic-decompose</span>
<span class="go"> - Units: mm</span>
<span class="go"> - Shape: (3654, 2)</span>
<span class="go"> - Offset Removed: False</span>
<span class="go"> - Data: [&#39;E&#39;, &#39;N&#39;]</span>
<span class="go"> - Variances: [&#39;E_var&#39;, &#39;N_var&#39;]</span>
<span class="go"> - Covariances: [&#39;E_N_cov&#39;]</span>
<span class="go"> - Models: [&#39;Secular&#39;, &#39;Seasonal&#39;, &#39;Earthquake&#39;, &#39;Postseismic&#39;, &#39;Transient&#39;]</span>
</pre></div>
</div>
</section>
<section id="fitting-the-data-using-reweighted-l1-regularization">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Fitting the data using reweighted L1 regularization</a><a class="headerlink" href="#fitting-the-data-using-reweighted-l1-regularization" title="Link to this heading">ÔÉÅ</a></h2>
<p>We‚Äôll basically do the same processing as at the end of the previous tutorial, but make
use of yet another high-level function to reduce the amount of lines we have to write:
<a class="reference internal" href="../disstans/network.html#disstans.network.Network.fitevalres" title="disstans.network.Network.fitevalres"><code class="xref py py-meth docutils literal notranslate"><span class="pre">fitevalres()</span></code></a>, which combines the two functions
<a class="reference internal" href="../disstans/network.html#disstans.network.Network.fit" title="disstans.network.Network.fit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">fit()</span></code></a> and <a class="reference internal" href="../disstans/network.html#disstans.network.Network.evaluate" title="disstans.network.Network.evaluate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">evaluate()</span></code></a> and
also calculates the residual using <a class="reference internal" href="../disstans/network.html#disstans.network.Network.math" title="disstans.network.Network.math"><code class="xref py py-meth docutils literal notranslate"><span class="pre">math()</span></code></a>.
We‚Äôll start with a single, non-iterative L1-regularized solution:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">fitevalres</span><span class="p">(</span><span class="n">ts_description</span><span class="o">=</span><span class="s2">&quot;Displacement&quot;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;lasso_regression&quot;</span><span class="p">,</span>
<span class="gp">... </span>               <span class="n">penalty</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">output_description</span><span class="o">=</span><span class="s2">&quot;Fit_L1&quot;</span><span class="p">,</span> <span class="n">residual_description</span><span class="o">=</span><span class="s2">&quot;Res_L1&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We‚Äôll also calculate the true errors that we only know because we created the data ourselves,
and save the transient fitted model as a new timeseries (we‚Äôll use them later):</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">net</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">stat</span><span class="p">[</span><span class="s2">&quot;Trans_L1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">only_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">math</span><span class="p">(</span><span class="s2">&quot;Err_L1&quot;</span><span class="p">,</span> <span class="s2">&quot;Fit_L1&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;Truth&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>For this solution and the future ones which will be exploting the spatial structure,
we want to continuously compare the fitted timeseries as well as the scalograms of
the Transient model. So let‚Äôs decide on some potentially interesting stations, and
use the <a class="reference internal" href="../disstans/network.html#disstans.network.Network.gui" title="disstans.network.Network.gui"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gui()</span></code></a> function to save some plots:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">figure_stations</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Jeckle&quot;</span><span class="p">,</span> <span class="s2">&quot;Cylon&quot;</span><span class="p">,</span> <span class="s2">&quot;Marvish&quot;</span><span class="p">,</span> <span class="s2">&quot;Mankith&quot;</span><span class="p">,</span> <span class="s2">&quot;Corko&quot;</span><span class="p">,</span> <span class="s2">&quot;Tygrar&quot;</span><span class="p">,</span> <span class="s2">&quot;Jozga&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">figure_stations</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">net</span><span class="o">.</span><span class="n">gui</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="s2">&quot;base&quot;</span><span class="p">,</span>
<span class="gp">... </span>            <span class="n">timeseries</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">,</span> <span class="s2">&quot;Res_L1&quot;</span><span class="p">],</span>
<span class="gp">... </span>            <span class="n">scalogram_kw_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="s2">&quot;Displacement&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;Transient&quot;</span><span class="p">,</span>
<span class="gp">... </span>                               <span class="s2">&quot;cmaprange&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
</pre></div>
</div>
<p>Now, let‚Äôs have a look at the two most western stations, Jeckle and Cylon:</p>
<p><a class="reference internal" href="../_images/tutorial_3c_scalo_Jeckle_base.png"><img alt="3c_scalo_Jeckle_base" src="../_images/tutorial_3c_scalo_Jeckle_base.png" style="width: 49%;" /></a> <a class="reference internal" href="../_images/tutorial_3c_ts_Jeckle_base.png"><img alt="3c_ts_Jeckle_base" src="../_images/tutorial_3c_ts_Jeckle_base.png" style="width: 49%;" /></a></p>
<p><a class="reference internal" href="../_images/tutorial_3c_scalo_Cylon_base.png"><img alt="3c_scalo_Cylon_base" src="../_images/tutorial_3c_scalo_Cylon_base.png" style="width: 49%;" /></a> <a class="reference internal" href="../_images/tutorial_3c_ts_Cylon_base.png"><img alt="3c_ts_Cylon_base" src="../_images/tutorial_3c_ts_Cylon_base.png" style="width: 49%;" /></a></p>
<p>While in all cases the models fit the data well, one can observe two things.</p>
<p>First, for the time that we added colored noise to Cylon, just as in the previous
tutorial, the transients created by the noise are fit by our spline dictionary.</p>
<p>Second, especially for the time without the colored noise, we can see that apart from a couple
splines that are the closest in time and period to the true slow slip events (SSEs)
hyperbolic tangents, most splines that are non-zero in one station are (close to) zero at the other,
even though we know that both stations experience the same signal (only with a slightly
varying amplitude).</p>
<p>To make this assessment a bit more quantitative, let‚Äôs get some key numbers that define
the sparsity of the model dictionary across the network.
We want to set a threshold below which we consider a parameter ‚Äúbasically zero‚Äù.
Then, for each solution we produce, we want to know how many parameters across the entire
network are non-zero, and how many unique non-zero parameters there are (i.e., if a spline
is used at multiple stations, we‚Äôll only count it once). For this, we set the <code class="docutils literal notranslate"><span class="pre">ZERO</span></code> variable,
and count the number of total, non-zero, and unique non-zero parameters:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ZERO</span> <span class="o">=</span> <span class="mf">1e-6</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">num_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">net</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">num_uniques_base</span> <span class="o">=</span> \
<span class="gp">... </span>    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
<span class="gp">... </span>                            <span class="o">&gt;</span> <span class="n">ZERO</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">net</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">num_nonzero_base</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
<span class="gp">... </span>                         <span class="o">&gt;</span> <span class="n">ZERO</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">net</span><span class="p">])</span>
</pre></div>
</div>
<p>Giving us (the exact numbers might differ slightly):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of reweighted non-zero parameters: </span><span class="si">{</span><span class="n">num_nonzero_base</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_total</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Number of reweighted non-zero parameters: 3062/8416</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of unique reweighted non-zero parameters per component: &quot;</span>
<span class="gp">... </span>      <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_uniques_base</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
<span class="go">Number of unique reweighted non-zero parameters per component: [247, 242]</span>
</pre></div>
</div>
<p>Let‚Äôs keep track of these numbers: All 16 stations (and both components) combined are
fit by 3062 splines (out of the total possible 8416). Of a total of 263 possible splines
at any given station and for each component, 247 in the East and 242 in the North
component are non-zero at least at one station. That is not terribly sparse for three
slow-slip events (SSEs), since the coseismic, postseismic, and seasonal signal should not
be fitted by the splines (or noise, for that matter).</p>
<p>This effectively means that wherever there is not a strong enough signal, the solver will
follow the noise realization at that station to fit the data best given the L1 penalty,
and therefore choose slightly different splines each time.
If we could somehow let the solver know that this is noise, and that the underlying
signal should be coherent in space, it wouldn‚Äôt overfit the data where there is no signal,
and we would have a better understanding of both the true signal and the noise.</p>
<p>(<em>Something else that we will have a look at later, but for now just need to save the data,
is the spatial correlation between the fitted transients - more details about that later,
but for now, let‚Äôs just save the data:</em>)</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cor_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="gp">... </span>                                 <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">net</span><span class="p">]))</span>
</pre></div>
</div>
<p>Our next step is to try iterating over the L1 solution, approximating the L0-regularized
solution. We do this locally for now, i.e. each station is treated independently.
For the reweighting, we need to specify a <a class="reference internal" href="../disstans/solvers.html#disstans.solvers.ReweightingFunction" title="disstans.solvers.ReweightingFunction"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReweightingFunction</span></code></a>,
that tells the solver what parameters are significant and which ones aren‚Äôt. The choice of
the reweighting function and its hyperparameters is crucial for good results, much like the
choice of the penalty parameter for simple L2-regularized least squares. At this stage, there
is no perfect way to know the best choice before looking at the result, so some
trial-and-error is required. An empirically derived, decent starting point for such a
search would put the <code class="docutils literal notranslate"><span class="pre">penalty</span></code> of a similar order of magnitude to the expected noise
variance of the data. Then, looking at a histogram of the parameter magnitudes computed
without any reweighting can give a good intuition about what values should be considered
significant or not.</p>
<p>Using the local L0 regularization does not significantly improve our situation, as we can
see in the results:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rw_func</span> <span class="o">=</span> <span class="n">disstans</span><span class="o">.</span><span class="n">solvers</span><span class="o">.</span><span class="n">InverseReweighting</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">fitevalres</span><span class="p">(</span><span class="n">ts_description</span><span class="o">=</span><span class="s2">&quot;Displacement&quot;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;lasso_regression&quot;</span><span class="p">,</span>
<span class="gp">... </span>               <span class="n">penalty</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">reweight_max_iters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">reweight_func</span><span class="o">=</span><span class="n">rw_func</span><span class="p">,</span>
<span class="gp">... </span>               <span class="n">output_description</span><span class="o">=</span><span class="s2">&quot;Fit_L1R10&quot;</span><span class="p">,</span> <span class="n">residual_description</span><span class="o">=</span><span class="s2">&quot;Res_L1R10&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">net</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">stat</span><span class="p">[</span><span class="s2">&quot;Trans_L1R10&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">only_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">math</span><span class="p">(</span><span class="s2">&quot;Err_L1R10&quot;</span><span class="p">,</span> <span class="s2">&quot;Fit_L1R10&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;Truth&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># get spatial correlation matrix for later</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cor_localiters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="gp">... </span>                                       <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">net</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># get number of (unique) non-zero parameters</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">num_uniques_local</span> <span class="o">=</span> \
<span class="gp">... </span>    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
<span class="gp">... </span>                            <span class="o">&gt;</span> <span class="n">ZERO</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">net</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">num_nonzero_local</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
<span class="gp">... </span>                          <span class="o">&gt;</span> <span class="n">ZERO</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">net</span><span class="p">])</span>
</pre></div>
</div>
<p>Giving approximately:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of reweighted non-zero parameters: </span><span class="si">{</span><span class="n">num_nonzero_local</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_total</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Number of reweighted non-zero parameters: 1123/8416</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of unique reweighted non-zero parameters per component: &quot;</span>
<span class="gp">... </span>      <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_uniques_local</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
<span class="go">Number of unique reweighted non-zero parameters per component: [205, 180]</span>
</pre></div>
</div>
<p>Which gives the following figures (see the plotting code above):</p>
<p><a class="reference internal" href="../_images/tutorial_3c_scalo_Jeckle_local.png"><img alt="3c_scalo_Jeckle_local" src="../_images/tutorial_3c_scalo_Jeckle_local.png" style="width: 49%;" /></a> <a class="reference internal" href="../_images/tutorial_3c_ts_Jeckle_local.png"><img alt="3c_ts_Jeckle_local" src="../_images/tutorial_3c_ts_Jeckle_local.png" style="width: 49%;" /></a></p>
<p><a class="reference internal" href="../_images/tutorial_3c_scalo_Cylon_local.png"><img alt="3c_scalo_Cylon_local" src="../_images/tutorial_3c_scalo_Cylon_local.png" style="width: 49%;" /></a> <a class="reference internal" href="../_images/tutorial_3c_ts_Cylon_local.png"><img alt="3c_ts_Cylon_local" src="../_images/tutorial_3c_ts_Cylon_local.png" style="width: 49%;" /></a></p>
<p>We can see that while the total number of non-zero splines decreased by more than half,
the number of <em>unique</em> non-zero splines decreased by far less. Furthermore, we still
see that different splines are used throughout the stations for the same domminant signals.
From the scalograms, we can also see the effect of driving the penalties for each parameter
either to zero or infinity: the splines that still are used in the fitting process now
have much larger amplitudes compared to before.</p>
<p>Unless we want to create one giant least-squares L1-regularized problem that combines
all stations, and giving the spline parameters a distance-dependent covariance matrix
between the stations (which is computationally still unfeasible for any real regional
network), we need to think of a better way to reduce the number of unique splines.</p>
</section>
<section id="fitting-the-data-using-a-spatially-aware-l1-reweighting">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Fitting the data using a spatially-aware L1 reweighting</a><a class="headerlink" href="#fitting-the-data-using-a-spatially-aware-l1-reweighting" title="Link to this heading">ÔÉÅ</a></h2>
<p><a class="reference internal" href="../disstans/network.html#riel14" id="id2"><span>[riel14]</span></a> solves the problem by alternating between a station-specific solution, and a step
where the parameter weights of each L1-regularized problems are gathered, compared, and
updated based on a weighting scheme. In DISSTANS, this is handled by the
<a class="reference internal" href="../disstans/network.html#disstans.network.Network.spatialfit" title="disstans.network.Network.spatialfit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">spatialfit()</span></code></a> method, where more information about its algorithm
can be found. In this tutorial, we just want to show how it is used and how it can improve
the quality of the fit.</p>
<p><a class="reference internal" href="../disstans/network.html#disstans.network.Network.spatialfit" title="disstans.network.Network.spatialfit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">spatialfit()</span></code></a> takes some important arguments, but at its core
it‚Äôs essentially a wrapper for <a class="reference internal" href="../disstans/network.html#disstans.network.Network.fit" title="disstans.network.Network.fit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">fit()</span></code></a>. Just like the latter,
we give it an (initial) <code class="docutils literal notranslate"><span class="pre">penalty</span></code> parameter. Additionally, we can now specify the models
which we want to combine spatially (<code class="docutils literal notranslate"><span class="pre">spatial_l0_models</span></code>), how many spatial iterations
we want (<code class="docutils literal notranslate"><span class="pre">spatial_reweight_iters</span></code>), and what reweighting function we want to use
(<code class="docutils literal notranslate"><span class="pre">reweight_func</span></code>, from above).</p>
<p>We can also specify the <code class="docutils literal notranslate"><span class="pre">verbose</span></code> option so that we get some interesting statistics along
the way (plus some progress bars that aren‚Äôt shown here). Let‚Äôs start by defining the
reweighting function, running only one spatial iteration, and evaluating its solution:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">spatialfit</span><span class="p">(</span><span class="s2">&quot;Displacement&quot;</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">penalty</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">spatial_l0_models</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Transient&quot;</span><span class="p">],</span>
<span class="gp">... </span>                       <span class="n">spatial_reweight_iters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">reweight_func</span><span class="o">=</span><span class="n">rw_func</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">formal_covariance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">zero_threshold</span><span class="o">=</span><span class="n">ZERO</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">Calculating scale lengths</span>
<span class="go">Distance percentiles in km (5-50-95): [12.6, 38.3, 89.7]</span>
<span class="go">Initial fit</span>
<span class="go">...</span>
<span class="go">Fit after 1 reweightings</span>
<span class="go">...</span>
<span class="go">Done</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s2">&quot;Displacement&quot;</span><span class="p">,</span> <span class="n">output_description</span><span class="o">=</span><span class="s2">&quot;Fit_L1R1S1&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">net</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">stat</span><span class="p">[</span><span class="s2">&quot;Trans_L1R1S1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">only_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">math</span><span class="p">(</span><span class="s2">&quot;Res_L1R1S1&quot;</span><span class="p">,</span> <span class="s2">&quot;Displacement&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;Fit_L1R1S1&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">math</span><span class="p">(</span><span class="s2">&quot;Err_L1R1S1&quot;</span><span class="p">,</span> <span class="s2">&quot;Fit_L1R1S1&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;Truth&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># get spatial correlation matrix for later</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cor_spatialiters1</span> <span class="o">=</span> \
<span class="gp">... </span>    <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="gp">... </span>                          <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">net</span><span class="p">]))</span>
</pre></div>
</div>
<p>Where the solver will give us (approximately) the following statistics:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Calculating</span> <span class="n">scale</span> <span class="n">lengths</span>
<span class="n">Distance</span> <span class="n">percentiles</span> <span class="ow">in</span> <span class="n">km</span> <span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">50</span><span class="o">-</span><span class="mi">95</span><span class="p">):</span> <span class="p">[</span><span class="mf">12.6</span><span class="p">,</span> <span class="mf">38.3</span><span class="p">,</span> <span class="mf">89.7</span><span class="p">]</span>
<span class="n">Initial</span> <span class="n">fit</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">reweighted</span> <span class="n">non</span><span class="o">-</span><span class="n">zero</span> <span class="n">parameters</span><span class="p">:</span> <span class="mi">3062</span><span class="o">/</span><span class="mi">8416</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">unique</span> <span class="n">reweighted</span> <span class="n">non</span><span class="o">-</span><span class="n">zero</span> <span class="n">parameters</span> <span class="n">per</span> <span class="n">component</span><span class="p">:</span> <span class="p">[</span><span class="mi">247</span><span class="p">,</span> <span class="mi">242</span><span class="p">]</span>
<span class="n">Updating</span> <span class="n">weights</span>
<span class="n">Stacking</span> <span class="n">model</span> <span class="n">Transient</span>
<span class="n">Weight</span> <span class="n">percentiles</span> <span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="mi">50</span><span class="o">-</span><span class="mi">95</span><span class="p">):</span> <span class="p">[</span><span class="mf">0.00059886575167</span><span class="p">,</span> <span class="mf">127.17369146</span><span class="p">,</span> <span class="mf">892.46704072</span><span class="p">]</span>
<span class="n">Fit</span> <span class="n">after</span> <span class="mi">1</span> <span class="n">reweightings</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">reweighted</span> <span class="n">non</span><span class="o">-</span><span class="n">zero</span> <span class="n">parameters</span><span class="p">:</span> <span class="mi">496</span><span class="o">/</span><span class="mi">8416</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">unique</span> <span class="n">reweighted</span> <span class="n">non</span><span class="o">-</span><span class="n">zero</span> <span class="n">parameters</span> <span class="n">per</span> <span class="n">component</span><span class="p">:</span> <span class="p">[</span><span class="mi">47</span><span class="p">,</span> <span class="mi">41</span><span class="p">]</span>
<span class="n">RMS</span> <span class="n">difference</span> <span class="n">of</span> <span class="s1">&#39;Transient&#39;</span> <span class="n">parameters</span> <span class="o">=</span> <span class="mf">8.553420029</span> <span class="p">(</span><span class="mi">2814</span> <span class="n">changed</span><span class="p">)</span>
<span class="n">Done</span>
</pre></div>
</div>
<p>The numbers before the first reweighting are exactly the same from before we iterated
at all - which makes sense since the initial solve is before any reweighting can be
done, and we did not specify any local L1 reweighting iterations.
The next two numbers are new however, and they show the effect of our spatial
combination scheme: not only did the total number of non-zero parameters drop
significantly (as before), but the number of <em>unique</em> non-zero parameters dropped
significantly as well.</p>
<p>Let‚Äôs see how this manifests itself in the same stations we looked at above:</p>
<p><a class="reference internal" href="../_images/tutorial_3c_scalo_Jeckle_spatial1.png"><img alt="3c_scalo_Jeckle_spatial1" src="../_images/tutorial_3c_scalo_Jeckle_spatial1.png" style="width: 49%;" /></a> <a class="reference internal" href="../_images/tutorial_3c_ts_Jeckle_spatial1.png"><img alt="3c_ts_Jeckle_spatial1" src="../_images/tutorial_3c_ts_Jeckle_spatial1.png" style="width: 49%;" /></a></p>
<p><a class="reference internal" href="../_images/tutorial_3c_scalo_Cylon_spatial1.png"><img alt="3c_scalo_Cylon_spatial1" src="../_images/tutorial_3c_scalo_Cylon_spatial1.png" style="width: 49%;" /></a> <a class="reference internal" href="../_images/tutorial_3c_ts_Cylon_spatial1.png"><img alt="3c_ts_Cylon_spatial1" src="../_images/tutorial_3c_ts_Cylon_spatial1.png" style="width: 49%;" /></a></p>
<p>As we can see, the fit to the data is almost as good, and the splines used to get
to that fit are basically the same between the two stations. Let‚Äôs see when and
if the spatial iterations converge by doing the same thing, but with 10 reweighting
steps:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">spatialfit</span><span class="p">(</span><span class="s2">&quot;Displacement&quot;</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">penalty</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">spatial_l0_models</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Transient&quot;</span><span class="p">],</span>
<span class="gp">... </span>                       <span class="n">spatial_reweight_iters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">reweight_func</span><span class="o">=</span><span class="n">rw_func</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">formal_covariance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">zero_threshold</span><span class="o">=</span><span class="n">ZERO</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">Calculating scale lengths</span>
<span class="go">Distance percentiles in km (5-50-95): [12.6, 38.3, 89.7]</span>
<span class="go">Initial fit</span>
<span class="go">...</span>
<span class="go">Fit after 10 reweightings</span>
<span class="go">...</span>
<span class="go">Done</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s2">&quot;Displacement&quot;</span><span class="p">,</span> <span class="n">output_description</span><span class="o">=</span><span class="s2">&quot;Fit_L1R1S10&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">net</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">stat</span><span class="p">[</span><span class="s2">&quot;Trans_L1R1S10&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">only_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">math</span><span class="p">(</span><span class="s2">&quot;Res_L1R1S10&quot;</span><span class="p">,</span> <span class="s2">&quot;Displacement&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;Fit_L1R1S10&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">math</span><span class="p">(</span><span class="s2">&quot;Err_L1R1S10&quot;</span><span class="p">,</span> <span class="s2">&quot;Fit_L1R1S10&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;Truth&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># get spatial correlation matrix for later</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cor_spatialiters10</span> <span class="o">=</span> \
<span class="gp">... </span>    <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="gp">... </span>                          <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">net</span><span class="p">]))</span>
</pre></div>
</div>
<p>Let‚Äôs first have a look at the scalograms and timeseries of the stations
we looked at before:</p>
<p><a class="reference internal" href="../_images/tutorial_3c_scalo_Jeckle_spatial10.png"><img alt="3c_scalo_Jeckle_spatial10" src="../_images/tutorial_3c_scalo_Jeckle_spatial10.png" style="width: 49%;" /></a> <a class="reference internal" href="../_images/tutorial_3c_ts_Jeckle_spatial10.png"><img alt="3c_ts_Jeckle_spatial10" src="../_images/tutorial_3c_ts_Jeckle_spatial10.png" style="width: 49%;" /></a></p>
<p><a class="reference internal" href="../_images/tutorial_3c_scalo_Cylon_spatial10.png"><img alt="3c_scalo_Cylon_spatial10" src="../_images/tutorial_3c_scalo_Cylon_spatial10.png" style="width: 49%;" /></a> <a class="reference internal" href="../_images/tutorial_3c_ts_Cylon_spatial10.png"><img alt="3c_ts_Cylon_spatial10" src="../_images/tutorial_3c_ts_Cylon_spatial10.png" style="width: 49%;" /></a></p>
<p>We can now see that this effect is much stronger now: only a handful of splines
are used by the two stations. Depending on the penalty and reweighting parameters,
the fit could have become a bit worse: either by not fitting a signal completely
(leaving a visible residual behind) or by overfitting (fitting noise as signal).
This can be tuned by changing the L1 <code class="docutils literal notranslate"><span class="pre">penalty</span></code>, or by choosing a different
<code class="docutils literal notranslate"><span class="pre">reweight_func</span></code>, or many other configuration settings that are present in
<a class="reference internal" href="../disstans/network.html#disstans.network.Network.spatialfit" title="disstans.network.Network.spatialfit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">spatialfit()</span></code></a>.
Another way that could potentially mitigate misfits would be to use more splines
that will then better match the onset times of the transients we generated. However,
we won‚Äôt spend time on it here since the effects of the tuning will depend a lot on the
data you have.
More importantly though, since in the real world you don‚Äôt know the true signal
and noise, even if you would fit more signal, you could not be sure that you didn‚Äôt
fit a noise process.</p>
<p>What is important to point out, however, is that the residuals at Cylon do not look as
Gaussian anymore for the timespan we added colored noise. Our goal was to suppress
fitting noise processes as signals. Let‚Äôs plot the residuals, true noise, and our errors,
to see if that was successful by comparing this solution with the one that only
had local reweighting iterations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stat</span> <span class="o">=</span> <span class="n">net</span><span class="p">[</span><span class="s2">&quot;Cylon&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">res_ts</span><span class="p">,</span> <span class="n">err_ts</span> <span class="ow">in</span> \
<span class="gp">... </span>    <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;10 Local Reweightings&quot;</span><span class="p">,</span> <span class="s2">&quot;1 Local, 10 Spatial Reweighting&quot;</span><span class="p">],</span>
<span class="gp">... </span>        <span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;spatial10&quot;</span><span class="p">],</span>
<span class="gp">... </span>        <span class="p">[</span><span class="s2">&quot;Res_L1R10&quot;</span><span class="p">,</span> <span class="s2">&quot;Res_L1R1S10&quot;</span><span class="p">],</span>
<span class="gp">... </span>        <span class="p">[</span><span class="s2">&quot;Err_L1R10&quot;</span><span class="p">,</span> <span class="s2">&quot;Err_L1R1S10&quot;</span><span class="p">]):</span>
<span class="gp">... </span>    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="n">res_ts</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.3&#39;</span><span class="p">,</span>
<span class="gp">... </span>               <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="n">res_ts</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">synth_coll</span><span class="p">[</span><span class="s2">&quot;Cylon&quot;</span><span class="p">][</span><span class="s2">&quot;noise&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span>
<span class="gp">... </span>               <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="n">err_ts</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;East [mm]&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="n">res_ts</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.3&#39;</span><span class="p">,</span>
<span class="gp">... </span>               <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="n">res_ts</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">synth_coll</span><span class="p">[</span><span class="s2">&quot;Cylon&quot;</span><span class="p">][</span><span class="s2">&quot;noise&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span>
<span class="gp">... </span>               <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="n">err_ts</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;North [mm]&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">custom_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;0.3&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">),</span>
<span class="gp">... </span>                    <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">),</span>
<span class="gp">... </span>                    <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)]</span>
<span class="gp">... </span>    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">custom_lines</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Residual&quot;</span><span class="p">,</span> <span class="s2">&quot;Noise&quot;</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">],</span>
<span class="gp">... </span>                 <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">custom_lines</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Residual&quot;</span><span class="p">,</span> <span class="s2">&quot;Noise&quot;</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">],</span>
<span class="gp">... </span>                 <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tutorial_3d_Cylon_</span><span class="si">{</span><span class="n">case</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
<p>Which produces the following plots:</p>
<p><a class="reference internal" href="../_images/tutorial_3d_Cylon_local.png"><img alt="3d_Cylon_local" src="../_images/tutorial_3d_Cylon_local.png" style="width: 49%;" /></a> <a class="reference internal" href="../_images/tutorial_3d_Cylon_spatial10.png"><img alt="3d_Cylon_spatial10" src="../_images/tutorial_3d_Cylon_spatial10.png" style="width: 49%;" /></a></p>
<p>Indeed, we can see that the spatial reweighting hindered the solver to fit for some
small-scale noise transients. We can see this in the fact that our residual now more
closely tracks the true noise, and the true error oscillates less and stays closer to zero.
For the longer-scale noise, it is too strong for the solver to ignore (at least with the
current regularization penalties and other hyperparameters). In general, the degree of
success of this method can vary significantly between datasets and hyperparameters.</p>
<p>Quantitatively, we can also see this small improvement when we compute the root-mean-squared
error for the error time series. We can calculate it easily using
<a class="reference internal" href="../disstans/network.html#disstans.network.Network.analyze_residuals" title="disstans.network.Network.analyze_residuals"><code class="xref py py-meth docutils literal notranslate"><span class="pre">analyze_residuals()</span></code></a>
for both error timeseries <code class="docutils literal notranslate"><span class="pre">'Err_L1R10'</span></code> and <code class="docutils literal notranslate"><span class="pre">'Err_L1R1S10'</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stats_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">err_ts</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Err_L1R10&quot;</span><span class="p">,</span> <span class="s2">&quot;Err_L1R1S10&quot;</span><span class="p">]:</span>
<span class="gp">... </span>    <span class="n">stats_dict</span><span class="p">[</span><span class="n">err_ts</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">analyze_residuals</span><span class="p">(</span><span class="n">err_ts</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rms</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Giving us (again, approximately):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">err_ts</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Errors for </span><span class="si">{</span><span class="n">err_ts</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>

<span class="go">Errors for Err_L1R10:</span>
<span class="go">Metrics                      Mean                                           RMS</span>
<span class="go">Components Displacement_Model_E-E Displacement_Model_N-N Displacement_Model_E-E Displacement_Model_N-N</span>
<span class="go">Station</span>
<span class="go">Jeckle                   0.001717               0.011739               0.086412               0.112535</span>
<span class="go">Cylon                   -0.014426              -0.023066               0.224658               0.221669</span>
<span class="go">Marper                  -0.007761               0.012923               0.088403               0.114834</span>
<span class="go">Timble                  -0.019154              -0.020992               0.080029               0.100177</span>
<span class="go">Macnaw                  -0.005531               0.029832               0.100310               0.094463</span>
<span class="go">Colzyy                  -0.014500              -0.015374               0.084248               0.110791</span>
<span class="go">Mrror                    0.004534               0.003598               0.102111               0.074685</span>
<span class="go">Mankith                 -0.028667               0.029660               0.072861               0.107669</span>
<span class="go">Lingo                    0.001428              -0.018158               0.097689               0.114889</span>
<span class="go">Marvish                  0.005776              -0.007322               0.086081               0.086113</span>
<span class="go">Corko                   -0.001758              -0.010560               0.103091               0.072695</span>
<span class="go">Kogon                   -0.009227              -0.009288               0.094518               0.102268</span>
<span class="go">Malool                  -0.008001               0.009324               0.082624               0.119223</span>
<span class="go">Aarla                   -0.008683               0.008970               0.082358               0.092859</span>
<span class="go">Tygrar                   0.025494              -0.010358               0.077535               0.094588</span>
<span class="go">Jozga                   -0.001899              -0.013257               0.078236               0.083391</span>

<span class="go">Errors for Err_L1R1S10:</span>
<span class="go">Metrics                      Mean                                           RMS</span>
<span class="go">Components Displacement_Model_E-E Displacement_Model_N-N Displacement_Model_E-E Displacement_Model_N-N</span>
<span class="go">Station</span>
<span class="go">Jeckle                   0.001523               0.011596               0.043255               0.064558</span>
<span class="go">Cylon                   -0.013879              -0.022360               0.133340               0.150636</span>
<span class="go">Marper                  -0.007989               0.013279               0.058074               0.060193</span>
<span class="go">Timble                  -0.018874              -0.020772               0.048825               0.059827</span>
<span class="go">Macnaw                  -0.005681               0.029725               0.061490               0.064505</span>
<span class="go">Colzyy                  -0.014252              -0.015264               0.049975               0.056185</span>
<span class="go">Mrror                    0.004750               0.003418               0.055196               0.054606</span>
<span class="go">Mankith                 -0.028838               0.029637               0.053583               0.073222</span>
<span class="go">Lingo                    0.001145              -0.018927               0.048167               0.065160</span>
<span class="go">Marvish                  0.005620              -0.007561               0.050421               0.055360</span>
<span class="go">Corko                   -0.001863              -0.010913               0.302084               0.059539</span>
<span class="go">Kogon                   -0.009064              -0.009094               0.053720               0.059153</span>
<span class="go">Malool                  -0.007920               0.009471               0.045286               0.064222</span>
<span class="go">Aarla                   -0.008528               0.008913               0.057129               0.064225</span>
<span class="go">Tygrar                   0.025216              -0.010223               0.048189               0.056404</span>
<span class="go">Jozga                   -0.001792              -0.013118               0.042668               0.059018</span>
</pre></div>
</div>
<p>If you look at the lines for Cylon, the RMS reduced significantly from <code class="docutils literal notranslate"><span class="pre">0.224658</span></code> and
<code class="docutils literal notranslate"><span class="pre">0.221669</span></code> to <code class="docutils literal notranslate"><span class="pre">0.133340</span></code> and <code class="docutils literal notranslate"><span class="pre">0.150636</span></code>, for the East and North components, respectively.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Before you get too excited, be aware though that this is an idealized synthetic
example. In real data, you might see much stronger colored noise, at more stations,
that might be correlated in time and space. Some of it can be taken care of by
removing the common mode error, and some of it with the spatial reweighting presented
here, but don‚Äôt expect it to solve all issues with colored and/or station-individual
noise. This will also all be sensitive to the penalty parameter, the reweighting
function, and much more, which all could potentially make the spatially-aware fit
worse than the local-L0 counterpart.
A more rigorous exploration for the case of different normally-distributed noise
levels is presented in <a class="reference internal" href="tutorial_5.html"><span class="doc">Tutorial 5</span></a>.</p>
</div>
</section>
<section id="finding-unmodeled-jumps">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Finding unmodeled jumps</a><a class="headerlink" href="#finding-unmodeled-jumps" title="Link to this heading">ÔÉÅ</a></h2>
<p>When looking at the errors that we just printed out, we are painfully reminded that
we added an unmodeled maintenance step to the station Corko. Lets‚Äôs use the
<a class="reference internal" href="../disstans/network.html#disstans.network.Network.gui" title="disstans.network.Network.gui"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gui()</span></code></a> function to plot the scalograms and timeseries
fits for the station for the two cases we just used.</p>
<p>For 10 local iterations, we get:</p>
<p><a class="reference internal" href="../_images/tutorial_3c_scalo_Corko_local.png"><img alt="3c_scalo_Corko_local" src="../_images/tutorial_3c_scalo_Corko_local.png" style="width: 49%;" /></a> <a class="reference internal" href="../_images/tutorial_3c_ts_Corko_local.png"><img alt="3c_ts_Corko_local" src="../_images/tutorial_3c_ts_Corko_local.png" style="width: 49%;" /></a></p>
<p>And for the 10 spatial iterations, we get:</p>
<p><a class="reference internal" href="../_images/tutorial_3c_scalo_Corko_spatial10.png"><img alt="3c_scalo_Corko_spatial10" src="../_images/tutorial_3c_scalo_Corko_spatial10.png" style="width: 49%;" /></a> <a class="reference internal" href="../_images/tutorial_3c_ts_Corko_spatial10.png"><img alt="3c_ts_Corko_spatial10" src="../_images/tutorial_3c_ts_Corko_spatial10.png" style="width: 49%;" /></a></p>
<p>Not surprisingly, if we only care about the locally best solution, the solver
will fit the smallest spline as close to the unmodeled jump with a high amplitude.
The result is an overall good fit, with some larger residuals around the time of
the jump (since even the smallest spline is not as short as a day).</p>
<p>If we enforce spatial coherence, the resulting behavior will depend on the strength
of th regularization and reweighting. If it isn‚Äôt too strong, then we get a similar
behavior to the one that we talked about: the smallest spline will be used to fit the
unmodeled jump.</p>
<p>If, however, the reweighting is strong enough such that the other
stations ‚Äúforbid‚Äù the use of the spline closest to the maintenance jump, then Corko
can‚Äôt use it, resulting in large residuals before and after the jump. All other modeled
signals are contorted to try to minimize the rest of the residual. In this case, one
could examine the RMS of the residuals, and immediately see a strong outlier for Corko.
This can be accomplished with the <a class="reference internal" href="../disstans/network.html#disstans.network.Network.analyze_residuals" title="disstans.network.Network.analyze_residuals"><code class="xref py py-meth docutils literal notranslate"><span class="pre">analyze_residuals()</span></code></a>
method, and the <code class="docutils literal notranslate"><span class="pre">rms_on_map</span></code> option for <a class="reference internal" href="../disstans/network.html#disstans.network.Network.gui" title="disstans.network.Network.gui"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gui()</span></code></a>.
Once a user recognizes that a station has a significantly larger residual RMS than
most other stations this, they can check out the timeseries of that station and/or consult
a maintenance dictionary and/or check an earthquake catalog to see if there is a step
signal that should be modeled. Then, a step model can be added to the station, and the
entire network can be fit again, producing an even better fit to the data.</p>
<p>The <a class="reference internal" href="../disstans/processing.html#disstans.processing.StepDetector" title="disstans.processing.StepDetector"><code class="xref py py-class docutils literal notranslate"><span class="pre">StepDetector</span></code></a> class is a simple method to check for
unmodeled jumps in the residuals (see its documentation for more details).
If we use it to find steps in the two residual timeseries, we can skip the manual labor
of clicking through all the stations and looking for jumps, and focus on those that are
identified by the algorithm:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">disstans.processing</span> <span class="kn">import</span> <span class="n">StepDetector</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stepdet</span> <span class="o">=</span> <span class="n">StepDetector</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">51</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">steps_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">res_ts</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Res_L1R10&quot;</span><span class="p">,</span> <span class="s2">&quot;Res_L1R1S10&quot;</span><span class="p">]:</span>
<span class="gp">... </span>    <span class="n">steps_dict</span><span class="p">[</span><span class="n">res_ts</span><span class="p">]</span> <span class="o">=</span> <span class="n">stepdet</span><span class="o">.</span><span class="n">search_network</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">res_ts</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>Which gives:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">res_ts</span><span class="p">,</span> <span class="n">steps</span> <span class="ow">in</span> <span class="n">steps_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Possible steps for </span><span class="si">{</span><span class="n">res_ts</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
<span class="go">Possible steps for Res_L1R10:</span>
<span class="go">  station       time  probability      var0     var1    varred</span>
<span class="go">0   Corko 2005-01-01    34.781766  0.450997  0.21772  0.517246</span>
<span class="go">Possible steps for Res_L1R1S10:</span>
<span class="go">  station       time  probability      var0     var1    varred</span>
<span class="go">0   Corko 2005-01-01    39.701105  0.510695  0.22387  0.561636</span>
</pre></div>
</div>
<p>In this case, both residual timeseries contain a strong enough jump for the detector to
isolate the missing maintenance step on 2005-01-01. In this case, the probability is
higher in the case where we used spatial information, suggesting that the spatial
reweighting has indeed made it harder for the solver to accurately fit the signal
- this is desired since we didn‚Äôt include the correct model for this jump, and we want
to enhance the misfit to be able to better find these unmodeled jumps.</p>
<p>For the remainder of this tutorial, let‚Äôs add the maintenance step at Corko as a model,
and rerun the local and spatial L0 fits.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">new_maint_mdl</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Maintenance&quot;</span><span class="p">:</span> <span class="n">Step</span><span class="p">([</span><span class="s2">&quot;2005-01-01&quot;</span><span class="p">])}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mdl_coll</span><span class="p">[</span><span class="s2">&quot;Corko&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_maint_mdl</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="p">[</span><span class="s2">&quot;Corko&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_local_model_dict</span><span class="p">(</span><span class="s2">&quot;Displacement&quot;</span><span class="p">,</span> <span class="n">new_maint_mdl</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># run net.fitevalres and/or net.spatialfit now just as above</span>
</pre></div>
</div>
</section>
<section id="statistics-of-spatial-reweighting">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Statistics of spatial reweighting</a><a class="headerlink" href="#statistics-of-spatial-reweighting" title="Link to this heading">ÔÉÅ</a></h2>
<p>Let‚Äôs have a look at the statistics saved by ourselves as well as those returned
by <a class="reference internal" href="../disstans/network.html#disstans.network.Network.spatialfit" title="disstans.network.Network.spatialfit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">spatialfit()</span></code></a> into the <code class="docutils literal notranslate"><span class="pre">stats</span></code> dictionary.
The first three variables contain the key numbers we used before to show how
the spatial reweighting not only reduces the total number of splines used, but
also the number of <em>unique</em> splines used across the network.
The second three capture the extent to which the parameters change between
the iterations.</p>
<p>Let‚Äôs make two figures that show how they evolve and converge:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># first figure is for num_total, arr_uniques, list_nonzeros</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;list_nonzeros&quot;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">num_nonzero_base_M</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">num_nonzero_local_M</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3500</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;arr_uniques&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;arr_uniques&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">num_uniques_base_M</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">num_uniques_local_M</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">num_uniques_base_M</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">num_uniques_local_M</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">350</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;symlog&quot;</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">13</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Total number of non-zero parameters&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Unique number of non-zero parameters&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">custom_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,),</span>
<span class="gp">... </span>                <span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;0.7&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;0.7&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;0.7&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of available parameters: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;num_total&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">custom_lines</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Total&quot;</span><span class="p">,</span> <span class="s2">&quot;Unique East&quot;</span><span class="p">,</span> <span class="s2">&quot;Unique North&quot;</span><span class="p">,</span>
<span class="gp">... </span>                          <span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;Local L0&quot;</span><span class="p">,</span> <span class="s2">&quot;Spatial L0&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">0.56</span><span class="p">,</span> <span class="mf">0.53</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outdir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;tutorial_3e_numparams.</span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># second figure is for dict_rms_diff, dict_num_changed</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;dict_rms_diff&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;dict_num_changed&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;symlog&quot;</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;symlog&quot;</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">13</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;RMS difference of parameters&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Number of changed parameters&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">custom_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">custom_lines</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;RMS Difference&quot;</span><span class="p">,</span> <span class="s2">&quot;Changed Parameters&quot;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outdir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;tutorial_3e_diffs.</span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
<p>The first figure shows that by the 2nd or 3rd iteration, both the total number of
parameters as well as the unique ones in both components have converged.</p>
<img alt="../_images/tutorial_3e_numparams.png" src="../_images/tutorial_3e_numparams.png" />
<p>The second figure shows that around the same time, the RMS difference of fitted
parameters and the number of parameters changing between each iteration is in free fall.
At 5 iterations, no parameters actually change between being close-to-zero or non-zero,
anymore, they just change their values slightly.
This shows that the spatial reweighting scheme employed by DISSTANS converges nicely
and fulfills the goal of reducing the number of unique splines used by the entire network.</p>
<img alt="../_images/tutorial_3e_diffs.png" src="../_images/tutorial_3e_diffs.png" />
<p>Now, let‚Äôs pick up on the correlation matrices saved throughout this tutorial
without explaining you why:
<code class="docutils literal notranslate"><span class="pre">cor_base,</span> <span class="pre">cor_localiters,</span> <span class="pre">cor_spatialiters1,</span> <span class="pre">cor_spatialiters10</span></code>. What are they?
For the North component, we computed the correlation coefficients (between -1 and 1)
of the modeled signal (timeseries) from only the transient <a class="reference internal" href="../disstans/models.html#disstans.models.SplineSet" title="disstans.models.SplineSet"><code class="xref py py-class docutils literal notranslate"><span class="pre">SplineSet</span></code></a>
model between station. This means that the more similar the fitted transients are in shape
(the total amplitude does not influence the correlation coefficient), i.e. in timing and
phases of the transients, the higher the coefficients will be.</p>
<p>We can use these matrices now to plot the (symmetric) correlation matrices for the two
main cases we considered above, and also to compute the median spatial correlation.
If we successfully fitted our synthetic transients, which we know are the same
everywhere, we should see that the median correlation increases when using the
spatial reweighting. Here‚Äôs some example code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">cormat</span> <span class="ow">in</span> \
<span class="gp">... </span>    <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;10 Local Reweightings&quot;</span><span class="p">,</span> <span class="s2">&quot;1 Local, 10 Spatial Reweighting&quot;</span><span class="p">],</span>
<span class="gp">... </span>        <span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;spatial10&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">cor_localiters</span><span class="p">,</span> <span class="n">cor_spatialiters10</span><span class="p">]):</span>
<span class="gp">... </span>    <span class="c1"># median spatial correlation of transient timeseries</span>
<span class="gp">... </span>    <span class="n">medcor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">cormat</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Median spatial correlation = </span><span class="si">{</span><span class="n">medcor</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="c1"># spatial correlation visualization</span>
<span class="gp">... </span>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cormat</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">num_stations</span><span class="p">),</span>
<span class="gp">... </span>               <span class="n">labels</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">stations</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="gp">... </span>    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
<span class="gp">... </span>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tutorial_3f_corr_</span><span class="si">{</span><span class="n">case</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>In fact, our median spatial correlation increased from <code class="docutils literal notranslate"><span class="pre">0.8967353828180022</span></code>
to <code class="docutils literal notranslate"><span class="pre">0.9983963350087219</span></code>. We can see this visually in the plots we just saved:</p>
<p><a class="reference internal" href="../_images/tutorial_3f_corr_localM.png"><img alt="3f_corr_local" src="../_images/tutorial_3f_corr_localM.png" style="width: 49%;" /></a> <a class="reference internal" href="../_images/tutorial_3f_corr_spatial10M.png"><img alt="3f_corr_spatial10" src="../_images/tutorial_3f_corr_spatial10M.png" style="width: 49%;" /></a></p>
<p>We can see that especially in the far-east stations, where the signal has fallen close
to or below the noise level, the spatial reweighting has greatly increased the spatial
correlation. (Keep in mind that this is just for the transient model: the overall
timeseries will obviously correlate much less because of the different SSEs, maintenance
steps, etc.)</p>
<p>This did not come with a meaningfully different residuals. If we use
<a class="reference internal" href="../disstans/network.html#disstans.network.Network.analyze_residuals" title="disstans.network.Network.analyze_residuals"><code class="xref py py-meth docutils literal notranslate"><span class="pre">analyze_residuals()</span></code></a>, we can see that the mean of the
residuals‚Äô RMS in the East and North components only changed from <code class="docutils literal notranslate"><span class="pre">0.578228</span></code> and
<code class="docutils literal notranslate"><span class="pre">0.713567</span></code> to <code class="docutils literal notranslate"><span class="pre">0.584478</span></code> and <code class="docutils literal notranslate"><span class="pre">0.719376</span></code>, respectively.
Also, keep in mind that something we‚Äôre fitting less now is the non-spatially-coherent
colored noise; by principle, our <em>residuals</em> could be slightly larger, in the hopes
that our <em>errors</em> are smaller.</p>
<p>In fact, we can see this when printing the mean RMS error of the entire network
(keep in mind that we did add the maintenance step at Corko):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">err_ts</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Errors for </span><span class="si">{</span><span class="n">err_ts</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="go">Errors for Err_L1R10M:</span>
<span class="go">Metrics  Components</span>
<span class="go">Mean     Displacement_Model_E-E   -0.005059</span>
<span class="go">         Displacement_Model_N-N   -0.001399</span>
<span class="go">RMS      Displacement_Model_E-E    0.095132</span>
<span class="go">         Displacement_Model_N-N    0.106806</span>
<span class="go">dtype: float64</span>

<span class="go">Errors for Err_L1R1S10M:</span>
<span class="go">Metrics  Components</span>
<span class="go">Mean     Displacement_Model_E-E   -0.005029</span>
<span class="go">         Displacement_Model_N-N   -0.001367</span>
<span class="go">RMS      Displacement_Model_E-E    0.055523</span>
<span class="go">         Displacement_Model_N-N    0.066682</span>
<span class="go">dtype: float64</span>
</pre></div>
</div>
</section>
<section id="model-parameter-correlations">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Model parameter correlations</a><a class="headerlink" href="#model-parameter-correlations" title="Link to this heading">ÔÉÅ</a></h2>
<p>While a more detailed exploration of the parameter correlations is left to the next tutorial,
let‚Äôs have a quick look at the correlation matrices at station Jeckle.
The following code will produce the annotated correlation plot using the
<a class="reference internal" href="../disstans/models.html#disstans.models.ModelCollection.plot_covariance" title="disstans.models.ModelCollection.plot_covariance"><code class="xref py py-meth docutils literal notranslate"><span class="pre">plot_covariance()</span></code></a> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="p">[</span><span class="s2">&quot;Jeckle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot_covariance</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;tutorial_3g_Jeckle_corr_sparse, use_corr_coef=True)</span>
</pre></div>
</div>
<p>Which yields the following figure:</p>
<img alt="../_images/tutorial_3g_Jeckle_corr_sparse.png" src="../_images/tutorial_3g_Jeckle_corr_sparse.png" />
<p>The first impression is that of extreme sparsity: very few rows and columns actually have
colors diverging from zero. If the user doesn‚Äôt provide the <code class="docutils literal notranslate"><span class="pre">fname</span></code> keyword, the function
will show the interactive plot window, where one can zoom in. However, using the
<code class="docutils literal notranslate"><span class="pre">plot_empty</span></code> keyword allows for a more compact representation, where the empty parameters
are omitted, yielding the following plot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="p">[</span><span class="s2">&quot;Jeckle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot_covariance</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;tutorial_3g_Jeckle_corr_dense,</span>
<span class="gp">... </span>    <span class="n">plot_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_corr_coef</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/tutorial_3g_Jeckle_corr_dense.png" src="../_images/tutorial_3g_Jeckle_corr_dense.png" />
<p>One can now see the strong correlation between the transient splines, but also between the
splines and the other models.</p>
</section>
<section id="transient-visualization-with-worm-plots">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Transient visualization with worm plots</a><a class="headerlink" href="#transient-visualization-with-worm-plots" title="Link to this heading">ÔÉÅ</a></h2>
<p>The reason we saved the transient model fits as separate timeseries
(e.g. <code class="docutils literal notranslate"><span class="pre">'Trans_L1R1S10'</span></code>) is because we will make use of the
<a class="reference internal" href="../disstans/network.html#disstans.network.Network.wormplot" title="disstans.network.Network.wormplot"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wormplot()</span></code></a> method to show the motion of the different
stations across the network. Compared to a static map of instantaneous (or time-integrated)
velocity arrows, a wormplot is able to show no only the total accumulated displacement
over a timespan, but also its evolution, and highlighting periods of fast motion.</p>
<p>For each transient timeseries that we saved, we can produce a wormplot like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">case</span><span class="p">,</span> <span class="n">trans_ts</span> <span class="ow">in</span> \
<span class="gp">... </span>    <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;spatial10&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;Trans_L1R10&quot;</span><span class="p">,</span> <span class="s2">&quot;Trans_L1R1S10&quot;</span><span class="p">]):</span>
<span class="gp">... </span>    <span class="n">net</span><span class="o">.</span><span class="n">wormplot</span><span class="p">(</span><span class="n">ts_description</span><span class="o">=</span><span class="n">trans_ts</span><span class="p">,</span>
<span class="gp">... </span>                 <span class="n">fname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tutorial_3h_worm_</span><span class="si">{</span><span class="n">case</span><span class="si">}</span><span class="s2">,</span>
<span class="gp">... </span>                 <span class="n">colorbar_kw_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
<span class="gp">... </span>                 <span class="n">scale</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">annotate_stations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="gp">... </span>                 <span class="n">lon_min</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">lon_max</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">lat_min</span><span class="o">=-</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">lat_max</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>Which yields the following two maps:</p>
<p><a class="reference internal" href="../_images/tutorial_3h_worm_localM.png"><img alt="3h_worm_local" src="../_images/tutorial_3h_worm_localM.png" style="width: 49%;" /></a> <a class="reference internal" href="../_images/tutorial_3h_worm_spatial10M.png"><img alt="3h_worm_spatial10" src="../_images/tutorial_3h_worm_spatial10M.png" style="width: 49%;" /></a></p>
<p>We can also calculate the difference between the two transients:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">math</span><span class="p">(</span><span class="s2">&quot;diff-local-spatial&quot;</span><span class="p">,</span> <span class="s2">&quot;Trans_L1R10M&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;Trans_L1R1S10M&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="o">.</span><span class="n">wormplot</span><span class="p">(</span><span class="n">ts_description</span><span class="o">=</span><span class="s2">&quot;diff-local-spatial&quot;</span><span class="p">,</span>
<span class="gp">... </span>             <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;tutorial_3h_worm_diff&quot;</span><span class="p">,</span>
<span class="gp">... </span>             <span class="n">colorbar_kw_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
<span class="gp">... </span>             <span class="n">scale</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">annotate_stations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="gp">... </span>             <span class="n">lon_min</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">lon_max</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">lat_min</span><span class="o">=-</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">lat_max</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>Which maps out to:</p>
<img alt="../_images/tutorial_3h_worm_diff.png" src="../_images/tutorial_3h_worm_diff.png" />
<p>We can see that in general, the transients that were estimated through the spatial
L0 estimation process show a more homogenous direction of the motion to the southeast,
which we know to be the true direction of motion. This is also visible in
the far east of the network, where the signal is close or below the noise floor.</p>
</section>
<section id="secular-velocity-comparisons">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">Secular velocity comparisons</a><a class="headerlink" href="#secular-velocity-comparisons" title="Link to this heading">ÔÉÅ</a></h2>
<p>To highlight the importance of modeling transients explicitly, we are now going to look
at the estimated linear (secular) velocity that every station experiences. That velocity
is stored in the following parameter in our network (for station Jeckle, e.g.):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">net</span><span class="p">[</span><span class="s2">&quot;Jeckle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Secular&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
</pre></div>
</div>
<p>So, for all station velocities for our latest spatially-aware fit, we could use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">vels_spatl0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">stat</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Secular&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="gp">... </span>                        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">net</span><span class="p">])</span>
</pre></div>
</div>
<p>Keep in mind that whenever we perform the fitting process, old parameter estimates
get thrown away, so to compare the current estimate from our spatially-aware fit with
the non-spatially-aware one, we have to save these estimates along the way (see script
file). For our comparisons with other approaches that do not explicitly model the
transient episodes, we will therefore simply create new network objects with the same
stations, but different models. We will compare our results with the following alternatives:</p>
<ol class="arabic simple">
<li><p>An unregularized least-squares result without any knowledge of the transients,</p></li>
<li><p>an unregularized least-squares result approximating the transients with step functions,</p></li>
<li><p>and results using the MIDAS (<a class="reference internal" href="../disstans/processing.html#blewitt16" id="id3"><span>[blewitt16]</span></a>) algorithm (included in DISSTANS).</p></li>
</ol>
<p>Note that we don‚Äôt actually need an extra network object for the last approach, since
it only operates on the timeseries data directly. For the other ones, we can create
copies using the standard Python approach:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># make an almost-from-scratch network object for comparisons</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net_basic</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># delete all unnecessary timeseries and the Transient model</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">net_basic</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">stat</span><span class="o">.</span><span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="gp">... </span>               <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="s2">&quot;Displacement&quot;</span><span class="p">]:</span>
<span class="gp">... </span>        <span class="k">del</span> <span class="n">stat</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span>
<span class="gp">... </span>    <span class="k">del</span> <span class="n">stat</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span>
<span class="gp">... </span>    <span class="k">del</span> <span class="n">stat</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Transient&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># we&#39;ll compare our spatial-L0 results to a model with steps instead of transients</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net_steps</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">net_basic</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># add true center times as steps (reality is going to be worse)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">net_steps</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">stat</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;SSESteps&quot;</span><span class="p">]</span> <span class="o">=</span> \
<span class="gp">... </span>        <span class="n">Step</span><span class="p">([</span><span class="s2">&quot;2001-07-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2003-07-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2007-01-01&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>Next, we will fit both networks, and save the velocities:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># fit both the basic network and the one with added steps</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net_basic</span><span class="o">.</span><span class="n">fitevalres</span><span class="p">(</span><span class="n">ts_description</span><span class="o">=</span><span class="s2">&quot;Displacement&quot;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;linear_regression&quot;</span><span class="p">,</span>
<span class="gp">... </span>                     <span class="n">output_description</span><span class="o">=</span><span class="s2">&quot;Fit&quot;</span><span class="p">,</span> <span class="n">residual_description</span><span class="o">=</span><span class="s2">&quot;Res&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">net_steps</span><span class="o">.</span><span class="n">fitevalres</span><span class="p">(</span><span class="n">ts_description</span><span class="o">=</span><span class="s2">&quot;Displacement&quot;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;linear_regression&quot;</span><span class="p">,</span>
<span class="gp">... </span>                     <span class="n">output_description</span><span class="o">=</span><span class="s2">&quot;Fit&quot;</span><span class="p">,</span> <span class="n">residual_description</span><span class="o">=</span><span class="s2">&quot;Res&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># extract velocities</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">vels_basic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">stat</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Secular&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="gp">... </span>                       <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">net_basic</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">vels_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">stat</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">][</span><span class="s2">&quot;Secular&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="gp">... </span>                       <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">net_steps</span><span class="p">])</span>
</pre></div>
</div>
<p>The MIDAS algorithm is next. Even though our network is small, let‚Äôs pretend it‚Äôs big
enough to warrant parallelization. The <a class="reference internal" href="../disstans/processing.html#disstans.processing.midas" title="disstans.processing.midas"><code class="xref py py-func docutils literal notranslate"><span class="pre">midas()</span></code></a> function
only needs the <a class="reference internal" href="../disstans/timeseries.html#disstans.timeseries.Timeseries" title="disstans.timeseries.Timeseries"><code class="xref py py-class docutils literal notranslate"><span class="pre">Timeseries</span></code></a> objects as input, so a
parallelized call using <a class="reference internal" href="../disstans/tools.html#disstans.tools.parallelize" title="disstans.tools.parallelize"><code class="xref py py-func docutils literal notranslate"><span class="pre">parallelize()</span></code></a> would look like this:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">disstans.tools</span> <span class="kn">import</span> <span class="n">parallelize</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">disstans.processing</span> <span class="kn">import</span> <span class="n">midas</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">midas_in</span> <span class="o">=</span> <span class="p">[</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">net</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">midas_out</span> <span class="o">=</span> <span class="p">{</span><span class="n">sta_name</span><span class="p">:</span> <span class="n">result</span> <span class="k">for</span> <span class="n">sta_name</span><span class="p">,</span> <span class="n">result</span>
<span class="gp">... </span>             <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">station_names</span><span class="p">,</span> <span class="n">parallelize</span><span class="p">(</span><span class="n">midas</span><span class="p">,</span> <span class="n">midas_in</span><span class="p">))}</span>
</pre></div>
</div>
<p>We now need to parse the outputs from <code class="docutils literal notranslate"><span class="pre">midas_out</span></code> to extract the velocity using
DISSTANS‚Äô <a class="reference internal" href="../disstans/models.html#disstans.models.Model.evaluate" title="disstans.models.Model.evaluate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">evaluate()</span></code></a> method:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mdls_midas</span> <span class="o">=</span> <span class="p">{</span><span class="n">sta_name</span><span class="p">:</span> <span class="n">m_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">sta_name</span><span class="p">,</span> <span class="n">m_out</span> <span class="ow">in</span> <span class="n">midas_out</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">vels_midas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">mdl</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">mdl</span> <span class="ow">in</span> <span class="n">mdls_midas</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
</pre></div>
</div>
<p>The true velocities to which we‚Äôll compare all of the estimated velocities were defined
by us in the very beginning:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">vels_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">mdl</span><span class="p">[</span><span class="s2">&quot;Secular&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="gp">... </span>                      <span class="k">for</span> <span class="n">mdl</span> <span class="ow">in</span> <span class="n">mdl_coll_synth</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
</pre></div>
</div>
<p>So, we can calculate all the root-mean-squared errors of our velocity estimate as
follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># get RMSE stats</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rmse_spatl0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">vels_spatl0</span> <span class="o">-</span> <span class="n">vels_true</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rmse_locl0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">vels_locl0</span> <span class="o">-</span> <span class="n">vels_true</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rmse_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">vels_steps</span> <span class="o">-</span> <span class="n">vels_true</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rmse_basic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">vels_basic</span> <span class="o">-</span> <span class="n">vels_true</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rmse_midas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">vels_midas</span> <span class="o">-</span> <span class="n">vels_true</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">vel_rmses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Spatial L0&quot;</span><span class="p">:</span> <span class="n">rmse_spatl0</span><span class="p">,</span> <span class="s2">&quot;Local L0&quot;</span><span class="p">:</span> <span class="n">rmse_locl0</span><span class="p">,</span>
<span class="gp">... </span>                          <span class="s2">&quot;Linear + Steps&quot;</span><span class="p">:</span> <span class="n">rmse_steps</span><span class="p">,</span> <span class="s2">&quot;Linear&quot;</span><span class="p">:</span> <span class="n">rmse_basic</span><span class="p">,</span>
<span class="gp">... </span>                          <span class="s2">&quot;MIDAS&quot;</span><span class="p">:</span> <span class="n">rmse_midas</span><span class="p">},</span>
<span class="gp">... </span>                         <span class="n">index</span><span class="o">=</span><span class="n">sta</span><span class="p">[</span><span class="s2">&quot;Displacement&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_cols</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># print</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">vel_rmses</span><span class="p">)</span>
<span class="go">                       E         N</span>
<span class="go">Spatial L0      0.059826  0.086406</span>
<span class="go">Local L0        0.523801  0.748883</span>
<span class="go">Linear + Steps  0.623014  0.605845</span>
<span class="go">Linear          1.275072  1.272709</span>
<span class="go">MIDAS           0.854414  0.871200</span>
</pre></div>
</div>
<p>(Note that these results were calculated after the added maintenance steps, and require
that the velocity results from the solution before adding spatial awareness were saved
into <code class="docutils literal notranslate"><span class="pre">vels_locl0</span></code>.)</p>
<p>We can see that quantitatively, the spatially-aware, L0-regularized fits significantly
outerperforms the other estimates. Visually, for the two components at station Jeckle,
we can see this improvement:</p>
<img alt="../_images/tutorial_3j_seccomp_Jeckle_E.png" src="../_images/tutorial_3j_seccomp_Jeckle_E.png" />
<img alt="../_images/tutorial_3j_seccomp_Jeckle_N.png" src="../_images/tutorial_3j_seccomp_Jeckle_N.png" />
<p>Here, the different colored lines correspond to the purely linear components of the fitted
timeseries. The true linear constituent, together with the synthetic noise, is shown as the
dark grey points. The light grey points additionally include the true transient constituent.
A clear progression from the purely linear model that is trying to capture the transient
episodes to our spatially-regularized model explicitly including the transients as to not be
affected by them is clearly visible.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that the spatially-regularized solution is still not capturing the true secular
velocity. This is due to the inherent tradeoff between longterm transients and the
linear, secular velocity, as well as the presence of noise. We could easily make
our method recover the true solution by either reducing the number and maximum
timespan of the transient episodes, and/or lowering the noise level. We have chosen
the current model and noise hyperparameters to show exactly this tradeoff, and to
remind the user that this tradeoff would only be worse in real data.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tutorial_2.html" class="btn btn-neutral float-left" title="Tutorial 2: Advanced Models and Fitting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tutorial_4.html" class="btn btn-neutral float-right" title="Tutorial 4: The use and estimation of covariance" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Tobias K√∂hne.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>